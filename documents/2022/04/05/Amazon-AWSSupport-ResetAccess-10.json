{
  "AttachmentsContent": [],
  "Content": "{\n  \"schemaVersion\": \"0.3\",\n  \"description\": \"This document will use the EC2Rescue tool on the specified EC2 instance to re-enable password decryption via the EC2 Console (Windows), or to generate and add a new SSH key pair (Linux). If you lost your key pair, this automation will create a password-enabled AMI that you can use to launch a new EC2 instance with a key pair you own (Windows).\",\n  \"assumeRole\": \"{{ AssumeRole }}\",\n  \"parameters\": {\n    \"InstanceId\": {\n      \"type\": \"String\",\n      \"description\": \"(Required) ID of the EC2 instance you want to reset access for. IMPORTANT: AWS Systems Manager Automation stops this instance, and creates an AMI before attempting any operations. Data stored in instance store volumes will be lost. The public IP address will change if you are not using an Elastic IP.\",\n      \"allowedPattern\": \"^[m]{0,1}i-[a-z0-9]{8,17}$\"\n    },\n    \"EC2RescueInstanceType\": {\n      \"type\": \"String\",\n      \"description\": \"(Required) The EC2 instance type for the EC2Rescue instance. Recommended size: t2.small.\",\n      \"default\": \"t2.small\",\n      \"allowedValues\": [\n        \"t2.small\",\n        \"t2.medium\",\n        \"t2.large\"\n      ]\n    },\n    \"SubnetId\": {\n      \"type\": \"String\",\n      \"description\": \"(Optional) The subnet ID for the EC2Rescue instance. By default, AWS Systems Manager Automation creates a new VPC. Alternatively, Use SelectedInstanceSubnet to use the same subnet as your instance, or specify a custom subnet ID. IMPORTANT: The subnet must be in the same Availability Zone as InstanceId, and it must allow access to the SSM endpoints.\",\n      \"default\": \"CreateNewVPC\",\n      \"allowedPattern\": \"^SelectedInstanceSubnet$|^CreateNewVPC$|^subnet-[a-z0-9]{8,17}$\"\n    },\n    \"AssumeRole\": {\n      \"type\": \"String\",\n      \"description\": \"(Optional) The IAM role for this execution. If no role is specified, AWS Systems Manager Automation will use the permissions of the user that executes this document.\",\n      \"default\": \"\"\n    }\n  },\n  \"mainSteps\": [\n    {\n      \"name\": \"assertInstanceIsWindows\",\n      \"action\": \"aws:assertAwsResourceProperty\",\n      \"onFailure\": \"step:runEC2RescueForLinux\",\n      \"inputs\": {\n        \"Service\": \"ec2\",\n        \"Api\": \"DescribeInstances\",\n        \"InstanceIds\": [\n          \"{{ InstanceId }}\"\n        ],\n        \"PropertySelector\": \"$.Reservations[0].Instances[0].Platform\",\n        \"DesiredValues\": [\n          \"windows\"\n        ]\n      },\n      \"isCritical\": \"false\",\n      \"nextStep\": \"runEC2RescueForWindows\"\n    },\n    {\n      \"name\": \"runEC2RescueForWindows\",\n      \"onFailure\": \"Continue\",\n      \"action\": \"aws:executeAutomation\",\n      \"inputs\": {\n        \"RuntimeParameters\": {\n          \"InstanceId\": [\n            \"{{ InstanceId }}\"\n          ],\n          \"OfflineScript\": [\n            \"SW1wb3J0LU1vZHVsZSBFQzJSZXNjdWUKSW52b2tlLUVDMlJlc2N1ZUVuYWJsZVBhc3N3b3JkR2VuZXJhdGlvbiAtQmxvY2tEZXZpY2VOYW1lICR7ZW52OkVDMlJFU0NVRV9PRkZMSU5FX0VCU19ERVZJQ0V9\"\n          ],\n          \"SubnetId\": [\n            \"{{ SubnetId }}\"\n          ],\n          \"CreatePreEC2RescueBackup\": [\n            \"True\"\n          ],\n          \"CreatePostEC2RescueBackup\": [\n            \"True\"\n          ],\n          \"UniqueId\": \"{{ automation:EXECUTION_ID }}\"\n        },\n        \"DocumentName\": \"AWSSupport-StartEC2RescueWorkflow\"\n      },\n      \"isCritical\": \"true\",\n      \"nextStep\": \"getWindowsBackupAmi\"\n    },\n    {\n      \"name\": \"getWindowsBackupAmi\",\n      \"action\": \"aws:executeAwsApi\",\n      \"onFailure\": \"Continue\",\n      \"inputs\": {\n        \"Service\": \"ssm\",\n        \"Api\": \"GetAutomationExecution\",\n        \"AutomationExecutionId\": \"{{ runEC2RescueForWindows.ExecutionId }}\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"ImageId\",\n          \"Selector\": \"$.AutomationExecution.Outputs.'preScriptBackup.ImageId'[0]\",\n          \"Type\": \"String\"\n        }\n      ],\n      \"isCritical\": \"false\",\n      \"nextStep\": \"getWindowsPasswordEnabledAmi\"\n    },\n    {\n      \"name\": \"getWindowsPasswordEnabledAmi\",\n      \"action\": \"aws:executeAwsApi\",\n      \"onFailure\": \"Continue\",\n      \"inputs\": {\n        \"Service\": \"ssm\",\n        \"Api\": \"GetAutomationExecution\",\n        \"AutomationExecutionId\": \"{{ runEC2RescueForWindows.ExecutionId }}\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"ImageId\",\n          \"Selector\": \"$.AutomationExecution.Outputs.'postScriptBackup.ImageId'[0]\",\n          \"Type\": \"String\"\n        }\n      ],\n      \"isCritical\": \"false\",\n      \"nextStep\": \"getEC2RescueForWindowsResult\"\n    },\n    {\n      \"name\": \"getEC2RescueForWindowsResult\",\n      \"action\": \"aws:executeAwsApi\",\n      \"onFailure\": \"Abort\",\n      \"inputs\": {\n        \"Service\": \"ssm\",\n        \"Api\": \"GetAutomationExecution\",\n        \"AutomationExecutionId\": \"{{ runEC2RescueForWindows.ExecutionId }}\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"Output\",\n          \"Selector\": \"$.AutomationExecution.Outputs.'runScriptForWindows.Output'[0]\",\n          \"Type\": \"String\"\n        }\n      ],\n      \"isCritical\": \"false\",\n      \"isEnd\": \"true\"\n    },\n    {\n      \"name\": \"runEC2RescueForLinux\",\n      \"onFailure\": \"Continue\",\n      \"action\": \"aws:executeAutomation\",\n      \"inputs\": {\n        \"RuntimeParameters\": {\n          \"InstanceId\": [\n            \"{{ InstanceId }}\"\n          ],\n          \"OfflineScript\": [\n            \"ZXJyb3JfdHJhcCgpCnsKICAgIGlmIHRlc3QgLW4gIiQxIiA7IHRoZW4KICAgICAgICBwcmludGYgIiVzXFxuIiAiJDEiCiAgICBmaQogICAgcHJpbnRmICIlLnM9IiAkKHNlcSAxIDgwKQogICAgcHJpbnRmICJcXG5UaGUgRUMyUmVzY3VlIGV4ZWN1dGlvbiBkaWQgbm90IGNvbXBsZXRlIHN1Y2Nlc3NmdWxseS5cXG4iCiAgICBleGl0IDEKfQoKcHJpbnRmICJHZW5lcmF0aW5nIG5ldyBrZXkgcGFpclxcbiIKCk5FV19QVUJMSUNfS0VZPSIkKCR7RUMyUkVTQ1VFX1BZVEhPTn0gLWMgIgojIFRoaXMgUHl0aG9uIHNuaXBwZXQgaXMgZnJvbSB0aGUgRUMyIFJlc2N1ZSBmb3IgTGludXggb3BlbnNzaCBtb2R1bGUKZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCBwcmludF9mdW5jdGlvbgppbXBvcnQgb3MKaW1wb3J0IHNobGV4CmltcG9ydCBzdWJwcm9jZXNzCmltcG9ydCBzeXMKCnN5cy5wYXRoLmluc2VydCgwLCBvcy5wYXRoLmpvaW4ob3MuZW52aXJvblsnRUMyUkVTQ1VFX0VDMlJMX0RJUiddLCAnbGliJykpCgppbXBvcnQgcmVxdWVzdHMKaW1wb3J0IGJvdG8zCmltcG9ydCBib3RvY29yZQoKCmRlZiBnZW5lcmF0ZV9yc2Ffa2V5X3BhaXIoa2V5X3BhdGgpOgogICAgdHJ5OgogICAgICAgIGtleV9wYXRoID0gb3MucGF0aC5qb2luKGtleV9wYXRoLCAnZWMycmxfb3BlbnNzaHJlc2V0YWNjZXNzJykKICAgICAgICBrZXlzX2RpY3QgPSB7J3ByaXZhdGUnOiBOb25lLCAncHVibGljJzogTm9uZX0KICAgICAgICBzdWJwcm9jZXNzLmNoZWNrX2NhbGwoCiAgICAgICAgICAgIHNobGV4LnNwbGl0KCdzc2gta2V5Z2VuIC1xIC10IHJzYSAtYiA0MDk2IC1mIHt9IC1OIFwnXCcgLUMgXCdBZGRlZCBieSBFQzIgUmVzY3VlIGZvciBMaW51eFwnJy5mb3JtYXQoCiAgICAgICAgICAgICAgICBrZXlfcGF0aCkpLAogICAgICAgICAgICBzdGRlcnI9c3VicHJvY2Vzcy5TVERPVVQpCgogICAgICAgIHdpdGggb3Blbigne30ucHViJy5mb3JtYXQoa2V5X3BhdGgpLCAncicpIGFzIHB1Yl9mcDoKICAgICAgICAgICAga2V5c19kaWN0WydwdWJsaWMnXSA9IHB1Yl9mcC5yZWFkKCkKICAgICAgICB3aXRoIG9wZW4oa2V5X3BhdGgsICdyJykgYXMgcHJpdl9mcDoKICAgICAgICAgICAga2V5c19kaWN0Wydwcml2YXRlJ10gPSBwcml2X2ZwLnJlYWQoKQogICAgICAgIHJldHVybiBrZXlzX2RpY3QKICAgIGZpbmFsbHk6CiAgICAgICAgIyBBbHdheXMgcmVtb3ZlIHRoZSBrZXkgZmlsZXMgZXZlbiBpbiB0aGUgZXZlbnQgb2YgYW4gZXhjZXB0aW9uIGJlaW5nIHJhaXNlZAogICAgICAgICMgSXQgaXMgcG9zc2libGUgdGhhdCBhbiBleGNlcHRpb24gaXMgcmFpc2VkIGJlZm9yZSB0aGUga2V5IGZpbGVzIGFyZSBjcmVhdGVkIHNvIGNhdGNoIHRob3NlIGV4Y2VwdGlvbnMKICAgICAgICAjIElPRXJyb3IvUHl0aG9uIDIsIE9TRXJyb3IvUHl0aG9uIDMgKEZpbGVOb3RGb3VuZEVycm9yLCBldGMpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBvcy5yZW1vdmUoa2V5X3BhdGgpCiAgICAgICAgZXhjZXB0IChPU0Vycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgcGFzcwogICAgICAgIHRyeToKICAgICAgICAgICAgb3MucmVtb3ZlKCd7fS5wdWInLmZvcm1hdChrZXlfcGF0aCkpCiAgICAgICAgZXhjZXB0IChPU0Vycm9yLCBJT0Vycm9yKToKICAgICAgICAgICAgcGFzcwoKCmRlZiBydW4oKToKICAgIGtleXMgPSBnZW5lcmF0ZV9yc2Ffa2V5X3BhaXIoJy9yb290JykKICAgIG5ld19wdWJsaWNfa2V5ID0ga2V5c1sncHVibGljJ10KICAgIGluc3RhbmNlX2lkID0gb3MuZW52aXJvblsnRUMyUkVTQ1VFX1NPVVJDRV9JTlNUQU5DRSddCiAgICB0cnk6CiAgICAgICAgcmVzcCA9IHJlcXVlc3RzLmdldCgnaHR0cDovLzE2OS4yNTQuMTY5LjI1NC9sYXRlc3QvbWV0YS1kYXRhL3BsYWNlbWVudC9hdmFpbGFiaWxpdHktem9uZScpCiAgICAgICAgcmVzcC5yYWlzZV9mb3Jfc3RhdHVzKCkKICAgICAgICBpbnN0YW5jZV9yZWdpb24gPSByZXNwLnRleHRbOi0xXQogICAgZXhjZXB0IHJlcXVlc3RzLmV4Y2VwdGlvbnMuUmVxdWVzdEV4Y2VwdGlvbiBhcyByZToKICAgICAgICBwcmludChyZSkKICAgICAgICByZXR1cm4gMQoKICAgIHRyeToKICAgICAgICBjbGllbnQgPSBib3RvMy5jbGllbnQoJ3NzbScsIHJlZ2lvbl9uYW1lPWluc3RhbmNlX3JlZ2lvbikKICAgICAgICBwYXJhbWV0ZXJfZGljdCA9IHsKICAgICAgICAgICAgJ05hbWUnOiAnL2VjMnJsL29wZW5zc2gve30va2V5Jy5mb3JtYXQoaW5zdGFuY2VfaWQpLAogICAgICAgICAgICAnRGVzY3JpcHRpb24nOiAnUHJpdmF0ZSBrZXkgYWRkZWQgdG8gaW5zdGFuY2Uge30gYnkgRUMyIFJlc2N1ZSBmb3IgTGludXguJy5mb3JtYXQoaW5zdGFuY2VfaWQpLAogICAgICAgICAgICAnVmFsdWUnOiBrZXlzWydwcml2YXRlJ10sCiAgICAgICAgICAgICdUeXBlJzogJ1NlY3VyZVN0cmluZycsCiAgICAgICAgICAgICdPdmVyd3JpdGUnOiBUcnVlCiAgICAgICAgfQogICAgICAgIGNsaWVudC5wdXRfcGFyYW1ldGVyKCoqcGFyYW1ldGVyX2RpY3QpCiAgICBleGNlcHQgYm90b2NvcmUuZXhjZXB0aW9ucy5Ob0NyZWRlbnRpYWxzRXJyb3I6CiAgICAgICAgcHJpbnQoJ05vIEFXUyBDcmVkZW50aWFscyBjb25maWd1cmVkLiBQbGVhc2UgY29uZmlndXJlIHRoZW0gYW5kIHRyeSBhZ2Fpbi4nKQogICAgICAgIHJldHVybiAxCiAgICBleGNlcHQgYm90b2NvcmUuZXhjZXB0aW9ucy5DbGllbnRFcnJvciBhcyBjZToKICAgICAgICBwcmludChjZSkKICAgICAgICByZXR1cm4gMQoKICAgIHByaW50KG5ld19wdWJsaWNfa2V5KQoKCmlmIF9fbmFtZV9fID09ICdfX21haW5fXyc6CiAgICBzeXMuZXhpdChydW4oKSkKIikiIHx8IGVycm9yX3RyYXAKIyBNYWtlIHRoZSBuZXcgcHVibGljIGtleSBhdmFpbGFibGUgaW5zaWRlIHRoZSBjaHJvb3QgaGVyZS1kb2MKZXhwb3J0IE5FV19QVUJMSUNfS0VZCgpwcmludGYgIlN0YXJ0aW5nIGNocm9vdFxcbiIKY2hyb290ICIke0VDMlJFU0NVRV9PRkZMSU5FX1NZU1RFTV9ST09UfSIgL2Jpbi9iYXNoIDw8ICdDSFJPT1RfSEVSRScKIyEvYmluL2Jhc2gKZXJyb3JfdHJhcCgpCnsKICAgIGlmIHRlc3QgLW4gIiQxIiA7IHRoZW4KICAgICAgICBwcmludGYgIiVzXFxuIiAiJDEiCiAgICBmaQogICAgcHJpbnRmICIlLnM9IiAkKHNlcSAxIDgwKQogICAgcHJpbnRmICJcXG5UaGUgRUMyUmVzY3VlIGV4ZWN1dGlvbiBkaWQgbm90IGNvbXBsZXRlIHN1Y2Nlc3NmdWxseS5cXG4iCiAgICBleGl0IDEKfQouIC9ldGMvcHJvZmlsZQoKIyBDaGVjayB0aGF0IGEgY29tcGF0aWJsZSBQeXRob24gaW50ZXJwcmV0ZXIgaXMgYXZhaWxhYmxlIGluIHRoZSBjaHJvb3QgZW52aXJvbm1lbnQKaWYgY29tbWFuZCAtdiBweXRob24zID4gL2Rldi9udWxsOyB0aGVuCiAgICBQWVRIT049cHl0aG9uMwplbGlmIGNvbW1hbmQgLXYgcHl0aG9uMi43ID4gL2Rldi9udWxsOyB0aGVuCiAgICBQWVRIT049cHl0aG9uMi43CmVsc2UKICAgIGVycm9yX3RyYXAgIkZhaWxlZCB0byBmaW5kIGNvbXBhdGlibGUgUHl0aG9uIGVudmlyb25tZW50ISIKZmkKCnByaW50ZiAiUnVubmluZyBFQzIgUmVzY3VlIGZvciBMaW51eFxcbiIKZWMycmwgcnVuIC0tcmVtZWRpYXRlIC0tb25seS1tb2R1bGVzPW9wZW5zc2ggLS1pbmplY3Qta2V5LW9ubHkgLS1uZXctc3NoLWtleT0iJHtORVdfUFVCTElDX0tFWX0iIHx8IGVycm9yX3RyYXAKCkNIUk9PVF9IRVJFCgppZiB0ZXN0ICIkPyIgIT0gMDsgdGhlbgogICAgZXJyb3JfdHJhcCAiRXJyb3I6IGV4ZWN1dGlvbiBmYWlsdXJlIGluc2lkZSBjaHJvb3QgZW52aXJvbm1lbnQuIgpmaQ==\"\n          ],\n          \"SubnetId\": [\n            \"{{ SubnetId }}\"\n          ],\n          \"CreatePreEC2RescueBackup\": [\n            \"True\"\n          ],\n          \"UniqueId\": \"{{ automation:EXECUTION_ID }}\"\n        },\n        \"DocumentName\": \"AWSSupport-StartEC2RescueWorkflow\"\n      },\n      \"isCritical\": \"true\",\n      \"nextStep\": \"getLinuxBackupAmi\"\n    },\n    {\n      \"name\": \"getLinuxBackupAmi\",\n      \"action\": \"aws:executeAwsApi\",\n      \"onFailure\": \"Continue\",\n      \"inputs\": {\n        \"Service\": \"ssm\",\n        \"Api\": \"GetAutomationExecution\",\n        \"AutomationExecutionId\": \"{{ runEC2RescueForLinux.ExecutionId }}\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"ImageId\",\n          \"Selector\": \"$.AutomationExecution.Outputs.'preScriptBackup.ImageId'[0]\",\n          \"Type\": \"String\"\n        }\n      ],\n      \"isCritical\": \"false\",\n      \"nextStep\": \"getLinuxSSHKeyParameter\"\n    },\n    {\n      \"name\": \"getLinuxSSHKeyParameter\",\n      \"action\": \"aws:executeAwsApi\",\n      \"onFailure\": \"Continue\",\n      \"inputs\": {\n        \"Service\": \"ssm\",\n        \"Api\": \"GetParameter\",\n        \"Name\": \"/ec2rl/openssh/{{ InstanceId }}/key\",\n        \"WithDecryption\": false\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"Name\",\n          \"Selector\": \"$.Parameter.Name\",\n          \"Type\": \"String\"\n        }\n      ],\n      \"isCritical\": \"false\",\n      \"nextStep\": \"getEC2RescueForLinuxResult\"\n    },\n    {\n      \"name\": \"getEC2RescueForLinuxResult\",\n      \"action\": \"aws:executeAwsApi\",\n      \"onFailure\": \"Abort\",\n      \"inputs\": {\n        \"Service\": \"ssm\",\n        \"Api\": \"GetAutomationExecution\",\n        \"AutomationExecutionId\": \"{{ runEC2RescueForLinux.ExecutionId }}\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"Output\",\n          \"Selector\": \"$.AutomationExecution.Outputs.'runScriptForLinux.Output'[0]\",\n          \"Type\": \"String\"\n        }\n      ],\n      \"isCritical\": \"false\",\n      \"isEnd\": \"true\"\n    }\n  ],\n  \"outputs\": [\n    \"getEC2RescueForWindowsResult.Output\",\n    \"getWindowsBackupAmi.ImageId\",\n    \"getWindowsPasswordEnabledAmi.ImageId\",\n    \"getEC2RescueForLinuxResult.Output\",\n    \"getLinuxBackupAmi.ImageId\",\n    \"getLinuxSSHKeyParameter.Name\"\n  ]\n}",
  "CreatedDate": "2018-09-21T23:29:30.348Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Automation"
  },
  "DocumentVersion": "10",
  "Name": "AWSSupport-ResetAccess",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "471b15c1-7ac8-4131-97eb-3914b229b6e4",
    "Metadata": {},
    "ChecksumAlgorithm": 0,
    "ChecksumValidationStatus": 0
  },
  "ContentLength": 13502,
  "HttpStatusCode": 200,
  "LoggedAt": "2022-04-05T07:13:31.7900817+00:00"
}
