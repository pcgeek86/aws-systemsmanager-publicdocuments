{
  "AttachmentsContent": [],
  "Content": "{\n  \"schemaVersion\": \"2.2\",\n  \"description\": \"Send commands to Amazon CloudWatch Agent\",\n  \"parameters\": {\n    \"action\": {\n      \"description\": \"The action CloudWatch Agent should take.\",\n      \"type\": \"String\",\n      \"default\": \"configure\",\n      \"allowedValues\": [\n        \"configure\",\n        \"configure (append)\",\n        \"configure (remove)\",\n        \"start\",\n        \"status\",\n        \"stop\"\n      ]\n    },\n    \"mode\": {\n      \"description\": \"Controls platform-specific default behavior such as whether to include EC2 Metadata in metrics.\",\n      \"type\": \"String\",\n      \"default\": \"ec2\",\n      \"allowedValues\": [\n        \"ec2\",\n        \"onPremise\",\n        \"auto\"\n      ]\n    },\n    \"optionalConfigurationSource\": {\n      \"description\": \"Only for 'configure' related actions. Use 'ssm' to apply a ssm parameter as config. Use 'default' to apply default config for amazon-cloudwatch-agent. Use 'all' with 'configure (remove)' to clean all configs for amazon-cloudwatch-agent.\",\n      \"type\": \"String\",\n      \"allowedValues\": [\n        \"ssm\",\n        \"default\",\n        \"all\"\n      ],\n      \"default\": \"ssm\"\n    },\n    \"optionalConfigurationLocation\": {\n      \"description\": \"Only for 'configure' related actions. Only needed when Optional Configuration Source is set to 'ssm'. The value should be a ssm parameter name.\",\n      \"type\": \"String\",\n      \"default\": \"\",\n      \"allowedPattern\": \"[a-zA-Z0-9-\\\"~:_@./^(*)!<>?=+]*$\"\n    },\n    \"optionalOpenTelemetryCollectorConfigurationSource\": {\n      \"description\": \"Only for 'configure' related actions. Use 'ssm' to apply a ssm parameter as config. Use 'default' to apply default config for amazon-cloudwatch-agent. Use 'all' with 'configure (remove)' to clean all configs for amazon-cloudwatch-agent. It does not support MacOS instance.\",\n      \"type\": \"String\",\n      \"allowedValues\": [\n        \"ssm\",\n        \"default\",\n        \"all\"\n      ],\n      \"default\": \"ssm\"\n    },\n    \"optionalOpenTelemetryCollectorConfigurationLocation\": {\n      \"description\": \"Only for 'configure' related actions. Only needed when Optional Configuration Source is set to 'ssm'. The value should be a ssm parameter name. It does not support MacOS instance.\",\n      \"type\": \"String\",\n      \"default\": \"\",\n      \"allowedPattern\": \"[a-zA-Z0-9-\\\"~:_@./^(*)!<>?=+]*$\"\n    },\n    \"optionalRestart\": {\n      \"description\": \"Only for 'configure' related actions. If 'yes', restarts the agent to use the new configuration. Otherwise the new config will only apply on the next agent restart.\",\n      \"type\": \"String\",\n      \"default\": \"yes\",\n      \"allowedValues\": [\n        \"yes\",\n        \"no\"\n      ]\n    }\n  },\n  \"mainSteps\": [\n    {\n      \"name\": \"ControlCloudWatchAgentWindows\",\n      \"action\": \"aws:runPowerShellScript\",\n      \"precondition\": {\n        \"StringEquals\": [\n          \"platformType\",\n          \"Windows\"\n        ]\n      },\n      \"inputs\": {\n        \"runCommand\": [\n          \" Set-StrictMode -Version 2.0\",\n          \" $ErrorActionPreference = 'Stop'\",\n          \" $Cmd = \\\"${Env:ProgramFiles}\\\\Amazon\\\\AmazonCloudWatchAgent\\\\amazon-cloudwatch-agent-ctl.ps1\\\"\",\n          \" if (!(Test-Path -LiteralPath \\\"${Cmd}\\\")) {\",\n          \"     Write-Output 'CloudWatch Agent not installed.  Please install it using the AWS-ConfigureAWSPackage SSM Document.'\",\n          \"     exit 1\",\n          \" }\",\n          \" $Params = @()\",\n          \" $Action = '{{action}}'\",\n          \" if ($Action -eq 'configure') {\",\n          \"     $Action = 'fetch-config'\",\n          \" } elseif ($Action -eq 'configure (append)') {\",\n          \"     $Action = 'append-config'\",\n          \" } elseif ($Action -eq 'configure (remove)') {\",\n          \"     $Action = 'remove-config'\",\n          \" }\",\n          \" if ($Action -eq 'fetch-config' -Or $Action -eq 'append-config' -Or $Action -eq 'remove-config') {\",\n          \"     $CWAConfig = '{{optionalConfigurationLocation}}'\",\n          \"     if ('{{optionalConfigurationSource}}' -eq 'ssm') {\",\n          \"         if ($CWAConfig) {\",\n          \"             $CWAConfig = \\\"ssm:${CWAConfig}\\\"\",\n          \"         }\",\n          \"     } else {\",\n          \"         $CWAConfig = '{{optionalConfigurationSource}}'\",\n          \"     }\",\n          \"     if ($CWAConfig) {\",\n          \"         $Params += ('-c', \\\"${CWAConfig}\\\")\",\n          \"     }\",\n          \"     $CWOCConfig = '{{optionalOpenTelemetryCollectorConfigurationLocation}}'\",\n          \"     if ('{{optionalOpenTelemetryCollectorConfigurationSource}}' -eq 'ssm') {\",\n          \"         if ($CWOCConfig) {\",\n          \"             $CWOCConfig = \\\"ssm:${CWOCConfig}\\\"\",\n          \"         }\",\n          \"     } else {\",\n          \"         $CWOCConfig = '{{optionalOpenTelemetryCollectorConfigurationSource}}'\",\n          \"     }\",\n          \"     if ($CWOCConfig) {\",\n          \"         $Params += ('-o', \\\"${CWOCConfig}\\\")\",\n          \"     }\",\n          \"     if (($CWAConfig -eq 'all' -Or $CWOCConfig -eq 'all') -And $Action -ne 'remove-config') {\",\n          \"         Write-Output 'Configuration location \\\"all\\\" can only be applied with action \\\"remove-config\\\"'\",\n          \"         exit 1\",\n          \"     }\",\n          \"     if (!$CWAConfig -And !$CWOCConfig) {\",\n          \"         Write-Output 'At least one of AmazonCloudWatchAgent config and OpenTelemetryCollector config should be specified'\",\n          \"         exit 1\",\n          \"     }\",\n          \"     if ('{{optionalRestart}}' -eq 'yes') {\",\n          \"         $Params += '-s'\",\n          \"     }\",\n          \" }\",\n          \" $Params += ('-a', \\\"${Action}\\\", '-m', '{{mode}}')\",\n          \" Invoke-Expression \\\"& '${Cmd}' ${Params}\\\"\",\n          \" Set-StrictMode -Off\",\n          \" exit $LASTEXITCODE\"\n        ]\n      }\n    },\n    {\n      \"name\": \"ControlCloudWatchAgentLinux\",\n      \"action\": \"aws:runShellScript\",\n      \"precondition\": {\n        \"StringEquals\": [\n          \"platformType\",\n          \"Linux\"\n        ]\n      },\n      \"inputs\": {\n        \"runCommand\": [\n          \" #!/bin/sh\",\n          \" set -e\",\n          \" set -u\",\n          \" cmd='/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl'\",\n          \" if [ ! -x \\\"${cmd}\\\" ]; then\",\n          \"     echo 'CloudWatch Agent not installed.  Please install it using the AWS-ConfigureAWSPackage SSM Document.'\",\n          \" exit 1\",\n          \" fi\",\n          \" action=\\\"{{action}}\\\"\",\n          \" if [ \\\"${action}\\\" = 'configure' ]; then\",\n          \"     action='fetch-config'\",\n          \" elif [ \\\"${action}\\\" = 'configure (append)' ]; then\",\n          \"     action='append-config'\",\n          \" elif [ \\\"${action}\\\" = 'configure (remove)' ]; then\",\n          \"     action='remove-config'\",\n          \" fi\",\n          \" if [ \\\"${action}\\\" = 'fetch-config' ] || [ \\\"${action}\\\" = 'append-config' ] || [ \\\"${action}\\\" = 'remove-config' ]; then\",\n          \"     cwaconfig='{{optionalConfigurationLocation}}'\",\n          \"     if [ '{{optionalConfigurationSource}}' = 'ssm' ]; then\",\n          \"         if [ -n \\\"${cwaconfig}\\\" ]; then\",\n          \"             cwaconfig=\\\"ssm:${cwaconfig}\\\"\",\n          \"         fi\",\n          \"     else\",\n          \"         cwaconfig='{{optionalConfigurationSource}}'\",\n          \"     fi\",\n          \"     if [ -n \\\"${cwaconfig}\\\" ]; then\",\n          \"         cmd=\\\"${cmd} -c ${cwaconfig}\\\"\",\n          \"     fi\",\n          \"     cwocconfig='{{optionalOpenTelemetryCollectorConfigurationLocation}}'\",\n          \"     if [ '{{optionalOpenTelemetryCollectorConfigurationSource}}' = 'ssm' ]; then\",\n          \"         if [ -n \\\"${cwocconfig}\\\" ]; then\",\n          \"             cwocconfig=\\\"ssm:${cwocconfig}\\\"\",\n          \"         fi\",\n          \"     else\",\n          \"         cwocconfig='{{optionalOpenTelemetryCollectorConfigurationSource}}'\",\n          \"     fi\",\n          \"     if [ -n \\\"${cwocconfig}\\\" ]; then\",\n          \"         cmd=\\\"${cmd} -o ${cwocconfig}\\\"\",\n          \"     fi\",\n          \"     if ( [ \\\"${cwocconfig}\\\" = 'all' ] || [ \\\"${cwaconfig}\\\" = 'all' ] ) && [ \\\"${action}\\\" != 'remove-config' ]; then\",\n          \"         echo 'Configuration location \\\"all\\\" can only be applied with action \\\"remove-config\\\"'\",\n          \"         exit 1\",\n          \"     fi\",\n          \"     if [ -z \\\"${cwaconfig}\\\" ] && [ -z \\\"${cwocconfig}\\\" ]; then\",\n          \"         echo 'At least one of AmazonCloudWatchAgent config and OpenTelemetryCollector config should be specified'\",\n          \"         exit 1\",\n          \"     fi\",\n          \"     if [ '{{optionalRestart}}' = 'yes' ]; then\",\n          \"         cmd=\\\"${cmd} -s\\\"\",\n          \"     fi\",\n          \" fi\",\n          \" cmd=\\\"${cmd} -a ${action} -m {{mode}}\\\"\",\n          \" ${cmd}\"\n        ]\n      }\n    },\n    {\n      \"name\": \"ControlCloudWatchAgentMacOS\",\n      \"action\": \"aws:runShellScript\",\n      \"precondition\": {\n        \"StringEquals\": [\n          \"platformType\",\n          \"MacOS\"\n        ]\n      },\n      \"inputs\": {\n        \"runCommand\": [\n          \" #!/bin/sh\",\n          \" set -e\",\n          \" set -u\",\n          \" cmd='/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl'\",\n          \" if [ ! -x \\\"${cmd}\\\" ]; then\",\n          \"     echo 'CloudWatch Agent not installed.  Please install it using the AWS-ConfigureAWSPackage SSM Document.'\",\n          \" exit 1\",\n          \" fi\",\n          \" action=\\\"{{action}}\\\"\",\n          \" if [ \\\"${action}\\\" = 'configure' ]; then\",\n          \"     action='fetch-config'\",\n          \" elif [ \\\"${action}\\\" = 'configure (append)' ]; then\",\n          \"     action='append-config'\",\n          \" elif [ \\\"${action}\\\" = 'configure (remove)' ]; then\",\n          \"     action='remove-config'\",\n          \" fi\",\n          \" if [ \\\"${action}\\\" = 'fetch-config' ] || [ \\\"${action}\\\" = 'append-config' ] || [ \\\"${action}\\\" = 'remove-config' ]; then\",\n          \"     cwaconfig='{{optionalConfigurationLocation}}'\",\n          \"     if [ '{{optionalConfigurationSource}}' = 'ssm' ]; then\",\n          \"         if [ -n \\\"${cwaconfig}\\\" ]; then\",\n          \"             cwaconfig=\\\"ssm:${cwaconfig}\\\"\",\n          \"         fi\",\n          \"     else\",\n          \"         cwaconfig='{{optionalConfigurationSource}}'\",\n          \"     fi\",\n          \"     if [ -n \\\"${cwaconfig}\\\" ]; then\",\n          \"         cmd=\\\"${cmd} -c ${cwaconfig}\\\"\",\n          \"     fi\",\n          \"     if [ \\\"${cwaconfig}\\\" = 'all' ] && [ \\\"${action}\\\" != 'remove-config' ]; then\",\n          \"         echo 'Configuration location \\\"all\\\" can only be applied with action \\\"remove-config\\\"'\",\n          \"         exit 1\",\n          \"     fi\",\n          \"     if [ -z \\\"${cwaconfig}\\\" ]; then\",\n          \"         echo 'AmazonCloudWatchAgent config should be specified'\",\n          \"         exit 1\",\n          \"     fi\",\n          \"     if [ '{{optionalRestart}}' = 'yes' ]; then\",\n          \"         cmd=\\\"${cmd} -s\\\"\",\n          \"     fi\",\n          \" fi\",\n          \" cmd=\\\"${cmd} -a ${action} -m {{mode}}\\\"\",\n          \" ${cmd}\"\n        ]\n      }\n    }\n  ]\n}",
  "CreatedDate": "2021-01-18T22:25:01.448Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Command"
  },
  "DocumentVersion": "7",
  "Name": "AmazonCloudWatch-ManageAgent",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "945fa21a-24e9-42c1-a430-60fb7f7da53a",
    "Metadata": {},
    "ChecksumAlgorithm": 0,
    "ChecksumValidationStatus": 0
  },
  "ContentLength": 12182,
  "HttpStatusCode": 200,
  "LoggedAt": "2022-04-15T07:13:47.7217516+00:00"
}
