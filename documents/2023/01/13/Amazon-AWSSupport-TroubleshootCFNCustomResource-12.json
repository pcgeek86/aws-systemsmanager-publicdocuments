{
  "AttachmentsContent": [
    {
      "Hash": "47e9c0254ba6427aad40b7949321d1839e34d9d6b6996320f09f0ef6f2e37c03",
      "HashType": {
        "Value": "Sha256"
      },
      "Name": "attachment.zip",
      "Size": 12814,
      "Url": "https://aws-ssm-document-attachments-us-west-2.s3.us-west-2.amazonaws.com/5ff/190294270367/Automation/AWSSupport-TroubleshootCFNCustomResource%21b45d3307-df79-4ee3-99d7-791b7b043936/12/attachment.zip?x-attachment-size=12814&x-requester-accountId=987868780346&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJIMEYCIQD9ByUKmpO5sgg0Kyxfj5K00TgoXB5EYC2zox20QJy19gIhANPMKm46pa40ste72VaGeiEP66dSdtkJg9J3Le3EhoBsKtUECM%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAxoMMjQ5OTI0NTI3NDEwIgyBRAKgogRudKX4iOsqqQQI5pwlavTfSoEp3%2FUg6oePmRyXvEfYgO8sBCRCDGXpvzVG7bMM8LfWEw%2Fdu39VhniCB42EcR1rkez2WubJlC1VJSB7BNBPx9U3wj6BId4sq76AieH8LhVbTJDZUu0mf6B03xhSkt4WXJ4ET%2BkuFHNtStxvdHPUeSk5wvq3JjWmk1WFjrGAcda2qPoE7DmDYq7UZudm11HOvINGgIxPmoqXLGhzhpfWV7l%2BtyTE%2F064pg%2FJklP%2FL7DKUD2tDAHohU5Kv8dJEpgeKQSDMuhabFCHUJO5g1jFEV4IoEERKe6qSluYayLMepjB3wM1OImi5LlLWQQAD%2Fx4iPzP01Od2dotrWooVaEmvpEVJAkTBIdTafRBY7q7LESXXzbyT%2F771y9DLyoAyUH11eGtwRUlVBl%2BPEaaVoQmf35fgG7vtNGu8a8hADmmrbogj4QPQ3H3TKCy28IlC%2BwLLDQk9omc6SVIg7xQPgL3IwpedFmmvnR9gyYQBKCD4sCW%2BJk75%2FQi%2Biysj9u5gllWbVJFZCbzDcuwAQauURvQg%2B15HVl50lOluyob2cCAoWj66PZj5%2FDtlK9NlqdgoLcMiMJM1PGurRHjeb1PFVceVcJ4eGm0uP0fVeMIDKBx%2F%2FYJ0sqnUNXqQcp5AEZppAEJ9BwKHUmNQGcWVWysIumDkIwC5uZHFhLXlAKtKdLpvwwTjbj0ENegRveamPTmou%2BgPtMFNfqTiHJo1qZNQab%2BsYfNMJbXg54GOqgBUvVBxTUhK7OhfHZx918QL4qZzI7vOcTy%2BiCepJaTYENuftM8YL6T07HgfyYRgk%2B5uL9v%2BSFg1O9LWtfzfXI1A0xXm5zRKqt74uCE5%2FlugNuSlr4tHWh1a79YHdBpgtN1XcqAvyGmdEgqNM1Bssma8jkS2LxKGRY2ITa6hXObxHCQpsI0%2Fb9PoXcI5IgKupnebzCkEO5Ob9ihFrz8vQAeyLkpN%2B232RCY&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20230113T071148Z&X-Amz-SignedHeaders=host&X-Amz-Expires=86400&X-Amz-Credential=ASIATUMFJUUZNXO67KBF%2F20230113%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Signature=2f1a2eb2d21e6d85462acb9578217abf86fcd23603a84f51bd4f74989559b644"
    }
  ],
  "Content": "{\n  \"schemaVersion\": \"0.3\",\n  \"description\": \"# AWSSupport-TroubleshootCfnCustomResource\\n\\n----\\n\\nThe *AWSSupport-TroubleshootCfnCustomResource* runbook is designed to help troubleshooting Cloudformation stack which failed to [create, update ] (https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources.html) or [delete](https://aws.amazon.com/premiumsupport/knowledge-center/cloudformation-lambda-resource-delete/) a custom resource. This automation runbook checks the service token used for the custom resource along with the error message returned.\\nFor lambda baked custom resources, the runbook checks if the lambda is able to reach S3 endpoint to send a response back to cloudformation such as checking lambda network configuration VPC and security groups.\\n\\n\\n### Disclaimer:\\n\\n* This runbook doesn't make any changes to your cloudformation stack.\\n* This runbook doesn't check your lambda function logic, or your service provider and application logs.\\n\\n### Workflow Specifications:\\n\\n This workflow uses AWS Systems Manager Automation and takes in the following parameters:\\n\\n- **StackName** - **(Required)**: The cloudformation stack name. \\n- **AutomationAssumeRole** - **(Optional)** The IAM role which AWS Systems Manager will assume to execute this automation. This role must allow these IAM actions:\\n\\n        - cloudformation:DescribeStacks\\n        - cloudformation:DescribeStackEvents\\n        - cloudformation:ListStackResources\\n        - ec2:DescribeRouteTables\\n        - ec2:DescribeNatGateways\\n        - ec2:DescribeSecurityGroups\\n        - ec2:DescribeVpcs\\n        - ec2:DescribeVpcEndpoints\\n        - ec2:DescribeSubnets\\n        - logs:FilterLogEvents\\n\\n\\n\\nPlease visit the documentation on [Automation Setup](https://docs.aws.amazon.com/systems-manager/latest/userguide/automation-setup.html) for more information.\",\n  \"assumeRole\": \"{{ AutomationAssumeRole }}\",\n  \"parameters\": {\n    \"AutomationAssumeRole\": {\n      \"type\": \"String\",\n      \"description\": \"(Optional) The ARN of the role that allows the Automation runbook to perform the actions on your behalf. If no role is specified, Systems Manager Automation uses your current IAM user permissions context to execute this runbook.\",\n      \"allowedPattern\": \"^$|^arn:(aws|aws-cn|aws-us-gov|aws-iso(-[a-z])?):iam::\\\\d{12}:role/[\\\\w+=/,.@-]+$\",\n      \"maxChars\": 2048,\n      \"default\": \"\"\n    },\n    \"StackName\": {\n      \"type\": \"String\",\n      \"maxChars\": 128,\n      \"description\": \"(Required) The name of the Cloudformation stack in which the custom Resource Failed\",\n      \"allowedPattern\": \"[-a-zA-Z0-9]{1,128}$\"\n    }\n  },\n  \"mainSteps\": [\n    {\n      \"name\": \"validateCloudFormationStack\",\n      \"action\": \"aws:executeAwsApi\",\n      \"maxAttempts\": 3,\n      \"onFailure\": \"Abort\",\n      \"nextStep\": \"checkCustomResource\",\n      \"inputs\": {\n        \"Service\": \"cloudformation\",\n        \"Api\": \"DescribeStacks\",\n        \"StackName\": \"{{StackName}}\"\n      }\n    },\n    {\n      \"name\": \"checkCustomResource\",\n      \"action\": \"aws:executeScript\",\n      \"isCritical\": true,\n      \"onFailure\": \"Abort\",\n      \"inputs\": {\n        \"Runtime\": \"python3.8\",\n        \"InputPayload\": {\n          \"StackName\": \"{{StackName}}\"\n        },\n        \"Handler\": \"script_handler\",\n        \"Script\": \"# Copyright 2022 Amazon.com, Inc. and its affiliates. All Rights Reserved.\\n# SPDX-License-Identifier: LicenseRef-.amazon.com.-AmznSL-1.0\\n# Licensed under the Amazon Software License (the \\\"License\\\").\\n# You may not use this file except in compliance with the License.\\n# A copy of the License is located at\\n#   http://aws.amazon.com/asl/\\n# or in the \\\"license\\\" file accompanying this file. This file is distributed\\n# on an \\\"AS IS\\\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\\n# express or implied. See the License for the specific language governing\\n# permissions and limitations under the License.\\nimport re\\nimport os\\nimport json\\nfrom base.CFN import CFN\\nfrom case import getFunctiondetails \\nfrom case import Check_Subnet \\nfrom case import verifyNat\\nfrom case import SecurityGroup_Check\\nfrom case import s3_endpoint_route\\nfrom case import FilterCWlogs\\ndef script_handler(events, context):\\n    \\n    stack_name = events['StackName']\\n    Message = (\\\"Result:\\\\n\\\"\\n      \\\"-----------\\\\n \\\")\\n    cloudformation = CFN(stack_name)\\n    REGION = os.environ.get('AWS_REGION')\\n    if cloudformation.CustomResource == False:\\n            ## we didn't find custom resource in last update.\\n            Message =Message+ (\\\"No failed Custom Resource found in the last stack operation\\\")\\n    else:\\n        if \\\"sns\\\" in cloudformation.serviceToken:\\n            ## permission issue:\\n            if \\\"is not authorized to perform: SNS:Publish\\\" in cloudformation.Reason:\\n               User = re.split (\\\"is not authorized\\\", cloudformation.Reason)[0]\\n               resourcearn = re.search(\\\"(arn:[a-zA-Z0-9-]+:sns:[a-zA-Z0-9-]+:\\\\d{12}:[a-zA-Z0-9-_]+)\\\", cloudformation.Reason).group(0)\\n\\n               Message =Message+ (\\\"\\\\nThe cloudformation stack: '\\\" + cloudformation.StackId + \\\"' failed to \\\" + cloudformation.CR_Operation +\\\" the custom resource \\\" + cloudformation.LogicalResourceId + \\\"  due to the error below:\\\"\\n               \\\"\\\\n-------\\\"\\n               \\\"\\\\n\\\" + cloudformation.Reason + \\\" \\\"\\n               \\\"\\\\n--------\\\"\\n               \\\"\\\\nThe user or the role who creates the stack must have sns:Publish permissions.\\\"\\n              \\\"\\\\nWhen you associate an Amazon SNS topic with a custom resource, you use Amazon SNS notifications to invoke custom provisioning logic.\\\"\\n              \\\"\\\\nWhen AWS cloudformation create, update or delete the custom resource, it will Publish SNS Topic.\\\"\\n              \\\"\\\\n\\\\nHow to fix the error:\\\"\\n              \\\"\\\\n----------------------\\\"\\n              \\\"\\\\nIn order to be able to \\\" + cloudformation.Operation + \\\" the custom resource successfully, you need to grant \\\" + User +\\\" the permission to Publish sns topic, below is a the example below :\\\"\\n              \\\"\\\\n---------------------\\\"\\n              \\\"\\\\n{\\\"\\n              \\\"\\\\n\\\\\\\"Sid\\\\\\\": \\\\\\\"PermissionToPublishSNS\\\\\\\",\\\"\\n              \\\"\\\\n\\\\\\\"Effect\\\\\\\": \\\\\\\"Allow\\\\\\\",\\\"\\n              \\\"\\\\n\\\\\\\"Action\\\\\\\": \\\\\\\"sns:Publish\\\\\\\",\\\"\\n              \\\"\\\\n\\\\\\\"Resource\\\\\\\": \\\\\\\"\\\"+resourcearn+\\\"\\\\\\\"\\\"        ## This can be limited to the SNS topic arn\\\"\\n              \\\"\\\\n}\\\"\\n              \\\"\\\\n---------------------\\\"\\n              \\\"\\\\n\\\\nReferences: \\\"\\n              \\\"\\\\n-------------\\\"\\n              \\\"\\\\n[1] https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources-sns.html\\\")\\n\\n            elif \\\"CloudFormation did not receive a response from your Custom Resource\\\" in cloudformation.Reason:\\n                 Message =Message+(\\\"\\\"\\n            \\\"\\\\nThe cloudformation stack: '\\\" + cloudformation.StackId + \\\"' failed to \\\" + cloudformation.CR_Operation +\\\" the custom resource '\\\" + cloudformation.LogicalResourceId + \\\"'  because no response was sent back to cloudformation presigned URL.\\\"\\n            \\\"\\\\nThe Custom resource '\\\" + cloudformation.LogicalResourceId + \\\"' is baked with SNS topic. Hence the custom resource provider processes the data sent by the SNS topic and determines whether the Create request was successful. The resource provider then uses the S3 URL sent by AWS CloudFormation to send a response of either SUCCESS or FAILED.\\\"\\n            \\\"\\\\n\\\\nTo troubleshoot the issue :\\\"\\n            \\\"\\\\n======================================\\\"\\n            \\\"\\\\n1. Your application must be able to reach S3 endpoint as the response URL is similar to \\\\\\\"http://pre-signed-S3-url-for-response\\\\\\\". \\\"\\n            \\\"\\\\n2. Reviewing the logs of the application which processes the data and a send the response to Cloudformation would be helpful to troubleshoot the issue. a failure in the application execution would cause the signal not to be sent to cloudformation.\\\"\\n            \\\"\\\\n\\\\n[1] https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources-sns.html#walkthrough-custom-resources-sns-adding-nonaws-resource\\\")\\n            \\n            elif \\\"Received response status [FAILED] from custom resource\\\" in cloudformation.Reason:\\n                Message =Message+(\\\"\\\"\\n                \\\"\\\\nThe cloudformation stack '\\\"+ cloudformation.StackId + \\\"' failed to \\\" + cloudformation.CR_Operation +\\\" the custom resource \\\" +cloudformation.LogicalResourceId +\\\"  due to a Failed response was sent back to cloudformation presigned URL.\\\"\\n                \\\"\\\\nThe custom resource provider processes the data sent by the SNS topic and determines whether the Create request was successful. The resource provider then uses the S3 URL sent by AWS CloudFormation to send a response of either SUCCESS or FAILED.\\\"\\n                \\\"\\\\nDepending on the Status that cloudformation get from the resource, Cloudformation set the custom resource either as complete or failed.\\\"\\n\\n                \\\"\\\\n\\\\nReviewing the logs of the application which processes the data and a send the response to cloudformation would be helpful to troubleshoot the issue.\\\"\\n                \\\"\\\\n\\\\nReferences: \\\"\\n                \\\"\\\\n-------------\\\"\\n                \\\"\\\\n\\\\n[1] https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources-sns.html#walkthrough-custom-resources-sns-adding-nonaws-resource\\\")\\n\\n        elif \\\"lambda\\\" in cloudformation.serviceToken:\\n          FunctionName=re.split(':',cloudformation.serviceToken)[6]\\n          CloudwatchlogGroup=\\\"/aws/lambda/\\\" + FunctionName + \\\"\\\"\\n\\n\\n          if \\\"is not authorized to perform: lambda:InvokeFunction\\\" in cloudformation.Reason:\\n               User = re.split (\\\"is not authorized\\\", cloudformation.Reason)[0]\\n               resourcearn = re.search(\\\"(arn:[a-zA-Z0-9-]+:lambda:[a-zA-Z0-9-]+:\\\\d{12}:function:[a-zA-Z0-9-_]+)\\\", cloudformation.Reason).group(0)\\n               Message =Message+(\\\"\\\"\\n                \\\"\\\\nThe cloudformation stack '\\\" + cloudformation.StackId + \\\"' failed to \\\" + cloudformation.Operation + \\\" the custom resource \\\" + cloudformation.LogicalResourceId + \\\"  due to permission issue with the below error:\\\"\\n                \\\"\\\\n\\\" + cloudformation.Reason + \\\" \\\"\\n                \\\"\\\\n\\\\nWhen you associate a Lambda function with a custom resource, the function is invoked whenever the custom resource is created, updated, or deleted.\\\"\\n                \\\"\\\\nAWS CloudFormation calls a Lambda API to invoke the function and to pass all the request data (such as the request type and resource properties) to the function.\\\"\\n                \\\"\\\\n\\\\nIn order to be able to \\\" + cloudformation.Operation +\\\" the custom resource successfully, you need to grant \\\" + User +\\\" the permission to invoke the lambda function, below is a the example below :\\\"\\n                \\\"\\\\n---------------------\\\"\\n                \\\"\\\\n{\\\"\\n                \\\"\\\\n\\\\\\\"Sid\\\\\\\": \\\\\\\"PermissionToInvokeLambda\\\\\\\",\\\"\\n                \\\"\\\\n\\\\\\\"Effect\\\\\\\": \\\\\\\"Allow\\\\\\\",\\\"\\n                \\\"\\\\n\\\\\\\"Action\\\\\\\": \\\\\\\"lambda:InvokeFunction\\\\\\\",\\\"\\n                \\\"\\\\n\\\\\\\"Resource\\\\\\\": \\\\\\\"\\\"+resourcearn+\\\"\\\\\\\"\\\"         ## This can be limited to the lambda function arn\\\"\\n                \\\"\\\\n}\\\"\\n                \\\"\\\\n---------------------\\\"\\n                \\\"\\\\n\\\\nReferences: \\\"\\n                \\\"\\\\n-------------\\\"\\n                \\\"\\\\n[1] https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources-lambda.html\\\")\\n                \\n                \\n                \\n          elif \\\"Received response status [FAILED] from custom resource\\\" in cloudformation.Reason:\\n                stream=re.split(':',cloudformation.Reason)[2]\\n                CloudwatchlogStream=re.split(' ',stream)[1]\\n                logs = FilterCWlogs.filterLogstream(CloudwatchlogGroup,CloudwatchlogStream,cloudformation.Start_time,cloudformation.Final_time,\\\"error\\\")\\n                IflogsExist=logs[1]\\n\\n                Message =Message+(\\\"\\\"\\n                \\\"\\\\nThe cloudformation stack '\\\"+ cloudformation.StackId + \\\"' failed to \\\" + cloudformation.CR_Operation +\\\" the custom resource '\\\" +cloudformation.LogicalResourceId +\\\"'  due to a Failed response was sent back to cloudformation presigned URL.\\\"\\n                \\\"\\\\nThe lambda function '\\\" + FunctionName +\\\"' used in the service token of your custom resource processes the request sent by the cloudformation stack and determines whether the \\\" + cloudformation.Operation + \\\" request was successful or not.\\\"\\n                \\\"\\\\nLambda then uses the S3 URL sent by AWS CloudFormation to send a response of either SUCCESS or FAILED.\\\"\\n                \\\"\\\\nDepending on the Status that cloudFormation get from the lambda function, Cloudformation set the custom resource either as complete or failed.\\\"\\n                \\\"\\\\n\\\\nHow to troubleshoot: \\\"\\n                \\\"\\\\n=======================\\\"\\n                \\\"\\\\n- You can insert logging statements into your lambda code to help you validate that your code is working as expected.\\\")\\n                if IflogsExist: \\n                            ## there are some errors retrieved from the logs the customer needs to check the logs\\n                            Message =Message+ (\\\"\\\\nThe cloudwatch log group '\\\" + CloudwatchlogGroup + \\\"' is exist on the account and can be reached through the link : https://\\\"+REGION+\\\".console.aws.amazon.com/cloudwatch/home?region=\\\"+REGION+\\\"#logsV2:log-groups/log-group/$252Faws$252Flambda$252F\\\"+FunctionName+\\\"\\\"\\n                            \\\"\\\\n   ** Reviewing cloudwatch logs '\\\" + CloudwatchlogGroup + \\\"' and specifically the log stream \\\" +CloudwatchlogStream + \\\" will be helpful to know if there was any error during lambda function execution\\\")\\n                else:\\n                            Message =Message+(\\\"\\\\n\\\\n[Warning] Lambda was not able to publish logs to cloudwatch.\\\"\\n                            \\\"\\\\n   Lambda role must have access to CloudWatch Logs. If the role is missing the required permissions, the function still runs but it is unable to log any output to the CloudWatch service.\\\"\\n                            \\\"\\\\n   Lambda role permissions that are needed to publish logs to cloudwatch can be found here [2]\\\")\\n\\n                Message =Message+(\\\"\\\"\\n                \\\"\\\\n\\\\nReferences: \\\"\\n                \\\"\\\\n-------------\\\"\\n                \\\"\\\\n\\\\n[1] https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources.html#how-custom-resources-work\\\"\\n                \\\"\\\\n[2] https://docs.aws.amazon.com/lambda/latest/operatorguide/access-logs.html\\\"\\n                \\\"\\\\n[3] https://docs.aws.amazon.com/lambda/latest/dg/monitoring-cloudwatchlogs.html\\\")\\n\\n\\n          elif \\\"CloudFormation did not receive a response from your Custom Resource\\\" in cloudformation.Reason:\\n                logs = FilterCWlogs.filterLogstream(CloudwatchlogGroup,\\\"\\\",cloudformation.Start_time,cloudformation.Final_time,\\\"error\\\")\\n                IflogsExist=logs[1]\\n            ## We need to check if lambda exist in a vpc:\\n                ##1. check if lambda is exist and not deleted with the stack rollback.\\n                VPCconfig = getFunctiondetails.getFunction(FunctionName,cloudformation.StackName)              \\n                subnet_ids = VPCconfig[1]\\n                SecurityGroupIds = VPCconfig[2]\\n                VPC= VPCconfig[3]\\n                if VPCconfig[0] == False: ## the lambda is not created inside a VPC\\n                    Message =Message+(\\\"\\\"\\n                    \\\"\\\\nThe cloudformation stack '\\\"+ cloudformation.StackId + \\\"' failed to \\\" + cloudformation.CR_Operation +\\\" the custom resource '\\\" +cloudformation.LogicalResourceId +\\\"'  due to no response sent back to cloudformation presigned URL.\\\"\\n                    \\\"\\\\nThe custom resource '\\\" + cloudformation.LogicalResourceId +\\\"' is lambda baked custom resource. Hence Lambda should use the S3 URL sent by AWS CloudFormation to send a response of either SUCCESS or FAILED.\\\"\\n                    \\\"\\\\nDepending on the Status that cloudFormation get from the resource provider, Cloudformation set the custom resource either as complete or failed.\\\"\\n                    \\\"\\\\nCloudformation wait for 1 hour to receive a response back from lambda, if no response is received, then the custom resource will fail.\\\"\\n                    \\\"\\\\n[OK] The lambda function '\\\" + FunctionName  + \\\"' is not configured in a Amazon Virtual Private Cloud (VPC). The Lambda function is able to reach S3 endpoint.\\\"\\n                    \\\"\\\\n\\\\nHow to troubleshoot: \\\"\\n                    \\\"\\\\n=======================\\\"\\n                    \\\"\\\\n1. You can insert logging statements into your lambda code to help you validate that your code is working as expected. Lambda automatically integrates with CloudWatch Logs and pushes all logs from your code to a CloudWatch Logs group associated with a Lambda function, which is named /aws/lambda/\\\" + FunctionName + \\\"\\\")\\n                    if IflogsExist: \\n                            ## there are some errors retrieved from the logs the customer needs to check the logs\\n                            Message =Message+ (\\\"\\\\nThe cloudwatch log group '\\\" + CloudwatchlogGroup + \\\"' is exist on the account and can be reached through the link : https://\\\"+REGION+\\\".console.aws.amazon.com/cloudwatch/home?region=\\\"+REGION+\\\"#logsV2:log-groups/log-group/$252Faws$252Flambda$252F\\\"+FunctionName+\\\"\\\"\\n                            \\\"\\\\n   ** Reviewing cloudwatch logs '\\\" + CloudwatchlogGroup + \\\"' will be helpful to know if there was any error during lambda function execution\\\")\\n                    else:\\n                            Message =Message+(\\\"\\\\n\\\\nThe cloudwatch log group '\\\" + CloudwatchlogGroup + \\\"' is not exist on the account.\\\"\\n                            \\\"\\\\n   Lambda role must have access to CloudWatch Logs. If the role is missing the required permissions, the function still runs but it is unable to log any output to the CloudWatch service.\\\"\\n                            \\\"\\\\n   Lambda role permissions that are needed to publish logs to cloudwatch can be found here [2]\\\"\\n                            \\\"\\\\n   ** Reviewing cloudwatch logs '\\\" + CloudwatchlogGroup + \\\"' will be helpful to know if there was any error during lambda function execution\\\")\\n\\n                    Message =Message+(\\\"\\\"\\n                    \\\"\\\\n2. In order to send a response to cloudformation you can load the cfn-response module. The module contains a send method, which sends a response object to a custom resource by way of an Amazon S3 presigned URL (the ResponseURL)\\\"\\n                    \\\"\\\\n   The cfn-response module is available only when you use the ZipFile property to write your source code.\\\"  \\n                    \\\"\\\\n   It isn't available for source code that's stored in Amazon S3 buckets. For code in buckets, you must write your own functions to send responses.\\\"\\n                    \\\"\\\\n   You can refer to the documentation link [3][4] to see how you can implement cfnresponse module in your lambda code \\\"\\n                    \\\"\\\\n\\\\nReferences: \\\"\\n                    \\\"\\\\n-------------\\\"\\n                    \\\"\\\\n[1] https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources.html#how-custom-resources-work\\\"\\n                    \\\"\\\\n[2] https://docs.aws.amazon.com/lambda/latest/operatorguide/access-logs.html\\\"\\n                    \\\"\\\\n[3] https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-lambda-function-code-cfnresponsemodule.html\\\"\\n                    \\\"\\\\n[4] https://aws.amazon.com/premiumsupport/knowledge-center/cloudformation-cfn-response-lambda/ \\\")\\n                    if cloudformation.CR_Operation == \\\"DELETE\\\":\\n                        Message =Message+(\\\"\\\\n[5] https://aws.amazon.com/premiumsupport/knowledge-center/cloudformation-lambda-resource-delete/\\\")\\n\\n\\n                else: ## lambda is created inside VPC, Subnet and security groups needs to be verified.\\n\\n                    Message =Message+(\\\"\\\"\\n                    \\\"\\\\nThe cloudformation stack '\\\"+ cloudformation.StackId + \\\"' failed to \\\" + cloudformation.CR_Operation +\\\" the custom resource '\\\" +cloudformation.LogicalResourceId +\\\"'  due to no response sent back to cloudformation presigned URL.\\\"\\n                    \\\"\\\\nLambda should use the S3 URL sent by AWS CloudFormation to send a response of either SUCCESS or FAILED.\\\"\\n                    \\\"\\\\nDepending on the Status that cloudFormation get from the resource provider, Cloudformation set the custom resource either as complete or failed.\\\"\\n                    \\\"\\\\nCloudformation wait for 1 hour to receive a response back from lambda, if no response is received, then the custom resource will failed.\\\")\\n\\n                    Message= Message+(\\\"\\\\n\\\\nThe lambda function '\\\" + FunctionName  + \\\"' is created inside Amazon Virtual Private Cloud (VPC) '\\\" + VPC + \\\"'.\\\"\\n                    \\\"\\\\n1. Verifying lambda subnets configuration:\\\")\\n                    ## 1. verify subnet:\\n                    IsolatedCount = 0\\n                    IsolatedSubnets = []\\n                    for subnet in subnet_ids:\\n                        VerifySubnets = Check_Subnet.Verify_subnet(subnet,VPCconfig[3])\\n                        Message = Message+(\\\"\\\\n   [X] Verifying the subnet '\\\"+ subnet + \\\":\\\")\\n                        IsIsolated = VerifySubnets[0]\\n                        IsPublic = VerifySubnets[1]\\n                        IsPrivate = VerifySubnets[2]\\n                        NatGatway = VerifySubnets[3]\\n                        routetable = VerifySubnets[5]\\n                        if IsIsolated:\\n                            Message = Message+(\\\"\\\\n        [WARN] The subnet '\\\"+ subnet +\\\"' is a private subnet without NAT gateway.\\\"\\n                            \\\"\\\\n        Lambda in the private subnet can access the internet by using a network address translation (NAT) gateway that resides in the public subnet. \\\"\\n                            \\\"\\\\n        As no NAT gateway is configured with the subnet '\\\" + subnet + \\\"'. Then S3 VPC endpoint must be used to allow lambda function to reach S3 and permit traffic to the 'cloudformation-custom-resource-response-\\\" + REGION +\\\"' bucket. \\\")\\n                            ## we need to verify VPC endpoint.\\n                            s3_endpoints = s3_endpoint_route.s3_endpoints_list(VPC,REGION)\\n                            if not s3_endpoints:\\n                                Message = Message+(\\\"\\\\n        [ERROR] No S3 VPC endpoint is available for this subnet\\\" )\\n                            else:\\n                                Message += (\\\"\\\\n        [OK]: S3 gateway endpoint \\\" + s3_endpoints + \\\" is added to the lambda VPC.\\\")\\n                                for endpoint in s3_endpoints:\\n                                   if s3_endpoint_route.is_s3_route_exists( routetable, endpoint):\\n                                          Message += (\\\"\\\\n        [OK]: The Subnet route table has a route for S3 endpoint.\\\\n\\\")\\n                                   else:\\n                                          Message += (\\\"\\\\n        [ERROR]: The Subnet route table does not have a route for S3 endpoint.\\\\n\\\")\\n\\n\\n                            IsolatedCount = IsolatedCount+1\\n                            IsolatedSubnets.append(subnet)\\n                        elif IsPublic:\\n                            Message = Message+(\\\"\\\\n        [OK] The subnet '\\\"+ subnet +\\\"' is a public subnet with Internet gateway.\\\")\\n                        elif IsPrivate:\\n                            Message = Message+(\\\"\\\\ncThe subnet '\\\"+ subnet +\\\"' is a private subnet with NAT gateway '\\\"+NatGatway + \\\"'.\\\")\\n                            ## we need to verify the NAT gateway:\\n                            if verifyNat.verify_nat(NatGatway,VPC):\\n                                 Message = Message+(\\\"\\\\n         [OK] The NAT gateway configured with '\\\"+ subnet +\\\"' is configured correctly.\\\")\\n                            else:\\n                                 Message = Message+(\\\"\\\\n         [WARN] The NAT gateway configured with '\\\"+ subnet +\\\"' is not localted in a public subnet. Lambda is not able to send response to cloudformation S3 bucket.\\\")\\n                    \\n                    ## Checking security group now    \\n                    Message = Message+(\\\"\\\\n2. Verifying lambda security group outbound connections:\\\")\\n                    if SecurityGroup_Check.check_sg_out_rules(SecurityGroupIds):\\n                            Message = Message+(\\\"\\\\n  [OK] Lambda security group outbound connections are allowing 443 outbound traffic\\\")\\n                    else:\\n                            Message = Message+(\\\"\\\\n  [ERROR] Lambda security group outbound connections are not allowing 443 outbound traffic. Lambda is not able to send response back to cloudformation S3 bucket through https.\\\")\\n\\n                    Message = Message +(\\\"\\\\n\\\\nMore to troubleshoot: \\\"\\n                    \\\"\\\\n=======================\\\"\\n                    \\\"\\\\n1. You can insert logging statements into your lambda code to help you validate that your code is working as expected. Lambda automatically integrates with CloudWatch Logs and pushes all logs from your code to a CloudWatch Logs group associated with a Lambda function, which is named /aws/lambda/\\\" + FunctionName + \\\"\\\")\\n                    if IflogsExist: \\n                            ## there are some errors retrieved from the logs the customer needs to check the logs\\n                            Message =Message+ (\\\"\\\\nThe cloudwatch log group '\\\" + CloudwatchlogGroup + \\\"' is exist on the account and can be reached through the link : https://\\\"+REGION+\\\".console.aws.amazon.com/cloudwatch/home?region=\\\"+REGION+\\\"#logsV2:log-groups/log-group/$252Faws$252Flambda$252F\\\"+FunctionName+\\\"\\\"\\n                            \\\"\\\\n   ** Reviewing cloudwatch logs '\\\" + CloudwatchlogGroup + \\\"' will be helpful to know if there was any error during lambda function execution\\\")\\n                    else:\\n                            Message =Message+(\\\"\\\\n\\\\nThe cloudwatch log group '\\\" + CloudwatchlogGroup + \\\"' is not exist on the account.\\\"\\n                            \\\"\\\\n   Lambda role must have access to CloudWatch Logs. If the role is missing the required permissions, the function still runs but it is unable to log any output to the CloudWatch service.\\\"\\n                            \\\"\\\\n   Lambda role permissions that are needed to publish logs to cloudwatch can be found here [2]\\\"\\n                            \\\"\\\\n   ** Reviewing cloudwatch logs '\\\" + CloudwatchlogGroup + \\\"' will be helpful to know if there was any error during lambda function execution\\\")\\n\\n                    Message =Message+(\\\"\\\"\\n                    \\\"\\\\n2. In order to send a response to cloudformation you can load the cfn-response module. The module contains a send method, which sends a response object to a custom resource by way of an Amazon S3 presigned URL (the ResponseURL)\\\"\\n                    \\\"\\\\n   The cfn-response module is available only when you use the ZipFile property to write your source code.\\\"  \\n                    \\\"\\\\n   It isn't available for source code that's stored in Amazon S3 buckets. For code in buckets, you must write your own functions to send responses.\\\"\\n                    \\\"\\\\n   You can refer to the documentation link [3][4] to see how you can implement cfnresponse module in your lambda code \\\"\\n                    \\\"\\\\n\\\\nReferences: \\\"\\n                    \\\"\\\\n-------------\\\"\\n                    \\\"\\\\n[1] https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources.html#how-custom-resources-work\\\"\\n                    \\\"\\\\n[2] https://docs.aws.amazon.com/lambda/latest/operatorguide/access-logs.html\\\"\\n                    \\\"\\\\n[3] https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-lambda-function-code-cfnresponsemodule.html\\\"\\n                    \\\"\\\\n[4] https://aws.amazon.com/premiumsupport/knowledge-center/cloudformation-cfn-response-lambda/ \\\")\\n                    if cloudformation.CR_Operation == \\\"DELETE\\\":\\n                        Message =Message+(\\\"\\\\n[5] https://aws.amazon.com/premiumsupport/knowledge-center/cloudformation-lambda-resource-delete/\\\")\\n    return {'Message': Message }\\n\\n   \\n\",\n        \"Attachment\": \"attachment.zip\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"Message\",\n          \"Selector\": \"$.Payload.Message\",\n          \"Type\": \"String\"\n        }\n      ]\n    }\n  ],\n  \"files\": {\n    \"attachment.zip\": {\n      \"checksums\": {\n        \"sha256\": \"47e9c0254ba6427aad40b7949321d1839e34d9d6b6996320f09f0ef6f2e37c03\"\n      }\n    }\n  },\n  \"outputs\": [\n    \"checkCustomResource.Message\"\n  ]\n}",
  "CreatedDate": "2023-01-06T08:00:52.735Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Automation"
  },
  "DocumentVersion": "12",
  "Name": "AWSSupport-TroubleshootCFNCustomResource",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "3e6a9f49-d8e5-4f32-a6e3-35fea30ad438",
    "Metadata": {},
    "ChecksumAlgorithm": 0,
    "ChecksumValidationStatus": 0
  },
  "ContentLength": 33160,
  "HttpStatusCode": 200,
  "LoggedAt": "2023-01-13T07:11:48.2996067+00:00"
}
