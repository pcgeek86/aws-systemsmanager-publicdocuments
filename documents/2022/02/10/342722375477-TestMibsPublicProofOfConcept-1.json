{
  "AttachmentsContent": [],
  "Content": "{\"outputs\":[\"createImage.ImageId\"],\"schemaVersion\":\"0.3\",\"description\":\"Install seller packages on an AMI. This document is used by AWSMP Image Building Service. Do not alter the contents or delete this document. It is overwritten during each image build. The document name is reserved for Image Building service and should not be re-used.\",\"assumeRole\":\"{{ ssmAutomationRoleArn }}\",\"parameters\":{\"subnetId\":{\"default\":\"subnet-a39a38da\",\"description\":\"Subnet Id to use\",\"type\":\"String\"},\"userData\":{\"description\":\"Base64 encoded user data\",\"type\":\"String\"},\"installTimeoutInSeconds\":{\"default\":\"3600\",\"description\":\"Timeout in seconds for installation to time out\",\"type\":\"String\"},\"sourceImageId\":{\"description\":\"AMI to patch\",\"type\":\"String\"},\"packageUrls\":{\"description\":\"package URLs, separated by |\",\"type\":\"String\"},\"instanceType\":{\"description\":\"Instance type to use\",\"type\":\"String\"},\"installScript\":{\"description\":\"Install script\",\"type\":\"StringList\"},\"launchBlockDeviceMappings\":{\"description\":\"Block Device Mappings when launching EC2\",\"type\":\"MapList\"},\"outputS3KeyPrefix\":{\"description\":\"Key prefix for storing the logs\",\"type\":\"String\"},\"ssmAutomationRoleArn\":{\"default\":\"arn:aws:iam::342722375477:role/SSMAutomationRole\",\"description\":\"SSM Automation role ARN to use\",\"type\":\"String\"},\"securityGroupId\":{\"default\":[\"sg-259c755b\"],\"description\":\"Security group Id to use\",\"type\":\"StringList\"},\"marketplaceInstanceTagValue\":{\"description\":\"Build ID generated by image building service\",\"type\":\"String\"},\"outputS3BucketName\":{\"description\":\"Name of S3 bucket to store install command output\",\"type\":\"String\"},\"installCommand\":{\"description\":\"install command\",\"type\":\"String\"},\"targetImageName\":{\"description\":\"Name of new AMI\",\"type\":\"String\"},\"targetImageDescription\":{\"default\":\"\",\"description\":\"Description of new AMI\",\"type\":\"String\"},\"fileNames\":{\"description\":\"file names, separated by |\",\"type\":\"String\"},\"ssmInstanceProfileName\":{\"default\":\"SSMInstanceProfile\",\"description\":\"Instance profile to use\",\"type\":\"String\"},\"marketplaceInstanceTagKey\":{\"description\":\"Marketplace tag attached to instances launched from image building service\",\"type\":\"String\"}},\"mainSteps\":[{\"maxAttempts\":3,\"inputs\":{\"IamInstanceProfileName\":\"{{ ssmInstanceProfileName }}\",\"MaxInstanceCount\":1,\"TagSpecifications\":[{\"ResourceType\":\"instance\",\"Tags\":[{\"Value\":\"{{ marketplaceInstanceTagValue }}\",\"Key\":\"{{ marketplaceInstanceTagKey }}\"}]}],\"UserData\":\"{{ userData }}\",\"ImageId\":\"{{ sourceImageId }}\",\"BlockDeviceMappings\":\"{{ launchBlockDeviceMappings }}\",\"SubnetId\":\"{{ subnetId }}\",\"InstanceType\":\"{{ instanceType }}\",\"SecurityGroupIds\":\"{{ securityGroupId }}\",\"MinInstanceCount\":1},\"name\":\"launchInstance\",\"timeoutSeconds\":1200,\"action\":\"aws:runInstances\",\"onFailure\":\"Abort\"},{\"maxAttempts\":3,\"inputs\":{\"OutputS3KeyPrefix\":\"{{ outputS3KeyPrefix }}\",\"Parameters\":{\"executionTimeout\":\"{{ installTimeoutInSeconds }}\",\"commands\":\"{{ installScript }}\"},\"InstanceIds\":[\"{{ launchInstance.InstanceIds }}\"],\"OutputS3BucketName\":\"{{ outputS3BucketName }}\",\"DocumentName\":\"AWS-RunShellScript\"},\"name\":\"installPackages\",\"timeoutSeconds\":9000,\"action\":\"aws:runCommand\",\"onFailure\":\"Abort\"},{\"maxAttempts\":3,\"inputs\":{\"OutputS3KeyPrefix\":\"{{ outputS3KeyPrefix }}\",\"Parameters\":{\"commands\":[\"CLOUD_DIR=\\\"/var/lib/cloud\\\"; if test -d \\\"$CLOUD_DIR\\\"; then DATA_DIR=\\\"$CLOUD_DIR/data\\\"; SCRIPTS_DIR=\\\"$CLOUD_DIR/scripts\\\"; HANDLERS_DIR=\\\"$CLOUD_DIR/handlers\\\"; INSTANCES_DIR=\\\"$CLOUD_DIR/instances\\\"; INSTANCE_LINK=\\\"$CLOUD_DIR/instance\\\"; SEM_DIR=\\\"$CLOUD_DIR/sem\\\"; rm -rf \\\"$DATA_DIR\\\" \\\"$SCRIPTS_DIR\\\" \\\"$HANDLERS_DIR\\\" \\\"$INSTANCES_DIR\\\" \\\"$SEM_DIR\\\" \\\"$INSTANCE_LINK\\\"; else echo \\\"Directory $CLOUD_DIR not found\\\"; fi\",\"echo \\\"removing all keys generated by cloud-init\\\";  find /etc /root /home -type f -name 'authorized_keys' -print0 | xargs -0 rm -f\"]},\"InstanceIds\":[\"{{ launchInstance.InstanceIds }}\"],\"OutputS3BucketName\":\"{{ outputS3BucketName }}\",\"DocumentName\":\"AWS-RunShellScript\"},\"name\":\"resetCloudInit\",\"timeoutSeconds\":600,\"action\":\"aws:runCommand\",\"onFailure\":\"Abort\"},{\"maxAttempts\":3,\"inputs\":{\"DesiredState\":\"stopped\",\"InstanceIds\":[\"{{ launchInstance.InstanceIds }}\"]},\"name\":\"stopInstance\",\"action\":\"aws:changeInstanceState\",\"onFailure\":\"Continue\"},{\"maxAttempts\":3,\"inputs\":{\"ImageName\":\"{{ targetImageName }}\",\"InstanceId\":\"{{ launchInstance.InstanceIds }}\",\"ImageDescription\":\"{{ targetImageDescription }}\"},\"name\":\"createImage\",\"timeoutSeconds\":3600,\"action\":\"aws:createImage\",\"onFailure\":\"Continue\"},{\"maxAttempts\":3,\"inputs\":{\"DesiredState\":\"terminated\",\"InstanceIds\":[\"{{ launchInstance.InstanceIds }}\"]},\"name\":\"terminateInstance\",\"action\":\"aws:changeInstanceState\",\"onFailure\":\"Abort\"}]}",
  "CreatedDate": "2022-02-09T14:48:12.268Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Automation"
  },
  "DocumentVersion": "1",
  "Name": "arn:aws:ssm:us-west-2:342722375477:document/TestMibsPublicProofOfConcept",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "e7d690e8-5c13-4bce-8864-9348b0e2b2b1",
    "Metadata": {}
  },
  "ContentLength": 5454,
  "HttpStatusCode": 200,
  "LoggedAt": "2022-02-10T07:11:54.5111408+00:00"
}
