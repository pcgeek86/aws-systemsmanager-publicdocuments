{
  "AttachmentsContent": [],
  "Content": "{\n  \"description\" : \"\\n        The following use cases are not supported by this SOP:\\n\\n        1. Windows instances\\n        2. Un-partitioned disks\\n        3. No FS on the disk/partition\\n        \",\n  \"schemaVersion\" : \"0.3\",\n  \"assumeRole\" : \"{{ AutomationAssumeRole }}\",\n  \"parameters\" : {\n    \"SizeGib\" : {\n      \"type\" : \"Integer\",\n      \"description\" : \"(Required) The target size to increase the volume to (in GiB)\"\n    },\n    \"InstanceIdentifier\" : {\n      \"type\" : \"String\",\n      \"description\" : \"(Required) The identifier of the instance requiring increase of volume size\"\n    },\n    \"DeviceName\" : {\n      \"type\" : \"String\",\n      \"description\" : \"(Required) The device name (such as /dev/sdh) is to be increased\",\n      \"allowedPattern\" : \"^[/a-zA-Z0-9]{1,40}$\"\n    },\n    \"Partition\" : {\n      \"type\" : \"String\",\n      \"description\" : \"(Required) The partition which is to be increased\",\n      \"allowedPattern\" : \"^[0-9]$\"\n    },\n    \"AutomationAssumeRole\" : {\n      \"type\" : \"String\",\n      \"description\" : \"(Required) The ARN of the role that allows Automation to perform the actions on your behalf.\"\n    }\n  },\n  \"outputs\" : [ \"OutputRecoveryTime.RecoveryTime\" ],\n  \"mainSteps\" : [ {\n    \"description\" : \"Start the timer when SOP starts\",\n    \"name\" : \"RecordStartTime\",\n    \"action\" : \"aws:executeScript\",\n    \"inputs\" : {\n      \"Runtime\" : \"python3.6\",\n      \"Handler\" : \"script_handler\",\n      \"Script\" : \"from datetime import datetime, timezone\\n\\ndef script_handler(params: dict, context):\\n    return get_current_time().isoformat()\\n\\ndef get_current_time():\\n    return datetime.now(timezone.utc)\\n\",\n      \"InputPayload\" : { }\n    },\n    \"outputs\" : [ {\n      \"Name\" : \"StartTime\",\n      \"Selector\" : \"$.Payload\",\n      \"Type\" : \"String\"\n    } ]\n  }, {\n    \"description\" : \"Describe volumes by instance and device [DescribeVolumes](https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DescribeVolumes.html)\",\n    \"name\" : \"DescribeInstanceVolume\",\n    \"action\" : \"aws:executeAwsApi\",\n    \"inputs\" : {\n      \"Service\" : \"ec2\",\n      \"Api\" : \"DescribeVolumes\",\n      \"Filters\" : [ {\n        \"Name\" : \"attachment.device\",\n        \"Values\" : [ \"{{DeviceName}}\" ]\n      }, {\n        \"Name\" : \"attachment.instance-id\",\n        \"Values\" : [ \"{{InstanceIdentifier}}\" ]\n      } ]\n    },\n    \"outputs\" : [ {\n      \"Name\" : \"VolumeId\",\n      \"Selector\" : \"$.Volumes[0].VolumeId\",\n      \"Type\" : \"String\"\n    }, {\n      \"Name\" : \"CurrentSizeGiB\",\n      \"Selector\" : \"$.Volumes[0].Size\",\n      \"Type\" : \"Integer\"\n    } ]\n  }, {\n    \"description\" : \"Check if requested volume size is greater than current. If not, we know to skip to the end.\",\n    \"name\" : \"CheckLargerVolume\",\n    \"action\" : \"aws:executeScript\",\n    \"inputs\" : {\n      \"Runtime\" : \"python3.6\",\n      \"Handler\" : \"script_handler\",\n      \"Script\" : \"\\n\\ndef script_handler(params: dict, context):\\n    return params['CurrentSizeGiB'] >= params['SizeGib']\\n\",\n      \"InputPayload\" : {\n        \"SizeGib\" : \"{{ SizeGib }}\",\n        \"CurrentSizeGiB\" : \"{{ DescribeInstanceVolume.CurrentSizeGiB }}\"\n      }\n    },\n    \"outputs\" : [ {\n      \"Name\" : \"VolumeAlreadyGreater\",\n      \"Selector\" : \"$.Payload\",\n      \"Type\" : \"Boolean\"\n    } ]\n  }, {\n    \"name\" : \"SizeValidationBranch\",\n    \"action\" : \"aws:branch\",\n    \"inputs\" : {\n      \"Choices\" : [ {\n        \"NextStep\" : \"OutputRecoveryTime\",\n        \"Variable\" : \"{{CheckLargerVolume.VolumeAlreadyGreater}}\",\n        \"BooleanEquals\" : true\n      } ]\n    }\n  }, {\n    \"description\" : \"Modify the Volume [ModifyVolume](https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_ModifyVolume.html)\",\n    \"name\" : \"ModifyVolume\",\n    \"action\" : \"aws:executeAwsApi\",\n    \"inputs\" : {\n      \"Service\" : \"ec2\",\n      \"Api\" : \"ModifyVolume\",\n      \"VolumeId\" : \"{{ DescribeInstanceVolume.VolumeId }}\",\n      \"Size\" : \"{{ SizeGib }}\"\n    }\n  }, {\n    \"description\" : \"Wait until volume is updated to new value.\",\n    \"name\" : \"WaitForVolumeSize\",\n    \"action\" : \"aws:executeScript\",\n    \"inputs\" : {\n      \"Runtime\" : \"python3.6\",\n      \"Handler\" : \"script_handler\",\n      \"Script\" : \"from time import sleep\\nimport boto3\\n\\ndef script_handler(params: dict, context):\\n    ec2 = boto3.client('ec2')\\n    while True:\\n        response = ec2.describe_volumes(VolumeIds=[params['VolumeId']])\\n        if response['Volumes'][0]['Size'] == params['SizeGib']:\\n            return {}\\n        print('Sleeping for 3 seconds because received response of ' + str(response['Volumes'][0]['Size']))\\n        sleep(3)\\n\",\n      \"InputPayload\" : {\n        \"SizeGib\" : \"{{ SizeGib }}\",\n        \"VolumeId\" : \"{{ DescribeInstanceVolume.VolumeId }}\"\n      }\n    }\n  }, {\n    \"description\" : \"Command Document: AWS_RunShellScript\",\n    \"name\" : \"AWS_RunShellScript\",\n    \"action\" : \"aws:runCommand\",\n    \"inputs\" : {\n      \"DocumentName\" : \"AWS-RunShellScript\",\n      \"InstanceIds\" : [ \"{{ InstanceIdentifier }}\" ],\n      \"Parameters\" : {\n        \"commands\" : [ \"device_name={{ DeviceName }}\", \"[[ ! ${device_name} == /dev/* ]] && device_name=/dev/{{ DeviceName }}\", \"full_device_name=${device_name}{{ Partition }}\", \"[ -L ${device_name} ] && full_device_name=/dev/$(ls -l ${device_name} | sed -e 's/.* -> //')p{{ Partition }}\", \"originalsize=`df -h | grep ${full_device_name} | awk -F ' ' '{print $2}'`\", \"echo \\\"Original volume size: ${originalsize}\\\"\", \"sudo growpart ${device_name} {{ Partition }}\", \"mntpt=`df -h | grep ${full_device_name} | grep -oE '[^ ]+$'`\", \"sudo xfs_growfs -d ${mntpt} || sudo resize2fs ${full_device_name}\", \"echo \\\"Resize completed\\\"\", \"volsize=`df -h | grep ${full_device_name} | awk -F ' ' '{print $2}'`\", \"echo \\\"New volume size: ${volsize}\\\"\", \"[ -n \\\"${volsize}\\\" ] && [ ${volsize} != ${originalsize} ] 2>/dev/null\" ]\n      }\n    }\n  }, {\n    \"description\" : \"Record the runtime in seconds\",\n    \"name\" : \"OutputRecoveryTime\",\n    \"action\" : \"aws:executeScript\",\n    \"inputs\" : {\n      \"Runtime\" : \"python3.6\",\n      \"Handler\" : \"script_handler\",\n      \"Script\" : \"from datetime import datetime, timezone\\nfrom dateutil import parser\\n\\ndef script_handler(params: dict, context):\\n    return (get_current_time() - parser.parse(params['StartTime'])).seconds\\n\\ndef get_current_time():\\n    return datetime.now(timezone.utc)\\n\",\n      \"InputPayload\" : {\n        \"StartTime\" : \"{{ RecordStartTime.StartTime }}\"\n      }\n    },\n    \"outputs\" : [ {\n      \"Name\" : \"RecoveryTime\",\n      \"Selector\" : \"$.Payload\",\n      \"Type\" : \"Integer\"\n    } ]\n  } ]\n}",
  "CreatedDate": "2023-02-19T17:15:00.785Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Automation"
  },
  "DocumentVersion": "4",
  "Name": "AWSResilienceHub-IncreaseVolumeSizeEbsSOP_2020-05-26",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "2caeb191-75ab-4422-b565-68b87fd94f9f",
    "Metadata": {},
    "ChecksumAlgorithm": 0,
    "ChecksumValidationStatus": 0
  },
  "ContentLength": 7305,
  "HttpStatusCode": 200,
  "LoggedAt": "2023-05-15T07:12:04.5234757+00:00"
}
