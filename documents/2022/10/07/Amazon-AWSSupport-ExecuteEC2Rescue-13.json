{
  "AttachmentsContent": [],
  "Content": "{\n  \"schemaVersion\": \"0.3\",\n  \"description\": \"This document will use the EC2Rescue tool to troubleshoot and where possible repair common connectivity issues with the specified EC2 instance.\",\n  \"assumeRole\": \"{{ AssumeRole }}\",\n  \"parameters\": {\n    \"UnreachableInstanceId\": {\n      \"type\": \"String\",\n      \"description\": \"(Required) ID of your unreachable EC2 instance. IMPORTANT: AWS Systems Manager Automation stops this instance, and creates an AMI before attempting any operations. Data stored in instance store volumes will be lost. The public IP address will change if you are not using an Elastic IP.\",\n      \"allowedPattern\": \"^[m]{0,1}i-[a-z0-9]{8,17}$\"\n    },\n    \"LogDestination\": {\n      \"type\": \"String\",\n      \"description\": \"(Optional) S3 bucket name in your account where you want to upload the troubleshooting logs. Make sure the bucket policy does not grant unnecessary read/write permissions to parties that do not need access to the collected logs.\",\n      \"default\": \"\",\n      \"allowedPattern\": \"^$|^[_a-zA-Z0-9][-._a-zA-Z0-9]{2,62}$\"\n    },\n    \"EC2RescueInstanceType\": {\n      \"type\": \"String\",\n      \"description\": \"(Required) The EC2 instance type for the EC2Rescue instance. Recommended size: t2.small.\",\n      \"default\": \"t2.small\",\n      \"allowedValues\": [\n        \"t2.small\",\n        \"t2.medium\",\n        \"t2.large\"\n      ]\n    },\n    \"SubnetId\": {\n      \"type\": \"String\",\n      \"description\": \"(Optional) The subnet ID for the EC2Rescue instance. By default, AWS Systems Manager Automation creates a new VPC. Alternatively, Use SelectedInstanceSubnet to use the same subnet as your instance, or specify a custom subnet ID. IMPORTANT: The subnet must be in the same Availability Zone as UnreachableInstanceId, and it must allow access to the SSM endpoints.\",\n      \"default\": \"CreateNewVPC\",\n      \"allowedPattern\": \"^SelectedInstanceSubnet$|^CreateNewVPC$|^subnet-[a-z0-9]{8,17}$\"\n    },\n    \"AssumeRole\": {\n      \"type\": \"String\",\n      \"description\": \"(Optional) The IAM role for this execution. If no role is specified, AWS Systems Manager Automation will use your IAM permissions to execute this document.\",\n      \"default\": \"\"\n    }\n  },\n  \"mainSteps\": [\n    {\n      \"name\": \"assertInstanceIsWindows\",\n      \"action\": \"aws:assertAwsResourceProperty\",\n      \"onFailure\": \"step:runEC2RescueForLinux\",\n      \"inputs\": {\n        \"Service\": \"ec2\",\n        \"Api\": \"DescribeInstances\",\n        \"InstanceIds\": [\n          \"{{ UnreachableInstanceId }}\"\n        ],\n        \"PropertySelector\": \"$.Reservations[0].Instances[0].Platform\",\n        \"DesiredValues\": [\n          \"windows\"\n        ]\n      },\n      \"isCritical\": \"false\",\n      \"nextStep\": \"runEC2RescueForWindows\"\n    },\n    {\n      \"name\": \"runEC2RescueForWindows\",\n      \"onFailure\": \"Continue\",\n      \"action\": \"aws:executeAutomation\",\n      \"inputs\": {\n        \"RuntimeParameters\": {\n          \"InstanceId\": [\n            \"{{ UnreachableInstanceId }}\"\n          ],\n          \"OfflineScript\": [\n            \"SW52b2tlLUVDMlJlc2N1ZUZpeEFsbCAtQmxvY2tEZXZpY2VOYW1lICR7ZW52OkVDMlJFU0NVRV9PRkZMSU5FX0VCU19ERVZJQ0V9CldyaXRlLUhvc3QgIj09PT09IExvZyBDb2xsZWN0aW9uID09PT09YHIiCmlmKCR7ZW52OkVDMlJFU0NVRV9TM19CVUNLRVR9KXsKCVN0YXJ0LVNsZWVwIDMwCglXcml0ZS1Ib3N0ICJDb2xsZWN0aW5nIGxvZ3MgZnJvbSB0aGUgdW5yZWFjaGFibGUgV2luZG93cyBpbnN0YW5jZS5gciIKCSRkYXRlID0gKEdldC1EYXRlIC1VRm9ybWF0ICIlWV8lbV8lZC0lSF8lTSIpCgkkbG9nRmlsZU5hbWUgPSAoJGRhdGUgKyAiXyIgKyAkZW52OkVDMlJFU0NVRV9TT1VSQ0VfSU5TVEFOQ0UgKyAiX2FsbCIpCgkkbG9nRmlsZSA9IEludm9rZS1FQzJSZXNjdWVDb2xsZWN0TG9nQnVuZGxlIC1PZmZsaW5lIC1CbG9ja0RldmljZU5hbWUgJHtlbnY6RUMyUkVTQ1VFX09GRkxJTkVfRUJTX0RFVklDRX0gLUxvZ0ZpbGVOYW1lICRsb2dGaWxlTmFtZSAtTG9ncyAiYWxsIgoJV3JpdGUtSG9zdCAiTG9nIGNvbGxlY3Rpb24gY29tcGxldGVkLiBVcGxvYWRpbmcgbG9ncyB0byBTMyBidWNrZXQgJHtlbnY6RUMyUkVTQ1VFX1MzX0JVQ0tFVH0gdW5kZXIgcGF0aCAke2VudjpFQzJSRVNDVUVfUzNfUFJFRklYfS5gciIKCUNvcHktRUMyUmVzY3VlTG9nQnVuZGxlVG9TMyAtRmlsZVBhdGggJGxvZ0ZpbGUgLVMzQnVja2V0TmFtZSAke2VudjpFQzJSRVNDVUVfUzNfQlVDS0VUfSAtUzNQYXRoICIke2VudjpFQzJSRVNDVUVfUzNfUFJFRklYfSIKCVdyaXRlLUhvc3QgIkxvZyB1cGxvYWQgY29tcGxldGVkLmByYHIiCn1lbHNlewoJV3JpdGUtSG9zdCAiTm8gUzMgYnVja2V0IHByb3ZpZGVkLiBMb2dzIHdpbGwgbm90IGJlIGNvbGxlY3RlZC5gcmByIgp9\"\n          ],\n          \"SubnetId\": [\n            \"{{ SubnetId }}\"\n          ],\n          \"CreatePreEC2RescueBackup\": [\n            \"True\"\n          ],\n          \"S3BucketName\": [\n            \"{{ LogDestination }}\"\n          ],\n          \"S3Prefix\": [\n            \"AWSSupport-ExecuteEC2Rescue/\"\n          ],\n          \"UniqueId\": \"{{ automation:EXECUTION_ID }}\"\n        },\n        \"DocumentName\": \"AWSSupport-StartEC2RescueWorkflow\"\n      },\n      \"isCritical\": \"true\",\n      \"nextStep\": \"getWindowsBackupAmi\"\n    },\n    {\n      \"name\": \"getWindowsBackupAmi\",\n      \"action\": \"aws:executeAwsApi\",\n      \"onFailure\": \"Continue\",\n      \"inputs\": {\n        \"Service\": \"ssm\",\n        \"Api\": \"GetAutomationExecution\",\n        \"AutomationExecutionId\": \"{{ runEC2RescueForWindows.ExecutionId }}\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"ImageId\",\n          \"Selector\": \"$.AutomationExecution.Outputs.'preScriptBackup.ImageId'[0]\",\n          \"Type\": \"String\"\n        }\n      ],\n      \"isCritical\": \"false\",\n      \"nextStep\": \"getEC2RescueForWindowsResult\"\n    },\n    {\n      \"name\": \"getEC2RescueForWindowsResult\",\n      \"action\": \"aws:executeAwsApi\",\n      \"onFailure\": \"Abort\",\n      \"inputs\": {\n        \"Service\": \"ssm\",\n        \"Api\": \"GetAutomationExecution\",\n        \"AutomationExecutionId\": \"{{ runEC2RescueForWindows.ExecutionId }}\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"Output\",\n          \"Selector\": \"$.AutomationExecution.Outputs.'runScriptForWindows.Output'[0]\",\n          \"Type\": \"String\"\n        }\n      ],\n      \"isCritical\": \"false\",\n      \"isEnd\": \"true\"\n    },\n    {\n      \"name\": \"runEC2RescueForLinux\",\n      \"onFailure\": \"Continue\",\n      \"action\": \"aws:executeAutomation\",\n      \"inputs\": {\n        \"RuntimeParameters\": {\n          \"InstanceId\": [\n            \"{{ UnreachableInstanceId }}\"\n          ],\n          \"OfflineScript\": [\n            \"ZXJyb3JfdHJhcCgpCnsKICAgIGlmIHRlc3QgLW4gIiQxIiA7IHRoZW4KICAgICAgICBwcmludGYgIiVzXFxuIiAiJDEiCiAgICBmaQogICAgcHJpbnRmICIlLnM9IiAkKHNlcSAxIDgwKQogICAgcHJpbnRmICJcXG5UaGUgRUMyUmVzY3VlIGV4ZWN1dGlvbiBkaWQgbm90IGNvbXBsZXRlIHN1Y2Nlc3NmdWxseS5cXG4iCiAgICBleGl0IDEKfQoKcHJpbnRmICJTdGFydGluZyBjaHJvb3RcXG4iCmNocm9vdCAiJHtFQzJSRVNDVUVfT0ZGTElORV9TWVNURU1fUk9PVH0iIC9iaW4vYmFzaCA8PCAnQ0hST09UX0hFUkUnCiMhL2Jpbi9iYXNoCmVycm9yX3RyYXAoKQp7CiAgICBpZiB0ZXN0IC1uICIkMSIgOyB0aGVuCiAgICAgICAgcHJpbnRmICIlc1xcbiIgIiQxIgogICAgZmkKICAgIHByaW50ZiAiJS5zPSIgJChzZXEgMSA4MCkKICAgIHByaW50ZiAiXFxuVGhlIEVDMlJlc2N1ZSBleGVjdXRpb24gZGlkIG5vdCBjb21wbGV0ZSBzdWNjZXNzZnVsbHkuXFxuIgogICAgZXhpdCAxCn0KLiAvZXRjL3Byb2ZpbGUKCiMgQ2hlY2sgdGhhdCBhIGNvbXBhdGlibGUgUHl0aG9uIGludGVycHJldGVyIGlzIGF2YWlsYWJsZSBpbiB0aGUgY2hyb290IGVudmlyb25tZW50CmlmIGNvbW1hbmQgLXYgcHl0aG9uMyA+IC9kZXYvbnVsbDsgdGhlbgogICAgUFlUSE9OPXB5dGhvbjMKZWxpZiBjb21tYW5kIC12IHB5dGhvbjIuNyA+IC9kZXYvbnVsbDsgdGhlbgogICAgUFlUSE9OPXB5dGhvbjIuNwplbHNlCiAgICBlcnJvcl90cmFwICJGYWlsZWQgdG8gZmluZCBjb21wYXRpYmxlIFB5dGhvbiBlbnZpcm9ubWVudCEiCmZpCgpwcmludGYgIlJ1bm5pbmcgRUMyIFJlc2N1ZSBmb3IgTGludXhcXG4iCmVjMnJsIHJ1biAtLXJlbWVkaWF0ZSAtLWZzdGFiZmFpbHVyZXMgLS1yZWJ1aWxkaW5pdHJkIC0tc2VsaW51eHBlcm1pc3NpdmUgLS11ZGV2bmV0cGVyc2lzdGVudCAtLW5vPWR1cGxpY2F0ZWZzdXVpZCxkdXBsaWNhdGVwYXJ0dXVpZCB8fCBlcnJvcl90cmFwCkNIUk9PVF9IRVJFCgppZiB0ZXN0ICIkPyIgIT0gMDsgdGhlbgogICAgZXJyb3JfdHJhcCAiRXJyb3I6IGV4ZWN1dGlvbiBmYWlsdXJlIGluc2lkZSBjaHJvb3QgZW52aXJvbm1lbnQuIgpmaQoKaWYgdGVzdCAtbiAiJHtFQzJSRVNDVUVfUzNfQlVDS0VUfSI7IHRoZW4KICAgICMgTWFrZSBzdXJlIHRoZSBidWNrZXQgaXMgYWNjZXNzaWJsZSBiZWZvcmUgdHJ5aW5nIHRvIHVwbG9hZAogICAgYXdzIHMzYXBpIGhlYWQtYnVja2V0IC0tYnVja2V0ICIke0VDMlJFU0NVRV9TM19CVUNLRVR9IiB8fCBlcnJvcl90cmFwICJObyBTMyBidWNrZXQgY2FsbGVkICR7RUMyUkVTQ1VFX1MzX0JVQ0tFVH0gZm91bmQgaW4gdGhlIGN1cnJlbnQgQVdTIGFjY291bnQgb3IgYWNjZXNzIGRlbmllZC4gUGxlYXNlIHNwZWNpZnkgYW4gUzMgYnVja2V0IHlvdSBvd24gYW5kIHRoYXQgdGhpcyBpbnN0YW5jZSBoYXMgYWNjZXNzIHRvLiIKCglMT0dfRElSPSIkKGJhc2VuYW1lICIkKGZpbmQgIiR7RUMyUkVTQ1VFX09GRkxJTkVfU1lTVEVNX1JPT1R9Ii92YXIvdG1wL2VjMnJsIC1tYXhkZXB0aCAxIC1taW5kZXB0aCAxIC1wcmludGYgIiVUKyAlcFxcbiIgfCBzb3J0IC1yIHwgaGVhZCAtbiAxIHwgYXdrICd7cHJpbnQgJDJ9JykiKSIKICAgIEZJTEVfTkFNRT0iJChkYXRlIC0taXNvLTg2MDE9c2Vjb25kcyB8IHNlZCAicy9cXDovXy9nIikiXyIke0VDMlJFU0NVRV9TT1VSQ0VfSU5TVEFOQ0V9Ii50Z3oKCXByaW50ZiAiQ3JlYXRpbmcgdGFyYmFsbCAke0ZJTEVfTkFNRX0sIG9mIEVDMlJMIGxvZyBkaXJlY3RvcnksICR7RUMyUkVTQ1VFX09GRkxJTkVfU1lTVEVNX1JPT1R9L3Zhci90bXAvZWMycmwvJXNcXG4iICIke0xPR19ESVJ9IgoJdGFyIC1jemYgIiR7RklMRV9OQU1FfSIgLUMgIiR7RUMyUkVTQ1VFX09GRkxJTkVfU1lTVEVNX1JPT1R9Ii92YXIvdG1wL2VjMnJsICIke0xPR19ESVJ9IiB8fCBlcnJvcl90cmFwICJGYWlsZWQgdG8gY3JlYXRlIHRhcmJhbGwiCglwcmludGYgIlVwbG9hZGluZyB0YXJiYWxsIHRvIHMzOi8vJXMvJXMvJXNcXG4iICIke0VDMlJFU0NVRV9TM19CVUNLRVR9IiAiJHtFQzJSRVNDVUVfUzNfUFJFRklYfSIgIiR7RklMRV9OQU1FfSIKCWF3cyBzMyBjcCAiJHtGSUxFX05BTUV9IiBzMzovLyIke0VDMlJFU0NVRV9TM19CVUNLRVR9Ii8iJHtFQzJSRVNDVUVfUzNfUFJFRklYfSIvIiR7RklMRV9OQU1FfSIgIHx8IGVycm9yX3RyYXAgIkZhaWxlZCB0byB1cGxvYWQgdGFyYmFsbCB0byBTMyIKCXByaW50ZiAiRG9uZSFcXG4iCmVsc2UKCXByaW50ZiAiTm8gUzMgYnVja2V0IHByb3ZpZGVkLiBMb2dzIHdpbGwgbm90IGJlIGNvbGxlY3RlZC5cXG4iCmZp\"\n          ],\n          \"SubnetId\": [\n            \"{{ SubnetId }}\"\n          ],\n          \"CreatePreEC2RescueBackup\": [\n            \"True\"\n          ],\n          \"S3BucketName\": [\n            \"{{ LogDestination }}\"\n          ],\n          \"S3Prefix\": [\n            \"AWSSupport-ExecuteEC2Rescue\"\n          ],\n          \"UniqueId\": \"{{ automation:EXECUTION_ID }}\"\n        },\n        \"DocumentName\": \"AWSSupport-StartEC2RescueWorkflow\"\n      },\n      \"isCritical\": \"true\",\n      \"nextStep\": \"getLinuxBackupAmi\"\n    },\n    {\n      \"name\": \"getLinuxBackupAmi\",\n      \"action\": \"aws:executeAwsApi\",\n      \"onFailure\": \"Continue\",\n      \"inputs\": {\n        \"Service\": \"ssm\",\n        \"Api\": \"GetAutomationExecution\",\n        \"AutomationExecutionId\": \"{{ runEC2RescueForLinux.ExecutionId }}\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"ImageId\",\n          \"Selector\": \"$.AutomationExecution.Outputs.'preScriptBackup.ImageId'[0]\",\n          \"Type\": \"String\"\n        }\n      ],\n      \"isCritical\": \"false\",\n      \"nextStep\": \"getEC2RescueForLinuxResult\"\n    },\n    {\n      \"name\": \"getEC2RescueForLinuxResult\",\n      \"action\": \"aws:executeAwsApi\",\n      \"onFailure\": \"Abort\",\n      \"inputs\": {\n        \"Service\": \"ssm\",\n        \"Api\": \"GetAutomationExecution\",\n        \"AutomationExecutionId\": \"{{ runEC2RescueForLinux.ExecutionId }}\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"Output\",\n          \"Selector\": \"$.AutomationExecution.Outputs.'runScriptForLinux.Output'[0]\",\n          \"Type\": \"String\"\n        }\n      ],\n      \"isCritical\": \"false\",\n      \"isEnd\": \"true\"\n    }\n  ],\n  \"outputs\": [\n    \"getEC2RescueForWindowsResult.Output\",\n    \"getWindowsBackupAmi.ImageId\",\n    \"getEC2RescueForLinuxResult.Output\",\n    \"getLinuxBackupAmi.ImageId\"\n  ]\n}",
  "CreatedDate": "2018-09-21T23:39:49.449Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Automation"
  },
  "DocumentVersion": "13",
  "Name": "AWSSupport-ExecuteEC2Rescue",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "d440c8b8-cb1e-4c5f-967d-7d0c4f036946",
    "Metadata": {},
    "ChecksumAlgorithm": 0,
    "ChecksumValidationStatus": 0
  },
  "ContentLength": 11754,
  "HttpStatusCode": 200,
  "LoggedAt": "2022-10-07T07:23:14.6461794+00:00"
}
