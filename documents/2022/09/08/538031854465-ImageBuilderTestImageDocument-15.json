{
  "AttachmentsContent": [],
  "Content": "{\"schemaVersion\": \"0.3\", \"description\": \"A composite document for testing image with Image Builder\", \"parameters\": {\"arn\": {\"type\": \"String\", \"description\": \"The Image ARN\"}, \"platform\": {\"type\": \"String\", \"description\": \"The Image platform\"}, \"s3LogsBucketName\": {\"type\": \"String\", \"default\": \"imagebuilder-placeholder\"}, \"s3LogsKeyPrefix\": {\"type\": \"String\", \"default\": \"ImageBuilder-{{automation:EXECUTION_ID}}\"}, \"cloudWatchLogGroup\": {\"type\": \"String\"}, \"cloudWatchLogStream\": {\"type\": \"String\"}, \"imageVersionNumber\": {\"type\": \"String\", \"description\": \"The image version number\"}, \"imageBuildNumber\": {\"type\": \"String\", \"description\": \"The image build number\"}, \"isBuildWorkflow\": {\"type\": \"Boolean\", \"default\": false}, \"isTestWorkflow\": {\"type\": \"Boolean\", \"default\": false}, \"instanceId\": {\"type\": \"String\", \"description\": \"(Required) Launched Instance Id\"}, \"runCommandDocument\": {\"type\": \"String\"}, \"testCommands\": {\"type\": \"String\", \"description\": \"The commands used to test an image.\"}, \"workingDirectory\": {\"type\": \"String\"}, \"imageName\": {\"type\": \"String\", \"description\": \"(Optional) An image name\", \"default\": \"{{imageName}}/{{imageVersionNumber}}/{{imageBuildNumber}}\"}, \"terminateInstanceOnFailure\": {\"type\": \"Boolean\", \"description\": \"(Optional) Terminate the instance when build failed\", \"default\": true}}, \"mainSteps\": [{\"name\": \"WaitForInstanceToSpinUp\", \"action\": \"aws:waitForAwsResourceProperty\", \"onFailure\": \"step:WaitBeforeDescribingInstanceAgain\", \"timeoutSeconds\": 600, \"isCritical\": false, \"maxAttempts\": 3, \"nextStep\": \"VerifySSMAgentBranch\", \"inputs\": {\"Service\": \"ec2\", \"Api\": \"DescribeInstanceStatus\", \"InstanceIds\": [\"{{instanceId}}\"], \"PropertySelector\": \"$.InstanceStatuses[0].InstanceStatus.Details[0].Status\", \"DesiredValues\": [\"passed\"]}}, {\"name\": \"WaitBeforeDescribingInstanceAgain\", \"action\": \"aws:sleep\", \"maxAttempts\": 3, \"onFailure\": \"step:FailureHandling\", \"nextStep\": \"WaitForInstanceToSpinUpRetry\", \"inputs\": {\"Duration\": \"PT2M\"}}, {\"name\": \"WaitForInstanceToSpinUpRetry\", \"action\": \"aws:waitForAwsResourceProperty\", \"onFailure\": \"step:FailureHandling\", \"timeoutSeconds\": 600, \"maxAttempts\": 3, \"inputs\": {\"Service\": \"ec2\", \"Api\": \"DescribeInstanceStatus\", \"InstanceIds\": [\"{{instanceId}}\"], \"PropertySelector\": \"$.InstanceStatuses[0].InstanceStatus.Details[0].Status\", \"DesiredValues\": [\"passed\"]}}, {\"name\": \"VerifySSMAgentBranch\", \"action\": \"aws:branch\", \"inputs\": {\"Choices\": [{\"NextStep\": \"VerifySSMAgentLinux\", \"Variable\": \"{{platform}}\", \"StringEquals\": \"Linux\"}], \"Default\": \"VerifySSMAgentWindows\"}}, {\"name\": \"VerifySSMAgentLinux\", \"action\": \"aws:runCommand\", \"maxAttempts\": 3, \"timeoutSeconds\": 300, \"onFailure\": \"step:FailureHandling\", \"inputs\": {\"InstanceIds\": [\"{{instanceId}}\"], \"DocumentName\": \"{{runCommandDocument}}\", \"Parameters\": {\"workingDirectory\": \"{{workingDirectory}}\", \"commands\": [\"echo \\\"SSM Agent (Linux) is ready\\\"\\n\"], \"executionTimeout\": \"300\"}}, \"nextStep\": \"EndOfVerifySSMAgentBranch\"}, {\"name\": \"VerifySSMAgentWindows\", \"action\": \"aws:runCommand\", \"maxAttempts\": 3, \"timeoutSeconds\": 300, \"onFailure\": \"step:FailureHandling\", \"inputs\": {\"InstanceIds\": [\"{{instanceId}}\"], \"DocumentName\": \"{{runCommandDocument}}\", \"Parameters\": {\"workingDirectory\": \"{{workingDirectory}}\", \"commands\": [\"Write-Host \\\"SSM Agent (Windows) is ready\\\"\\n\"], \"executionTimeout\": \"300\"}}, \"nextStep\": \"EndOfVerifySSMAgentBranch\"}, {\"name\": \"EndOfVerifySSMAgentBranch\", \"action\": \"aws:sleep\", \"maxAttempts\": 3, \"onFailure\": \"step:FailureHandling\", \"inputs\": {\"Duration\": \"PT5S\"}}, {\"name\": \"RunTestsBranch\", \"action\": \"aws:branch\", \"inputs\": {\"Choices\": [{\"NextStep\": \"RunTestsWithoutLogging\", \"Variable\": \"{{s3LogsBucketName}}\", \"StringEquals\": \"imagebuilder-placeholder\"}], \"Default\": \"RunTestsWithLogging\"}}, {\"name\": \"RunTestsWithLogging\", \"action\": \"aws:runCommand\", \"maxAttempts\": 3, \"timeoutSeconds\": 43200, \"onFailure\": \"step:FailureHandling\", \"inputs\": {\"InstanceIds\": [\"{{instanceId}}\"], \"DocumentName\": \"{{runCommandDocument}}\", \"Parameters\": {\"workingDirectory\": \"{{workingDirectory}}\", \"executionTimeout\": \"43200\", \"commands\": \"{{testCommands}}\"}, \"OutputS3BucketName\": \"{{s3LogsBucketName}}\", \"OutputS3KeyPrefix\": \"{{s3LogsKeyPrefix}}/{{imageName}}/{{imageVersionNumber}}/{{imageBuildNumber}}/Automations/RunTests\"}, \"nextStep\": \"EndOfRunTestsBranch\"}, {\"name\": \"RunTestsWithoutLogging\", \"action\": \"aws:runCommand\", \"maxAttempts\": 3, \"timeoutSeconds\": 43200, \"onFailure\": \"step:FailureHandling\", \"inputs\": {\"InstanceIds\": [\"{{instanceId}}\"], \"DocumentName\": \"{{runCommandDocument}}\", \"Parameters\": {\"workingDirectory\": \"{{workingDirectory}}\", \"executionTimeout\": \"43200\", \"commands\": \"{{testCommands}}\"}}, \"nextStep\": \"EndOfRunTestsBranch\"}, {\"name\": \"EndOfRunTestsBranch\", \"action\": \"aws:sleep\", \"maxAttempts\": 3, \"onFailure\": \"step:FailureHandling\", \"inputs\": {\"Duration\": \"PT5S\"}}, {\"name\": \"StopInstance\", \"action\": \"aws:changeInstanceState\", \"maxAttempts\": 3, \"onFailure\": \"step:FailureHandling\", \"inputs\": {\"InstanceIds\": [\"{{instanceId}}\"], \"DesiredState\": \"stopped\"}}, {\"name\": \"VerifyBranch\", \"action\": \"aws:branch\", \"inputs\": {\"Choices\": [{\"NextStep\": \"VerifyImage\", \"Variable\": \"{{isBuildWorkflow}}\", \"BooleanEquals\": true}, {\"NextStep\": \"TerminateInstanceOnSuccess\", \"Variable\": \"{{isTestWorkflow}}\", \"BooleanEquals\": true}], \"Default\": \"EndOfVerifyBranch\"}}, {\"name\": \"VerifyImage\", \"action\": \"aws:waitForAwsResourceProperty\", \"isCritical\": true, \"onFailure\": \"step:FailureHandling\", \"nextStep\": \"GetImageState\", \"timeoutSeconds\": 14400, \"maxAttempts\": 3, \"inputs\": {\"Service\": \"ec2\", \"Api\": \"DescribeImages\", \"Filters\": [{\"Name\": \"image-id\", \"Values\": [\"{{CreateImage.ImageId}}\"]}], \"Owners\": [\"self\"], \"PropertySelector\": \"$.Images[0].State\", \"DesiredValues\": [\"available\", \"failed\", \"error\"]}}, {\"name\": \"GetImageState\", \"action\": \"aws:assertAwsResourceProperty\", \"isCritical\": true, \"onFailure\": \"step:FailureHandling\", \"nextStep\": \"TerminateInstanceOnSuccess\", \"maxAttempts\": 3, \"inputs\": {\"Service\": \"ec2\", \"Api\": \"DescribeImages\", \"Filters\": [{\"Name\": \"image-id\", \"Values\": [\"{{CreateImage.ImageId}}\"]}], \"Owners\": [\"self\"], \"PropertySelector\": \"$.Images[0].State\", \"DesiredValues\": [\"available\"]}}, {\"name\": \"TerminateInstanceOnSuccess\", \"action\": \"aws:changeInstanceState\", \"maxAttempts\": 3, \"isCritical\": false, \"onFailure\": \"Continue\", \"inputs\": {\"InstanceIds\": [\"{{ instanceId }}\"], \"DesiredState\": \"terminated\"}}, {\"name\": \"EndOfVerifyBranch\", \"action\": \"aws:sleep\", \"maxAttempts\": 3, \"isCritical\": false, \"isEnd\": true, \"onFailure\": \"Continue\", \"inputs\": {\"Duration\": \"PT5S\"}}, {\"name\": \"FailureHandling\", \"action\": \"aws:branch\", \"inputs\": {\"Choices\": [{\"NextStep\": \"DeleteInventoryAssociationOnFailure\", \"Variable\": \"{{terminateInstanceOnFailure}}\", \"BooleanEquals\": true}], \"Default\": \"EndOfFailureHandling\"}}, {\"name\": \"DeleteInventoryAssociationOnFailure\", \"action\": \"aws:executeAwsApi\", \"maxAttempts\": 3, \"isCritical\": false, \"onFailure\": \"Continue\", \"nextStep\": \"TerminateInstanceOnFailure\", \"inputs\": {\"Service\": \"ssm\", \"Api\": \"DeleteAssociation\", \"AssociationId\": \"{{ CreateInventory.AssociationId }}\"}}, {\"name\": \"TerminateInstanceOnFailure\", \"action\": \"aws:changeInstanceState\", \"maxAttempts\": 3, \"isCritical\": false, \"onFailure\": \"Continue\", \"nextStep\": \"EndOfFailureHandling\", \"inputs\": {\"InstanceIds\": [\"{{ instanceId }}\"], \"DesiredState\": \"terminated\"}}, {\"name\": \"EndOfFailureHandling\", \"action\": \"aws:sleep\", \"maxAttempts\": 3, \"isCritical\": false, \"isEnd\": true, \"onFailure\": \"Continue\", \"inputs\": {\"Duration\": \"PT5S\"}}]}",
  "CreatedDate": "2021-10-14T15:13:16.548Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Automation"
  },
  "DocumentVersion": "15",
  "Name": "arn:aws:ssm:us-west-2:538031854465:document/ImageBuilderTestImageDocument",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "84ef3ffc-a73d-4411-8fda-7013756665b5",
    "Metadata": {},
    "ChecksumAlgorithm": 0,
    "ChecksumValidationStatus": 0
  },
  "ContentLength": 8645,
  "HttpStatusCode": 200,
  "LoggedAt": "2022-09-08T07:29:41.9141448+00:00"
}
