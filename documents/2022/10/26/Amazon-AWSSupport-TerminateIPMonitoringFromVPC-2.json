{
  "AttachmentsContent": [],
  "Content": "{\n  \"schemaVersion\": \"0.3\",\n  \"description\": \"AWSSupport-TerminateIPMonitoringFromVPC terminates an IP monitoring test previously started by AWSSupport-SetupIPMonitoringFromVPC. Data related to the specified test ID will be deleted.\",\n  \"assumeRole\": \"{{ AutomationAssumeRole }}\",\n  \"parameters\": {\n    \"AutomationExecutionId\": {\n      \"type\": \"String\",\n      \"description\": \"(Required) AWSSupport-SetupIPMonitoringFromVPC automation execution ID of the test you want to terminate.\"\n    },\n    \"SubnetId\": {\n      \"type\": \"String\",\n      \"description\": \"(Required) The subnet ID for the monitor instance.\",\n      \"allowedPattern\": \"^subnet-[a-z0-9]{8,17}$\"\n    },\n    \"InstanceId\": {\n      \"type\": \"String\",\n      \"description\": \"(Required) The instance ID for the monitor instance.\",\n      \"allowedPattern\": \"^i-[a-z0-9]{8,17}$\"\n    },\n    \"AutomationAssumeRole\": {\n      \"type\": \"String\",\n      \"description\": \"(Optional) The IAM role for this execution. If no role is specified, AWS Systems Manager Automation will use the permissions of the user that executes this document.\",\n      \"default\": \"\"\n    }\n  },\n  \"mainSteps\": [\n    {\n      \"name\": \"assertInstanceIdIsAssociatedToTest\",\n      \"action\": \"aws:assertAwsResourceProperty\",\n      \"onFailure\": \"Abort\",\n      \"inputs\": {\n        \"Service\": \"ec2\",\n        \"Api\": \"DescribeTags\",\n        \"Filters\": [\n          {\n            \"Name\": \"tag:AutomationExecutionId\",\n            \"Values\": [\n              \"{{ AutomationExecutionId }}\"\n            ]\n          }\n        ],\n        \"PropertySelector\": \"$.Tags[0].ResourceId\",\n        \"DesiredValues\": [\n          \"{{ InstanceId }}\"\n        ]\n      },\n      \"isCritical\": \"true\",\n      \"nextStep\": \"assertSubnetIdIsAssociatedToTest\"\n    },\n    {\n      \"name\": \"assertSubnetIdIsAssociatedToTest\",\n      \"action\": \"aws:assertAwsResourceProperty\",\n      \"onFailure\": \"Abort\",\n      \"inputs\": {\n        \"Service\": \"ec2\",\n        \"Api\": \"DescribeInstances\",\n        \"InstanceIds\": [\n          \"{{ InstanceId }}\"\n        ],\n        \"PropertySelector\": \"$.Reservations[0].Instances[0].SubnetId\",\n        \"DesiredValues\": [\n          \"{{ SubnetId }}\"\n        ]\n      },\n      \"isCritical\": \"true\",\n      \"nextStep\": \"describeTestSecurityGroup\"\n    },\n    {\n      \"name\": \"describeTestSecurityGroup\",\n      \"action\": \"aws:executeAwsApi\",\n      \"onFailure\": \"Continue\",\n      \"inputs\": {\n        \"Service\": \"ec2\",\n        \"Api\": \"DescribeSecurityGroups\",\n        \"Filters\": [\n          {\n            \"Name\": \"group-name\",\n            \"Values\": [\n              \"SetupIPMonitoringFromVPC_{{ AutomationExecutionId }}\"\n            ]\n          }\n        ]\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"GroupId\",\n          \"Selector\": \"$.SecurityGroups[0].GroupId\"\n        }\n      ],\n      \"isCritical\": \"true\",\n      \"nextStep\": \"deleteDashboard\"\n    },\n    {\n      \"name\": \"deleteDashboard\",\n      \"action\": \"aws:executeAwsApi\",\n      \"onFailure\": \"Continue\",\n      \"inputs\": {\n        \"Service\": \"cloudwatch\",\n        \"Api\": \"DeleteDashboards\",\n        \"DashboardNames\": [\n          \"{{ SubnetId }}_{{ InstanceId }}\"\n        ]\n      },\n      \"isCritical\": \"true\",\n      \"nextStep\": \"terminateInstance\"\n    },\n    {\n      \"name\": \"terminateInstance\",\n      \"action\": \"aws:changeInstanceState\",\n      \"onFailure\": \"Continue\",\n      \"inputs\": {\n        \"InstanceIds\": [\n          \"{{ InstanceId }}\"\n        ],\n        \"CheckStateOnly\": false,\n        \"DesiredState\": \"terminated\"\n      },\n      \"isCritical\": \"true\",\n      \"nextStep\": \"removeIAMRoleFromInstanceProfile\"\n    },\n    {\n      \"name\": \"removeIAMRoleFromInstanceProfile\",\n      \"action\": \"aws:executeAwsApi\",\n      \"onFailure\": \"Continue\",\n      \"inputs\": {\n        \"Service\": \"iam\",\n        \"Api\": \"RemoveRoleFromInstanceProfile\",\n        \"RoleName\": \"SetupIPMonitoringFromVPC_{{ AutomationExecutionId }}\",\n        \"InstanceProfileName\": \"SetupIPMonitoringFromVPC_{{ AutomationExecutionId }}\"\n      },\n      \"isCritical\": \"true\",\n      \"nextStep\": \"deleteIAMInstanceProfile\"\n    },\n    {\n      \"name\": \"deleteIAMInstanceProfile\",\n      \"action\": \"aws:executeAwsApi\",\n      \"onFailure\": \"Continue\",\n      \"inputs\": {\n        \"Service\": \"iam\",\n        \"Api\": \"DeleteInstanceProfile\",\n        \"InstanceProfileName\": \"SetupIPMonitoringFromVPC_{{ AutomationExecutionId }}\"\n      },\n      \"isCritical\": \"true\",\n      \"nextStep\": \"removeCloudWatchInlinePolicyFromEC2Role\"\n    },\n    {\n      \"name\": \"removeCloudWatchInlinePolicyFromEC2Role\",\n      \"action\": \"aws:executeAwsApi\",\n      \"onFailure\": \"Continue\",\n      \"inputs\": {\n        \"Service\": \"iam\",\n        \"Api\": \"DeleteRolePolicy\",\n        \"RoleName\": \"SetupIPMonitoringFromVPC_{{ AutomationExecutionId }}\",\n        \"PolicyName\": \"SetupIPMonitoringFromVPC_CWPermissions\"\n      },\n      \"isCritical\": \"true\",\n      \"nextStep\": \"detachSSMManagedPolicyFromEC2Role\"\n    },\n    {\n      \"name\": \"detachSSMManagedPolicyFromEC2Role\",\n      \"action\": \"aws:executeAwsApi\",\n      \"onFailure\": \"Continue\",\n      \"inputs\": {\n        \"Service\": \"iam\",\n        \"Api\": \"DetachRolePolicy\",\n        \"PolicyArn\": \"arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore\",\n        \"RoleName\": \"SetupIPMonitoringFromVPC_{{ AutomationExecutionId }}\"\n      },\n      \"isCritical\": \"true\",\n      \"nextStep\": \"deleteEC2Role\"\n    },\n    {\n      \"name\": \"deleteEC2Role\",\n      \"action\": \"aws:executeAwsApi\",\n      \"onFailure\": \"Continue\",\n      \"inputs\": {\n        \"Service\": \"iam\",\n        \"Api\": \"DeleteRole\",\n        \"RoleName\": \"SetupIPMonitoringFromVPC_{{ AutomationExecutionId }}\"\n      },\n      \"isCritical\": \"true\",\n      \"nextStep\": \"deleteSecurityGroup\"\n    },\n    {\n      \"name\": \"deleteSecurityGroup\",\n      \"action\": \"aws:executeAwsApi\",\n      \"onFailure\": \"Continue\",\n      \"inputs\": {\n        \"Service\": \"ec2\",\n        \"Api\": \"DeleteSecurityGroup\",\n        \"GroupId\": \"{{ describeTestSecurityGroup.GroupId }}\"\n      },\n      \"isCritical\": \"true\",\n      \"isEnd\": \"true\"\n    }\n  ]\n}",
  "CreatedDate": "2019-10-25T18:13:48.014Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Automation"
  },
  "DocumentVersion": "2",
  "Name": "AWSSupport-TerminateIPMonitoringFromVPC",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "282aa69c-7eb6-487f-868e-bd2d590377a6",
    "Metadata": {},
    "ChecksumAlgorithm": 0,
    "ChecksumValidationStatus": 0
  },
  "ContentLength": 6844,
  "HttpStatusCode": 200,
  "LoggedAt": "2022-10-26T07:17:00.0572514+00:00"
}
