{
  "AttachmentsContent": [],
  "Content": "{  \r\n    \"schemaVersion\":\"2.2\",\r\n    \"description\":\"Performs sysprep on Windows Server 2008 SP2 and above.  Does not shutdown the instance.\",\r\n    \"parameters\":{  \r\n       \"Id\":{  \r\n          \"type\":\"String\",\r\n          \"description\":\"(Optional) A user specified ID for the execution of sysprep.\",\r\n          \"default\":\"\"\r\n       }\r\n    },\r\n    \"mainSteps\":[  \r\n       {  \r\n          \"action\":\"aws:runPowerShellScript\",\r\n          \"name\":\"RunSysprep\",\r\n          \"precondition\":{  \r\n             \"StringEquals\":[  \r\n                \"platformType\",\r\n                \"Windows\"\r\n             ]\r\n          },\r\n          \"inputs\":{  \r\n             \"timeoutSeconds\":14400,\r\n             \"runCommand\":[  \r\n                \"\",\r\n                \"$zipFilename = 'AWSUpdateWindowsInstance_1_4_0_0.zip'\",\r\n                \"$zipFileHash = 'B32D397AAA312E5EB0B2E0E0BC7146FB716AED3867A73FA650E0F222DF1079AE'\",\r\n                \"$moduleName = 'AWSUpdateWindowsInstance'\",\r\n                \"$tempPath = $env:TEMP\",\r\n                \"$moduleDirectory = Join-Path $tempPath -ChildPath $moduleName\",\r\n                \"$moduleZipFilePath = Join-Path $tempPath -ChildPath $zipFilename\",\r\n                \"$moduleManifestPath = Join-Path $moduleDirectory -ChildPath ('{0}.psd1' -f $moduleName)\",\r\n                \"$id = '{{Id}}'\",\r\n                \"\",\r\n                \"function Main {\",\r\n                \"  Test-PreCondition\",\r\n                \"  Clear-WindowsUpdateModule\",\r\n                \"  Get-WindowsUpdateModule\",\r\n                \"  Expand-WindowsUpdateModule\",\r\n                \"  Invoke-RunSysprep\",\r\n                \"}\",\r\n                \"function Test-PreCondition {\",\r\n                \"  $osversion = [Environment]::OSVersion.Version\",\r\n                \"  if ($osversion.Major -le 5) {\",\r\n                \"    Write-Host 'This document is not supported on Windows Server 2003 or earlier.'\",\r\n                \"    Exit -1\",\r\n                \"  }\",\r\n                \"\",\r\n                \"  if ($osversion.Version -ge '10.0') {\",\r\n                \"    $sku = (Get-CimInstance -ClassName Win32_OperatingSystem).OperatingSystemSKU\",\r\n                \"    if ($sku -eq 143 -or $sku -eq 144) {\",\r\n                \"        Write-Host 'This document is not supported on Windows 2016 Nano Server.'\",\r\n                \"        Exit -1\",\r\n                \"    }\",\r\n                \"  }\",\r\n                \"}\",\r\n                \"\",\r\n                \"function Clear-WindowsUpdateModule {\",\r\n                \"  try {\",\r\n                \"    if (Test-Path $moduleDirectory) {\",\r\n                \"      Remove-Item $moduleDirectory -Force -Recurse\",\r\n                \"    }\",\r\n                \"    if (Test-Path $moduleZipFilePath) {\",\r\n                \"      Remove-Item $moduleZipFilePath -Force\",\r\n                \"    }\",\r\n                \"  } catch {\",\r\n                \"    Write-Host \\\"Cleaning Windows update module resulted in error: $($_)\\\"\",\r\n                \"  }\",\r\n                \"}\",\r\n                \"\",\r\n                \"function Get-WindowsUpdateModule {\",\r\n                \"  try {\",\r\n                \"    $region = 'us-east-1'\",\r\n                \"    $ssmAgentService = Get-ItemProperty 'HKLM:SYSTEM\\\\CurrentControlSet\\\\Services\\\\AmazonSSMAgent\\\\' -ErrorAction SilentlyContinue\",\r\n                \"    if($ssmAgentService -and $ssmAgentService.Version -ge '2.0.533.0') {\",\r\n                \"      $region = $env:AWS_SSM_REGION_NAME\",\r\n                \"    }\",\r\n                \"\",\r\n                \"    if ($region.StartsWith('cn-')) {\",\r\n                \"      $s3Location = 'https://s3.{0}.amazonaws.com.cn/aws-windows-downloads-{0}/PSModules/AWSUpdateWindowsInstance/{1}'\",\r\n                \"    } elseif($region.StartsWith('us-gov-')) {\",\r\n                \"      $s3Location = 'https://s3-fips-{0}.amazonaws.com/aws-windows-downloads-{0}/PSModules/AWSUpdateWindowsInstance/{1}'\",\r\n                \"    } elseif($region -eq 'us-east-1') {\",\r\n                \"      $s3Location = 'https://s3.amazonaws.com/aws-windows-downloads-{0}/PSModules/AWSUpdateWindowsInstance/{1}'\",\r\n                \"    } else {\",\r\n                \"      $s3Location = 'https://aws-windows-downloads-{0}.s3.amazonaws.com/PSModules/AWSUpdateWindowsInstance/{1}'\",\r\n                \"    }\",\r\n                \"\",\r\n                \"    $moduleS3Location = $s3Location -f $region, $zipFilename\",\r\n                \"    $moduleLocalPath = Join-Path $tempPath -ChildPath $zipFilename\",\r\n                \"    (New-Object Net.WebClient).DownloadFile($moduleS3Location, $moduleLocalPath)\",\r\n                \"\",\r\n                \"    $fileStream = New-Object System.IO.FileStream($moduleLocalPath, [System.IO.FileMode]::Open, [System.IO.FileAccess]::Read)\",\r\n                \"    $sha256 = [System.Security.Cryptography.HashAlgorithm]::Create('System.Security.Cryptography.SHA256CryptoServiceProvider')\",\r\n                \"    $currentHash = [System.BitConverter]::ToString($sha256.ComputeHash($fileStream), 0).Replace('-', '').ToLowerInvariant()\",\r\n                \"    $sha256.Dispose()\",\r\n                \"    $fileStream.Dispose()\",\r\n                \"\",\r\n                \"    if ($currentHash -ne $zipFileHash) {\",\r\n                \"      Write-Host 'The SHA hash of the module does not match the expected value.'\",\r\n                \"        Exit -1\",\r\n                \"      }\",\r\n                \"    } catch {\",\r\n                \"      Write-Host ('Error encountered while getting the module: {0}.' -f $_.Exception.Message)\",\r\n                \"      Exit -1\",\r\n                \"    }\",\r\n                \"}\",\r\n                \"\",\r\n                \"function Expand-WindowsUpdateModule {\",\r\n                \"  try {\",\r\n                \"    [System.Reflection.Assembly]::LoadWithPartialName('System.IO.Compression.FileSystem') | Out-Null\",\r\n                \"    $zip = [System.IO.Compression.ZipFile]::OpenRead($moduleZipFilePath)\",\r\n                \"    foreach ($item in $zip.Entries) {\",\r\n                \"      $extractPath = Join-Path $tempPath -ChildPath $item.FullName\",\r\n                \"      if ($item.Length -eq 0) {\",\r\n                \"        if (-not (Test-Path $extractPath)) {\",\r\n                \"          New-Item $extractPath -ItemType Directory | Out-Null\",\r\n                \"        }\",\r\n                \"      } else {\",\r\n                \"        $parentPath = Split-Path $extractPath\",\r\n                \"        if (-not (Test-Path $parentPath)) {\",\r\n                \"          New-Item $parentPath -ItemType Directory | Out-Null\",\r\n                \"        }\",\r\n                \"          [System.IO.Compression.ZipFileExtensions]::ExtractToFile($item, $extractPath, $true)\",\r\n                \"      }\",\r\n                \"    }\",\r\n                \"  } catch {\",\r\n                \"    Write-Host ('Error encountered when extracting module file: {0}.' -f $_.Exception.Message)\",\r\n                \"    Exit -1\",\r\n                \"  } finally {\",\r\n                \"    $zip.Dispose()\",\r\n                \"  }\",\r\n                \"}\",\r\n                \"\",\r\n                \"function Invoke-RunSysprep {\",\r\n                \"  Import-Module $moduleManifestPath\",\r\n                \"  $command = 'Start-AwsUwiSysprep'\",\r\n                \"  if($id) { $command += \\\" -Id $($id)\\\"}\",\r\n                \"  Invoke-Expression $command\",\r\n                \"}\",\r\n                \"\",\r\n                \"Main\"\r\n             ]\r\n          }\r\n       }\r\n    ]\r\n }\r\n",
  "CreatedDate": "2017-11-02T18:21:29.923Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Command"
  },
  "DocumentVersion": "1",
  "Name": "arn:aws:ssm:us-west-2:495229798761:document/AWSWindows-RunSysprep",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "c6a863ef-b7fa-4634-b234-ca702e322408",
    "Metadata": {},
    "ChecksumAlgorithm": 0,
    "ChecksumValidationStatus": 0
  },
  "ContentLength": 8224,
  "HttpStatusCode": 200,
  "LoggedAt": "2023-03-24T07:11:42.5724038+00:00"
}
