{
  "AttachmentsContent": [],
  "Content": "{\n  \"description\" : \"## Id\\nAWSResilienceHub-RestoreDynamoDBTableFromBackupSOP_2020-04-01\\n\\n## Intent\\nRecover the table into a known good state using existing backup of a DynamoDB table.\\n\\n## Type\\nSOP\\n\\n## Risk\\nSmall\\n\\n## Requirements\\n  * DynamoDB table\\n  * DynamoDB table backup\\n\\n## Permissions required for AutomationAssumeRole\\n  * dynamodb:RestoreTableFromBackup\\n  * dynamodb:DescribeTable\\n  * dynamodb:Scan\\n  * dynamodb:Query\\n  * dynamodb:UpdateItem\\n  * dynamodb:PutItem\\n  * dynamodb:GetItem\\n  * dynamodb:DeleteItem\\n  * dynamodb:BatchWriteItem\\n\\n##### Permissions required in case Kinesis Streaming destination is enabled\\n  * kinesis:DescribeStream\\n  * kinesis:PutRecord\\n  * kinesis:PutRecords\\n\\n##### Permissions required to copy properties from source to restored table if `CopyAllProperties` option is enabled\\n  * dynamodb:UpdateTable\\n  * ssm:GetAutomationExecution\\n  * ssm:StartAutomationExecution\\n  * dynamodb:CreateTableReplica\\n  * dynamodb:CreateTable\\n  * dynamodb:DescribeKinesisStreamingDestination\\n  * dynamodb:EnableKinesisStreamingDestination\\n  * dynamodb:DescribeTimeToLive\\n  * dynamodb:UpdateTimeToLive\\n  * dynamodb:ListTagsOfResource\\n  * dynamodb:TagResource\\n  * dynamodb:DescribeContributorInsights\\n  * dynamodb:UpdateContributorInsights\\n  * dynamodb:DescribeContinuousBackups\\n  * dynamodb:UpdateContinuousBackups\\n  * application-autoscaling:DescribeScalableTargets\\n  * application-autoscaling:RegisterScalableTarget\\n  * iam:PassRole (passed to application-autoscaling.amazonaws.com)\\n  * cloudwatch:DescribeAlarms\\n  * cloudwatch:PutMetricAlarm\\n\\n## Depends on\\nAWSResilienceHub-CopyDynamoDBTablePropertiesUtil_2020-04-01\\n\\n## Cancellation behavior\\nFail\\n\\n## Inputs\\n### (Required) AutomationAssumeRole\\n  * type: String\\n  * description: The Amazon Resource Name (ARN) of the IAM role with permissions listed above.\\n\\n### (Required) DynamoDBTableSourceName\\n  * type: String\\n  * description: The name of the source DynamoDB Table.\\n\\n### (Required) DynamoDBSourceTableBackupArn\\n  * type: String\\n  * description: The backup Amazon Resource Name (ARN) of the source DynamoDB Table.\\n\\n### (Required) DynamoDBTableTargetName\\n  * type: String\\n  * description: The name of the tagret DynamoDB Table.\\n\\n### (Optional) CopyAllProperties\\n  * type: Boolean\\n  * description: True of False. If true copies all the settings from the source table to the restored one.\\n  * default: True\\n\\n### (Optional) DynamoDBSourceTableAlarmNames\\n  * type: StringList\\n  * description: Alarm names of the DynamoDB table to recover (only metric alarms based on metrics with AWS or DynamoDB namespace).\\n  * max items: 10\\n  * default: []\\n\\n## Details\\nThis document creates a DynamoDB table from backup, waits for the table to become active, and if\\n`CopyAllProperties` is set to true copies all possible properties from the source table to the restored\\none. If `DynamoDBSourceTableAlarmNames` is provided copies the specified alarms from the source table. \\nNote that triggers and IAM policy can't be copied from source. Item count doesn't appear\\nimmediately because DynamoDB updates this value every 6 hours.\\n\\n## Steps executed in normal flow\\n  * RecordStartTime\\n  * RestoreDynamoDBTableFromBackup\\n  * WaitTableToBeActive\\n  * CheckIfNeedToCopyAllProperties\\n  * CopyAllTableProperties\\n  * OutputRecoveryTime\\n\\n## Outputs\\n### RestoreDynamoDBTableFromBackup.TargetTableArn\\n  * type: String\\n  * description: Amazon Resource Name (ARN) of the restored table.\\n\\n### RestoreDynamoDBTableFromBackup.RecoveryPoint\\n  * type: String\\n  * description: Timestamp of the backup used to restore.\\n\\n### OutputRecoveryTime.RecoveryTime\\n  * type: Integer\\n  * description: Time in seconds to recover.\",\n  \"schemaVersion\" : \"0.3\",\n  \"assumeRole\" : \"{{ AutomationAssumeRole }}\",\n  \"parameters\" : {\n    \"DynamoDBTableSourceName\" : {\n      \"type\" : \"String\",\n      \"description\" : \"(Required) The name of the source DynamoDB Table.\"\n    },\n    \"DynamoDBSourceTableBackupArn\" : {\n      \"type\" : \"String\",\n      \"description\" : \"(Required) The backup ARN of the source DynamoDB Table.\"\n    },\n    \"DynamoDBTableTargetName\" : {\n      \"type\" : \"String\",\n      \"description\" : \"(Required) The name of the tagret DynamoDB Table.\"\n    },\n    \"CopyAllProperties\" : {\n      \"type\" : \"Boolean\",\n      \"description\" : \"(Optional) If true copies all the settings from the source table to the restored one.\",\n      \"default\" : true\n    },\n    \"DynamoDBSourceTableAlarmNames\" : {\n      \"type\" : \"StringList\",\n      \"description\" : \"(Optional) Alarm names of the DynamoDB table to recover (only metric alarms based on metrics with AWS or DynamoDB namespace).\",\n      \"maxItems\" : 10,\n      \"default\" : [ ]\n    },\n    \"AutomationAssumeRole\" : {\n      \"type\" : \"String\",\n      \"description\" : \"(Required) The ARN of the role that allows Automation to perform the actions on your behalf.\"\n    }\n  },\n  \"outputs\" : [ \"RestoreDynamoDBTableFromBackup.TargetTableArn\", \"RestoreDynamoDBTableFromBackup.RecoveryPoint\", \"OutputRecoveryTime.RecoveryTime\" ],\n  \"mainSteps\" : [ {\n    \"name\" : \"RecordStartTime\",\n    \"description\" : \"Start recording execution time\",\n    \"action\" : \"aws:executeScript\",\n    \"outputs\" : [ {\n      \"Name\" : \"StartTime\",\n      \"Selector\" : \"$.Payload\",\n      \"Type\" : \"String\"\n    } ],\n    \"inputs\" : {\n      \"Runtime\" : \"python3.8\",\n      \"Handler\" : \"start_time\",\n      \"Script\" : \"import logging\\nimport time\\nfrom datetime import datetime, timezone\\n\\nimport boto3\\nfrom botocore.exceptions import ClientError\\nfrom dateutil import parser\\n\\nlogger = logging.getLogger()\\nlogger.setLevel(logging.INFO)\\n\\n\\n\\ndef start_time(events, context):\\n    return datetime.now(timezone.utc).isoformat()\"\n    }\n  }, {\n    \"name\" : \"RestoreDynamoDBTableFromBackup\",\n    \"description\" : \"Restore table from backup\",\n    \"action\" : \"aws:executeAwsApi\",\n    \"maxAttempts\" : 3,\n    \"onFailure\" : \"Abort\",\n    \"inputs\" : {\n      \"Service\" : \"dynamodb\",\n      \"Api\" : \"RestoreTableFromBackup\",\n      \"BackupArn\" : \"{{ DynamoDBSourceTableBackupArn }}\",\n      \"TargetTableName\" : \"{{ DynamoDBTableTargetName }}\"\n    },\n    \"outputs\" : [ {\n      \"Name\" : \"TargetTableArn\",\n      \"Selector\" : \"$.TableDescription.TableArn\",\n      \"Type\" : \"String\"\n    }, {\n      \"Name\" : \"RecoveryPoint\",\n      \"Selector\" : \"$.TableDescription.RestoreSummary.RestoreDateTime\",\n      \"Type\" : \"String\"\n    } ]\n  }, {\n    \"name\" : \"WaitTableToBeActive\",\n    \"description\" : \"Wait for the table to become active\",\n    \"action\" : \"aws:waitForAwsResourceProperty\",\n    \"onFailure\" : \"Abort\",\n    \"inputs\" : {\n      \"Service\" : \"dynamodb\",\n      \"Api\" : \"DescribeTable\",\n      \"TableName\" : \"{{ DynamoDBTableTargetName }}\",\n      \"PropertySelector\" : \"$.Table.TableStatus\",\n      \"DesiredValues\" : [ \"ACTIVE\" ]\n    }\n  }, {\n    \"name\" : \"CheckIfNeedToCopyAllProperties\",\n    \"description\" : \"Check that CopyAllProperties is enabled\",\n    \"action\" : \"aws:branch\",\n    \"inputs\" : {\n      \"Choices\" : [ {\n        \"NextStep\" : \"CopyAllTableProperties\",\n        \"Variable\" : \"{{CopyAllProperties}}\",\n        \"BooleanEquals\" : true\n      } ],\n      \"Default\" : \"OutputRecoveryTime\"\n    }\n  }, {\n    \"name\" : \"CopyAllTableProperties\",\n    \"description\" : \"Execute script to copy properties and alarms from the source table to the restored one\",\n    \"action\" : \"aws:executeAutomation\",\n    \"onFailure\" : \"Abort\",\n    \"inputs\" : {\n      \"DocumentName\" : \"AWSResilienceHub-CopyDynamoDBTablePropertiesUtil_2020-04-01\",\n      \"RuntimeParameters\" : {\n        \"AutomationAssumeRole\" : \"{{AutomationAssumeRole}}\",\n        \"DynamoDBTableSourceName\" : \"{{DynamoDBTableSourceName}}\",\n        \"DynamoDBTableTargetName\" : \"{{DynamoDBTableTargetName}}\",\n        \"DynamoDBSourceTableAlarmNames\" : \"{{DynamoDBSourceTableAlarmNames}}\"\n      }\n    }\n  }, {\n    \"name\" : \"OutputRecoveryTime\",\n    \"description\" : \"Calculate execution time\",\n    \"action\" : \"aws:executeScript\",\n    \"outputs\" : [ {\n      \"Name\" : \"RecoveryTime\",\n      \"Selector\" : \"$.Payload\",\n      \"Type\" : \"Integer\"\n    } ],\n    \"inputs\" : {\n      \"Runtime\" : \"python3.8\",\n      \"Handler\" : \"recovery_time\",\n      \"Script\" : \"import logging\\nimport time\\nfrom datetime import datetime, timezone\\n\\nimport boto3\\nfrom botocore.exceptions import ClientError\\nfrom dateutil import parser\\n\\nlogger = logging.getLogger()\\nlogger.setLevel(logging.INFO)\\n\\n\\n\\ndef recovery_time(events, context):\\n    return (datetime.now(timezone.utc) - parser.parse(events['StartTime'])).seconds\",\n      \"InputPayload\" : {\n        \"StartTime\" : \"{{ RecordStartTime.StartTime }}\"\n      }\n    },\n    \"isEnd\" : true\n  } ]\n}",
  "CreatedDate": "2023-02-19T17:15:59.696Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Automation"
  },
  "DocumentVersion": "4",
  "Name": "AWSResilienceHub-RestoreDynamoDBTableFromBackupSOP_2020-04-01",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "b630b282-33c2-4531-ad56-c573add39bf6",
    "Metadata": {},
    "ChecksumAlgorithm": 0,
    "ChecksumValidationStatus": 0
  },
  "ContentLength": 9480,
  "HttpStatusCode": 200,
  "LoggedAt": "2023-02-20T07:12:52.3123617+00:00"
}
