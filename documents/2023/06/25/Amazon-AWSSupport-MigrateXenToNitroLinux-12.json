{
  "AttachmentsContent": [
    {
      "Hash": "2ab9059fcd2dc82467e939243f1a85c5266c76a2fe285376f4a7e273d035021b",
      "HashType": {
        "Value": "Sha256"
      },
      "Name": "attachment.zip",
      "Size": 10829,
      "Url": "https://aws-ssm-document-attachments-us-west-2.s3.us-west-2.amazonaws.com/03c/190294270367/Automation/AWSSupport-MigrateXenToNitroLinux%212ae8321b-86a7-4305-81af-a7e3338c8614/12/attachment.zip?x-attachment-size=10829&x-requester-accountId=987868780346&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEL7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQC4O00qp7JGyrOUaUHa%2Fo6h7kOYLZ3wC9T25C8c0AirXwIhAONkgITeH7YhLGuSxhF4I0RjYzV7jdlddFfW92A1lJbqKrsFCCcQAxoMMjQ5OTI0NTI3NDEwIgxkqLyiD1b0Mgo4MGAqmAUVCJXTzf4gzjwVEsbeqdTY7X33VniSKdQGIaKLz5rA7GtkmrnBpeRE067d0B5AG1PnmP5VrI18JP57asqSaoH0g4HBElaUwBiygt5RphsufbkPyeL8oKv6rLoyuGrfFhb8mUKe9A8KrfpH%2BMi22Udlu4hVGoRE9FSgHe4FeSJ8SnYbXah7pLcLuRFyg8uy%2FTth47DPq2vHgiSs3PYO%2BVkD2Zt1yHRzvcq8k0YiQi39Lz6p1uAZn6jETdK%2B%2BWSVZL0a5Y92wpFsL0H8nQu6XVh8nT%2FHxTuA7TGa02sfp7bJQrDLVuYJ037ha%2F9aGJk%2FfQEnf7PZlKoqeeuctgB6HLBpyQD6rCQUmWNAbv2xsvPzipHoiXYT0tEJegHwCHNxLLkcstTeMZCUIEicF4utcK22RmhrX%2FI326FPBjxHSMnbtInw1u5ocrN%2Fn9hvzz43eUG5AC1NZG9VqhChCUAr2RFCxdPTJYciXWP0%2BnX7jONhWbx0d%2FVos3nGtK3%2Fdn431T%2Fzm%2BA4FYd4bAk0yvcdoLL%2BGZpbZXR0Gk7xk18%2BNjLuCBt7hJF7tUuDAUmPpRg8UgtoyxRFyf4FropbLdA5SyjlxraN5KQcs2NzUDaLMViSn6BKCLGaU%2B91oCfkvQMcNYmpSdghbxQUMLTqu15oSku%2Fy4avXJfl81D4ie8s02qqr1NbriHK4%2FkC1nIx1lnRe%2FnXp6UHjVlNV3j2YDM6alzTk8xwt4yQOGYsYNuMwC%2F%2Bplni92aaNkOM4q%2BnXThsGOIwqQ8CwyGC1hCVPs9o8ximeOOghyLnMfvOIOz2OZrkhYDjgg1Xw2tyw2NVx%2FOtlnPqvCXBn0NZlBA31MLFT3fUarHFThCpEq4MROJP6%2FkWB5yvSaVgNz5eMPej36QGOrABN53fcr0x5jUZTvUriyfhkJEGcFoWMhkfK48VOIHOPdGqiPkGzhOYjjN9L7k1ljtQH9x5Q0oZ3zepTdzynNgHyR8jVBUSFZNJNgqsik67vHfMqHiY1%2FZw6xDa4oiq6zBsjB410ZF5NT0ZMePIKgEj%2FjYrq0tCdlTLNnKC6VMTHVNPUUkHImITYmSgAidstpA3qRKSzMBkrdjXCszohNfIP3tMcHWsYyQ%2BbR3nWDVyIh8%3D&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20230625T071224Z&X-Amz-SignedHeaders=host&X-Amz-Expires=86400&X-Amz-Credential=ASIATUMFJUUZIX5DNXOF%2F20230625%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Signature=891e2617651479c103583d2d539d8143479fbb99a1db4d47a853da485d0e40bb"
    }
  ],
  "Content": "{\n  \"schemaVersion\": \"0.3\",\n  \"description\": \"The *AWSSupport-MigrateXenToNitroLinux* runbook clones, prepares, and migrates the target EC2 Linux instance currently running on EC2 Xen platform, to run on [EC2 Nitro platform](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-types.html#ec2-nitro-instances). This automation runbook provides two different Operation Types as input parameter: ```Clone&Migrate``` and ```FullMigration```. For the ```Clone&Migrate``` option, the automation performs **Preliminary Checks**, **Tests**, and **CloneAndMigrate** while ```FullMigration``` has an additional step **Replace root EBS volumes**. Details are as follows::\\n\\n### 1. Preliminary Checks\\n\\nIn this phase, the automation evaluates all of the following pre-requisites to proceed with the migration. If any of the steps fails, the automation stops.\\n\\n> * Checks if the target EC2 instance is already running on Nitro platform\\n> * Determines if the [lifecycle](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-purchasing-options.html#check-instance-lifecycle) of the target EC2 instance is ```Spot```\\n> * Checks if any [instance-store-volume](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/InstanceStorage.html#instance-store-volumes) is attached to the target EC2 instance\\n> * Validates if the operating system is Linux\\n> * Determines if the target EC2 instance is a part of an Amazon EC2 Auto Scaling group. If yes, the EC2 instance should be in the [Standby lifecycle state](https://docs.aws.amazon.com/autoscaling/ec2/userguide/as-enter-exit-standby.html)\\n> * Checks if the target EC2 instance is managed by Systems Manager and configured to use AWS Systems Manager Run Command\\n\\n\\n### 2. Test\\n\\nThe automation uses this phase as sanity test by creating a test Amazon Machine Image (AMI) from the target EC2 instance and launching a test EC2 instance using this AMI. If the test EC2 instance passes the status checks, the automation is temporarily paused and approval from the designated principals is requested via SNS notification. If approval is provided, the automation stops the target EC2 instance.\\n\\n**Notes:**\\n\\n> * Before providing approval, ensure that all the application(s) running on the target EC2 instance are gracefully closed.*\\n> * If the EC2 instance does not have an Elastic IP addresses associated, the automatic public IPv4 address will change once the instance is stopped and started.*\\n> * The test AMI and the test EC2 instance are deleted at the end of this phase\\n\\n### 3. Clone & Migrate\\n\\nIn this phase, the automation creates a clone of your target EC2 instance in the same subnet and migrates the EC2 instance using the following steps:\\n\\n> * Enables the [Enhanced networking (ENA) attribute](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/enhanced-networking-ena.html#enable-enhanced-networking-ena-AL)\\n> * Installs the latest version of ENA drivers\\n> * Verifies if the NVMe module is installed. If installed, then verifies if the module is loaded in the initramfs\\n> * Analyzes */etc/fstab* and replaces entries with block device names (/dev/sd\\\\* or /dev/xvd\\\\*) with their respective UUIDs. Before modifying the configuration, the runbook creates a backup of the file in the path */etc/fstab**\\n> * Disables [predictable interface naming](https://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/) by adding the ``net.ifnames=0`` option to the ``GRUB_CMDLINE_LINUX`` line in */etc/default/grub*, if exists or to the ``kernel`` in */boot/grub/menu.lst*\\n> * Removes the ```*/etc/udev/rules.d/70-persistent-net.rules``` file, if exists. Before removing it, a backup is created in the path ```*/etc/udev/rules.d/*```\\n\\nAfter validating all the requirements, the cloned EC2 instance type is changed to the desired Nitro type.  Once the cloned instance passes the Status Checks on Nitro platform, the automation seeks for designated principal's approval to create an AMI. If approval is denied, the automation stops, leaving the cloned EC2 instance in your account.\\n\\n### 4. Replace root EBS volumes\\n\\n\\nIf you choose ```FullMigration``` as Operation Type, the automation migrates the target EC2 instance to the required nitro instance type. The automation requests approval from the designated principals to replace the root EBS volume of the target EC2 instance with the cloned EC2 instance. Once the migration is successful, the cloned EC2 instance is deleted. In case of failure, the automation re-attaches the original EBS root volume back to the target EC2 instance. If the root EBS volume attached to the target EC2 instance contains AWS Reserved Tags, tags with the 'aws:' prefix, then ```FullMigration``` **is not supported**.\\n> * The `Replace root EBS volumes` step is only executed if the root EBS volume is not based on Logical Volume Management (LVM). If the EBS volume is based on LVM, its is required to perform **additional manual steps to complete the migration**. The instructions can be found in the output of the automation execution.\\n\\n### Prerequisites:\\n\\nThe target EC2 instance requires outbound access to the repositories to install drivers and dependencies such as *kernel-devel, gcc, patch, rpm-build, wget, dracut, make, and linux-headers,unzip* using package manager if needed.\\n\\n### Supported Operating Systems:\\n\\n> * Red Hat Enterprise Linux (RHEL) 7.x - 8.5\\n> * Amazon Linux and Amazon Linux 2\\n> * Ubuntu Server 18.04 LTS, 20.04 LTS, and 20.10 STR\\n> * SUSE12SP5 and SUSE15SP(2,3,4)\\n\\n### Important:\\n> * After the EBS volume(s) replacement, the EBS volumes detached from the target instance are not deleted. You have to delete them manually after you have verified everything is working as expected. The list of the volumes can be found in the output of the automation execution, once completed.\\n> * Executing this runbook, may incur extra charges to your account for the EC2 instance, EBS Volumes, and Amazon Machine Images (AMIs). Please refer to the [Amazon EC2 Pricing](https://aws.amazon.com/ec2/pricing/) and [Amazon EBS pricing](https://aws.amazon.com/ebs/pricing/) for more details.\",\n  \"assumeRole\": \"{{AutomationAssumeRole}}\",\n  \"parameters\": {\n    \"AutomationAssumeRole\": {\n      \"type\": \"AWS::IAM::Role::Arn\",\n      \"description\": \"(Optional) The ARN of the role that allows the Automation runbook to perform the actions on your behalf. If no role is specified, Systems Manager Automation uses your current IAM user permissions context to execute this runbook.\",\n      \"default\": \"\"\n    },\n    \"TargetInstanceId\": {\n      \"type\": \"AWS::EC2::Instance::Id\",\n      \"description\": \"(Required) The Instance ID of the target EC2 instance you want to migrate to Nitro platform.\"\n    },\n    \"NitroInstanceType\": {\n      \"type\": \"String\",\n      \"default\": \"m5.xlarge\",\n      \"description\": \"(Required) Enter the destination Nitro instance type. Note: Only Nitro M5, M6, C5, C6, R5, R6 and T3 instances are supported (e.g. t3.small). For more details about the available Nitro instance types, please refer to the link: https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-types.html\",\n      \"allowedPattern\": \"^(m5a?z?d?n?|c5a?d?n?|r5a?d?n?b?|c6(a|i)?d?|m6(a|i)?d?|r6(a|i)?d?)\\\\.(x|2x|4x|8x|12x|16x|24x|32x)?large$|^t3a?\\\\.((x|2x)?large|nano|micro|small|medium)$\"\n    },\n    \"OperationType\": {\n      \"type\": \"String\",\n      \"description\": \"(Required) If you choose 'Clone&Migrate', this automation will clone the target EC2 instance & migrate it to the Nitro platform. If you choose 'FullMigration', this automation will clone the target EC2 instance, migrate it to the Nitro platform and replace the root volume of the target EC2 instance with the cloned(New) EC2 instance, only if the root partition is not based on Logical Volume Manager(LVM). \",\n      \"allowedValues\": [\n        \"Clone&Migrate\",\n        \"FullMigration\"\n      ]\n    },\n    \"SNSTopicArn\": {\n      \"type\": \"String\",\n      \"description\": \"(Required) Provide the ARN of the SNS Topic for Approval notification. This SNS topic is used to send approval notifications required during the automation execution.\",\n      \"allowedPattern\": \"^arn:(aws|aws-cn|aws-us-gov|aws-iso(-[a-z])?):sns:(us(-gov|-isob?)?|ap|ca|af|me|cn|eu|sa)-(central|(north|south)?(east|west)?)-\\\\d:\\\\d{12}:.*$\"\n    },\n    \"ApproverIAM\": {\n      \"type\": \"StringList\",\n      \"description\": \"(Required) Provide a list of AWS authenticated principals who are able to either approve or reject the action. The maximum number of approvers is 10. You can specify principals by using any of these formats, 1) An AWS Identity and Access Management (IAM) user name, 2) An IAM user ARN, 3) An IAM role ARN, or 4) An IAM assume role user ARN\",\n      \"allowedPattern\": \"^[a-zA-Z0-9_+=,.@\\\\-/]{1,128}$|^arn:(aws|aws-cn|aws-us-gov|aws-iso(-[a-z])?):(sts|iam):.*:[0-9]{12}:[a-zA-Z0-9_+=,.@\\\\-/]{1,256}$\"\n    },\n    \"MinimumRequiredApprovals\": {\n      \"type\": \"Integer\",\n      \"default\": 1,\n      \"description\": \"(Optional) The minimum number of approvals required to resume the automation. If you don't specify a value, the system defaults to one. The value for this parameter must be a positive number. The value for this parameter can't exceed the number of approvers defined by the ApproverIAM parameter.\",\n      \"allowedValues\": [\n        1,\n        2,\n        3,\n        4,\n        5,\n        6,\n        7,\n        8,\n        9,\n        10\n      ]\n    },\n    \"DeleteResourcesOnFailure\": {\n      \"type\": \"Boolean\",\n      \"default\": true,\n      \"description\": \"(Required) Whether to terminate the cloned EC2 instance and Amazon Machine Image(AMI) if the automation fails. Not applicable for Test & ReplaceRootVolume branches.\",\n      \"allowedValues\": [\n        false,\n        true\n      ]\n    },\n    \"Acknowledgement\": {\n      \"type\": \"String\",\n      \"description\": \"(Required) Please read the complete details of the actions performed by this automation runbook and write 'Yes, I understand and acknowledge' if you acknowledge the steps.\",\n      \"allowedPattern\": \"^Yes, I understand and acknowledge$\"\n    }\n  },\n  \"mainSteps\": [\n    {\n      \"name\": \"checkConcurrency\",\n      \"action\": \"aws:executeScript\",\n      \"description\": \"Ensures there is only one execution of this runbook targeting the current EC2 instance. If the runbook finds another in progress execution targeting the same instance ID, it returns an error and ends.\",\n      \"timeoutSeconds\": 600,\n      \"onFailure\": \"Abort\",\n      \"inputs\": {\n        \"Runtime\": \"python3.8\",\n        \"Handler\": \"checkConcurrency.check_concurrency_handler\",\n        \"InputPayload\": {\n          \"TargetInstanceId\": \"{{TargetInstanceId}}\"\n        },\n        \"Attachment\": \"attachment.zip\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"NoExecutionFound\",\n          \"Selector\": \"$.Payload.NoExecutionFound\",\n          \"Type\": \"String\"\n        }\n      ],\n      \"nextStep\": \"getTargetInstanceProperties\"\n    },\n    {\n      \"name\": \"getTargetInstanceProperties\",\n      \"action\": \"aws:executeAwsApi\",\n      \"description\": \"Fetches the details of the target EC2 instance\",\n      \"onFailure\": \"Abort\",\n      \"maxAttempts\": 3,\n      \"nextStep\": \"checkRootVolumeTags\",\n      \"inputs\": {\n        \"Service\": \"ec2\",\n        \"Api\": \"DescribeInstances\",\n        \"InstanceIds\": [\n          \"{{TargetInstanceId}}\"\n        ]\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"PlatformType\",\n          \"Selector\": \"$.Reservations[0].Instances[0].Platform\",\n          \"Type\": \"String\"\n        },\n        {\n          \"Name\": \"InstanceSubnetId\",\n          \"Selector\": \"$.Reservations[0].Instances[0].SubnetId\",\n          \"Type\": \"String\"\n        },\n        {\n          \"Name\": \"SecurityGroup\",\n          \"Selector\": \"$.Reservations[0].Instances[0].SecurityGroups[0].GroupId\",\n          \"Type\": \"String\"\n        },\n        {\n          \"Name\": \"InstanceProfileArn\",\n          \"Selector\": \"$.Reservations[0].Instances[0].IamInstanceProfile.Arn\",\n          \"Type\": \"String\"\n        },\n        {\n          \"Name\": \"InstanceProfileName\",\n          \"Selector\": \"$.Reservations[0].Instances[0].IamInstanceProfile.Name\",\n          \"Type\": \"String\"\n        },\n        {\n          \"Name\": \"AvailabilityZone\",\n          \"Selector\": \"$.Reservations[0].Instances[0].Placement.AvailabilityZone\",\n          \"Type\": \"String\"\n        },\n        {\n          \"Name\": \"RootDeviceName\",\n          \"Selector\": \"$.Reservations[0].Instances[0].RootDeviceName\",\n          \"Type\": \"String\"\n        },\n        {\n          \"Name\": \"RootVolumeType\",\n          \"Selector\": \"$.Reservations[0].Instances[0].RootDeviceType\",\n          \"Type\": \"String\"\n        },\n        {\n          \"Name\": \"InstanceType\",\n          \"Selector\": \"$.Reservations[0].Instances[0].InstanceType\",\n          \"Type\": \"String\"\n        },\n        {\n          \"Name\": \"ENAAttrib\",\n          \"Selector\": \"$.Reservations[0].Instances[0].EnaSupport\",\n          \"Type\": \"Boolean\"\n        },\n        {\n          \"Name\": \"InstanceLifecycle\",\n          \"Selector\": \"$.Reservations[0].Instances[0].InstanceLifecycle\",\n          \"Type\": \"String\"\n        },\n        {\n          \"Name\": \"InstanceState\",\n          \"Selector\": \"$.Reservations[0].Instances[0].State.Name\",\n          \"Type\": \"String\"\n        }\n      ]\n    },\n    {\n      \"name\": \"checkRootVolumeTags\",\n      \"action\": \"aws:executeScript\",\n      \"description\": \"Determines if the root volume of the target EC2 instance contains any AWS reserved tags\",\n      \"isCritical\": true,\n      \"nextStep\": \"cloneTargetInstanceAndMigrateToNitro\",\n      \"onFailure\": \"Abort\",\n      \"inputs\": {\n        \"Runtime\": \"python3.8\",\n        \"Handler\": \"checkRootVolumetags.checkRootVolumetags_handler\",\n        \"InputPayload\": {\n          \"TargetInstanceId\": \"{{TargetInstanceId}}\",\n          \"RootDeviceName\": \"{{getTargetInstanceProperties.RootDeviceName}}\",\n          \"OperationType\": \"{{OperationType}}\"\n        },\n        \"Attachment\": \"attachment.zip\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"RootVolumeTags\",\n          \"Selector\": \"$.Payload.volume_tags\",\n          \"Type\": \"MapList\"\n        }\n      ]\n    },\n    {\n      \"name\": \"cloneTargetInstanceAndMigrateToNitro\",\n      \"action\": \"aws:executeAutomation\",\n      \"description\": \"Starts child automation execution that clones the Target EC2 instance and migrates it to the Nitro platform by completing all the requirements.\",\n      \"onFailure\": \"Abort\",\n      \"maxAttempts\": 1,\n      \"isCritical\": true,\n      \"nextStep\": \"branchOnTheOperationType\",\n      \"inputs\": {\n        \"DocumentName\": \"AWSSupport-CloneXenEC2InstanceAndMigrateToNitro\",\n        \"RuntimeParameters\": {\n          \"TargetInstanceId\": [\n            \"{{ TargetInstanceId }}\"\n          ],\n          \"NitroInstanceType\": [\n            \"{{ NitroInstanceType }}\"\n          ],\n          \"SNSTopicArn\": [\n            \"{{ SNSTopicArn }}\"\n          ],\n          \"ApproverIAM\": [\n            \"{{ ApproverIAM }}\"\n          ],\n          \"Acknowledgement\": [\n            \"{{ Acknowledgement }}\"\n          ],\n          \"AutomationAssumeRole\": [\n            \"{{ AutomationAssumeRole }}\"\n          ],\n          \"MinimumRequiredApprovals\": \"{{MinimumRequiredApprovals}}\",\n          \"DeleteResourcesOnFailure\": \"{{DeleteResourcesOnFailure}}\"\n        }\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"ClonedEC2InstanceId\",\n          \"Selector\": \"$.Output\",\n          \"Type\": \"String\"\n        }\n      ]\n    },\n    {\n      \"name\": \"branchOnTheOperationType\",\n      \"action\": \"aws:branch\",\n      \"description\": \"Branches on the value of Operation Type\",\n      \"isEnd\": true,\n      \"isCritical\": true,\n      \"inputs\": {\n        \"Choices\": [\n          {\n            \"NextStep\": \"getClonedInstanceId\",\n            \"Variable\": \"{{OperationType}}\",\n            \"StringEquals\": \"FullMigration\"\n          }\n        ]\n      }\n    },\n    {\n      \"name\": \"getClonedInstanceId\",\n      \"action\": \"aws:executeScript\",\n      \"description\": \"Retrieves the Cloned EC2 Instance Id from the child Automation\",\n      \"isCritical\": true,\n      \"nextStep\": \"checkIfRootVolumeIsBasedOnLVM\",\n      \"onFailure\": \"Abort\",\n      \"inputs\": {\n        \"Runtime\": \"python3.8\",\n        \"Handler\": \"checkStepDetails.checkStepDetails_handler\",\n        \"InputPayload\": {\n          \"ChildAutomationId\": \"{{cloneTargetInstanceAndMigrateToNitro.ExecutionId}}\",\n          \"StepName\": \"launchInstanceInSameSubnet\"\n        },\n        \"Attachment\": \"attachment.zip\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"ClonedInstanceId\",\n          \"Selector\": \"$.Payload.cloned_instance_id\",\n          \"Type\": \"String\"\n        }\n      ]\n    },\n    {\n      \"name\": \"checkIfRootVolumeIsBasedOnLVM\",\n      \"action\": \"aws:runCommand\",\n      \"description\": \"Determines if the root partition is based on Logical Volume Manager(LVM).\",\n      \"timeoutSeconds\": 3600,\n      \"inputs\": {\n        \"DocumentName\": \"AWS-RunShellScript\",\n        \"InstanceIds\": [\n          \"{{getClonedInstanceId.ClonedInstanceId}}\"\n        ],\n        \"Parameters\": {\n          \"commands\": \"# Copyright 2022 Amazon.com, Inc. or its affiliates. All Rights Reserved.\\n# SPDX-License-Identifier: LicenseRef-.amazon.com.-AmznSL-1.0\\n# Licensed under the Amazon Software License  http://aws.amazon.com/asl/\\n\\n\\n#!/bin/bash\\n \\nexit_code=$(sudo lsblk | grep /$ | grep -i lvm 2> /dev/null)\\nif [ -z \\\"$exit_code\\\" ]\\nthen\\n    echo -n \\\"LVM not detected on root partition\\\"\\nelse\\n    echo -n \\\"LVM detected on root partition\\\"\\nfi\\n\"\n        }\n      }\n    },\n    {\n      \"name\": \"branchOnTheRootVolumeLVMStatus\",\n      \"action\": \"aws:branch\",\n      \"description\": \"Proceeds with the approvals for root volume replacement, only if the root partition is not based on Logical Volume Manager(LVM)\",\n      \"isEnd\": true,\n      \"isCritical\": true,\n      \"inputs\": {\n        \"Choices\": [\n          {\n            \"NextStep\": \"startOfReplaceRootEBSVolumeBranch\",\n            \"Variable\": \"{{checkIfRootVolumeIsBasedOnLVM.Output}}\",\n            \"StringEquals\": \"LVM not detected on root partition\"\n          },\n          {\n            \"NextStep\": \"manualInstructionsInCaseOfLVM\",\n            \"Variable\": \"{{checkIfRootVolumeIsBasedOnLVM.Output}}\",\n            \"StringEquals\": \"LVM detected on root partition\"\n          }\n        ]\n      }\n    },\n    {\n      \"name\": \"manualInstructionsInCaseOfLVM\",\n      \"action\": \"aws:executeScript\",\n      \"description\": \"Provides instructions to manually replace the root volumes of the Target & Cloned EC2 instances if the root volumes are based on Logical Volume Manager(LVM)\",\n      \"isCritical\": true,\n      \"isEnd\": true,\n      \"onFailure\": \"Abort\",\n      \"inputs\": {\n        \"Runtime\": \"python3.8\",\n        \"Handler\": \"instructionsForLVM.manualInstructionsInCaseOfLVM_handler\",\n        \"InputPayload\": {\n          \"clonedInstance\": \"{{getClonedInstanceId.ClonedInstanceId}}\",\n          \"targetInstance\": \"{{TargetInstanceId}}\",\n          \"nitroInstanceType\": \"{{NitroInstanceType}}\"\n        },\n        \"Attachment\": \"attachment.zip\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"manualInstructions\",\n          \"Selector\": \"$.Payload.ManualInstructions\",\n          \"Type\": \"String\"\n        }\n      ]\n    },\n    {\n      \"name\": \"startOfReplaceRootEBSVolumeBranch\",\n      \"action\": \"aws:sleep\",\n      \"description\": \"Start of Replace Root EBS Volume branch\",\n      \"onFailure\": \"Continue\",\n      \"nextStep\": \"checkIfTargetInstanceIsManagedByCFN\",\n      \"isCritical\": false,\n      \"inputs\": {\n        \"Duration\": \"PT5S\"\n      }\n    },\n    {\n      \"name\": \"checkIfTargetInstanceIsManagedByCFN\",\n      \"action\": \"aws:executeScript\",\n      \"description\": \"Determines if the Target EC2 instance is managed by any AWS CloudFormation Stack\",\n      \"timeoutSeconds\": 600,\n      \"onFailure\": \"Abort\",\n      \"inputs\": {\n        \"Runtime\": \"python3.8\",\n        \"Handler\": \"checkCloudFormationResources.checkCloudFormationResources_handler\",\n        \"InputPayload\": {\n          \"TargetInstanceId\": \"{{TargetInstanceId}}\"\n        },\n        \"Attachment\": \"attachment.zip\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"Output_Message\",\n          \"Selector\": \"$.Payload.output_message\",\n          \"Type\": \"String\"\n        },\n        {\n          \"Name\": \"IspartOfCFNStack\",\n          \"Selector\": \"$.Payload.is_part_of_cfn_stack\",\n          \"Type\": \"Boolean\"\n        },\n        {\n          \"Name\": \"StackName\",\n          \"Selector\": \"$.Payload.stack_name\",\n          \"Type\": \"String\"\n        }\n      ],\n      \"nextStep\": \"branchOnCFNStackStatus\"\n    },\n    {\n      \"name\": \"branchOnCFNStackStatus\",\n      \"action\": \"aws:branch\",\n      \"description\": \"Decides which approval step to execute based on the AWS CloudFormation Stack status\",\n      \"isEnd\": true,\n      \"isCritical\": true,\n      \"inputs\": {\n        \"Choices\": [\n          {\n            \"NextStep\": \"approvalForRootVolumesReplacementWithCFN\",\n            \"Variable\": \"{{checkIfTargetInstanceIsManagedByCFN.IspartOfCFNStack}}\",\n            \"BooleanEquals\": true\n          }\n        ],\n        \"Default\": \"approvalForRootVolumesReplacement\"\n      }\n    },\n    {\n      \"name\": \"approvalForRootVolumesReplacementWithCFN\",\n      \"action\": \"aws:approve\",\n      \"description\": \"If the target EC2 instance is managed by AWS CloudFormation (CFN), the automation waits for user approval if the cloned EC2 instance successfully boots on Nitro platform. If provided, replaces the EBS volumes of the target EC2 instance with the cloned EC2 instance\",\n      \"timeoutSeconds\": 3600,\n      \"nextStep\": \"assertIfTargetEC2InstanceIsStillStopped\",\n      \"inputs\": {\n        \"NotificationArn\": \"{{SNSTopicArn}}\",\n        \"Message\": \"Cloned EC2 Instance {{getClonedInstanceId.ClonedInstanceId}}, created from {{TargetInstanceId}}, has been successfully migrated to {{NitroInstanceType}}. Provide approval to replace the volumes of the target EC2 instance with the cloned EC2 instance. If approved, both of the EC2 instances(Target & Cloned) will be stopped to replace the volumes. Target EC2 instance is a part of AWS CloudFormation Stack {{checkIfTargetInstanceIsManagedByCFN.StackName}}, migrating the Target EC2 instance using this automation may cause a drift from the stack's actual configuration. This step will automatically timeout after 3600s if no action is taken.\",\n        \"MinRequiredApprovals\": \"{{MinimumRequiredApprovals}}\",\n        \"Approvers\": [\n          \"{{ApproverIAM}}\"\n        ]\n      }\n    },\n    {\n      \"name\": \"approvalForRootVolumesReplacement\",\n      \"action\": \"aws:approve\",\n      \"description\": \"Waits for user approval if the cloned EC2 instance successfully boots on Nitro platform. If provided, replaces the EBS volumes of the target EC2 instance with the cloned EC2 instance\",\n      \"timeoutSeconds\": 3600,\n      \"nextStep\": \"assertIfTargetEC2InstanceIsStillStopped\",\n      \"inputs\": {\n        \"NotificationArn\": \"{{SNSTopicArn}}\",\n        \"Message\": \"Cloned EC2 Instance {{getClonedInstanceId.ClonedInstanceId}}, created from {{TargetInstanceId}}, has been successfully migrated to {{NitroInstanceType}}. Provide approval to replace the volumes of the target EC2 instance with the cloned EC2 instance. If approved, both of the EC2 instances(Target & Cloned) will be stopped to replace the volumes.This step will automatically timeout after 3600s if no action is taken.\",\n        \"MinRequiredApprovals\": \"{{MinimumRequiredApprovals}}\",\n        \"Approvers\": [\n          \"{{ApproverIAM}}\"\n        ]\n      }\n    },\n    {\n      \"name\": \"assertIfTargetEC2InstanceIsStillStopped\",\n      \"description\": \"Validates if target EC2 instance is still in Stopped state before proceeding for volume replacement\",\n      \"action\": \"aws:assertAwsResourceProperty\",\n      \"onFailure\": \"step:stopTargetInstanceForRootVolumeReplacement\",\n      \"isCritical\": \"true\",\n      \"maxAttempts\": 3,\n      \"nextStep\": \"stopClonedInstanceForRootVolumeReplacement\",\n      \"inputs\": {\n        \"Service\": \"ec2\",\n        \"Api\": \"DescribeInstanceStatus\",\n        \"InstanceIds\": [\n          \"{{TargetInstanceId}}\"\n        ],\n        \"IncludeAllInstances\": true,\n        \"PropertySelector\": \"$.InstanceStatuses[0].InstanceState.Name\",\n        \"DesiredValues\": [\n          \"stopped\"\n        ]\n      }\n    },\n    {\n      \"name\": \"stopTargetInstanceForRootVolumeReplacement\",\n      \"action\": \"aws:changeInstanceState\",\n      \"description\": \"Stops the target (Xen based) EC2 instance before replacing EBS volumes\",\n      \"maxAttempts\": 3,\n      \"timeoutSeconds\": 300,\n      \"onFailure\": \"step:forceStopTargetInstanceForRootVolumeReplacement\",\n      \"inputs\": {\n        \"InstanceIds\": [\n          \"{{TargetInstanceId}}\"\n        ],\n        \"CheckStateOnly\": false,\n        \"DesiredState\": \"stopped\"\n      },\n      \"nextStep\": \"stopClonedInstanceForRootVolumeReplacement\"\n    },\n    {\n      \"name\": \"forceStopTargetInstanceForRootVolumeReplacement\",\n      \"action\": \"aws:changeInstanceState\",\n      \"description\": \"Force stops the target (Xen based) EC2 instance, only if the step 'stopTargetInstanceForRootVolumeReplacement' fails\",\n      \"maxAttempts\": 3,\n      \"timeoutSeconds\": 300,\n      \"onFailure\": \"Abort\",\n      \"inputs\": {\n        \"InstanceIds\": [\n          \"{{TargetInstanceId}}\"\n        ],\n        \"CheckStateOnly\": false,\n        \"DesiredState\": \"stopped\",\n        \"Force\": true\n      },\n      \"nextStep\": \"stopClonedInstanceForRootVolumeReplacement\"\n    },\n    {\n      \"name\": \"stopClonedInstanceForRootVolumeReplacement\",\n      \"action\": \"aws:changeInstanceState\",\n      \"description\": \"Stops the cloned EC2 instance before replacing EBS volumes\",\n      \"maxAttempts\": 3,\n      \"timeoutSeconds\": 300,\n      \"onFailure\": \"step:forceStopClonedInstanceForRootVolumeReplacement\",\n      \"inputs\": {\n        \"InstanceIds\": [\n          \"{{getClonedInstanceId.ClonedInstanceId}}\"\n        ],\n        \"CheckStateOnly\": false,\n        \"DesiredState\": \"stopped\"\n      },\n      \"nextStep\": \"getBlockDeviceMappings\"\n    },\n    {\n      \"name\": \"forceStopClonedInstanceForRootVolumeReplacement\",\n      \"action\": \"aws:changeInstanceState\",\n      \"description\": \"Force stops the cloned EC2 instance, only if the step 'stopClonedInstanceForRootVolumeReplacement' fails\",\n      \"maxAttempts\": 3,\n      \"timeoutSeconds\": 300,\n      \"onFailure\": \"Abort\",\n      \"inputs\": {\n        \"InstanceIds\": [\n          \"{{getClonedInstanceId.ClonedInstanceId}}\"\n        ],\n        \"CheckStateOnly\": false,\n        \"DesiredState\": \"stopped\",\n        \"Force\": true\n      },\n      \"nextStep\": \"getBlockDeviceMappings\"\n    },\n    {\n      \"name\": \"getBlockDeviceMappings\",\n      \"action\": \"aws:executeScript\",\n      \"description\": \"Retrieves the block device mappings for both the EC2 instances\",\n      \"isCritical\": true,\n      \"nextStep\": \"replaceRootEbsVolumes\",\n      \"onFailure\": \"Abort\",\n      \"inputs\": {\n        \"Runtime\": \"python3.8\",\n        \"Handler\": \"getblockdevicemappings.getBlockDeviceMappings_handler\",\n        \"InputPayload\": {\n          \"ClonedInstance\": \"{{getClonedInstanceId.ClonedInstanceId}}\",\n          \"TargetInstance\": \"{{TargetInstanceId}}\"\n        },\n        \"Attachment\": \"attachment.zip\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"root_device_mapping_target_instance\",\n          \"Selector\": \"$.Payload.root_device_mapping_target_instance\",\n          \"Type\": \"StringMap\"\n        },\n        {\n          \"Name\": \"table_block_dev_mapping_target_instance\",\n          \"Selector\": \"$.Payload.table_block_dev_mapping_target_instance\",\n          \"Type\": \"String\"\n        },\n        {\n          \"Name\": \"root_device_mapping_cloned_instance\",\n          \"Selector\": \"$.Payload.root_device_mapping_cloned_instance\",\n          \"Type\": \"StringMap\"\n        },\n        {\n          \"Name\": \"table_block_dev_mapping_cloned_instance\",\n          \"Selector\": \"$.Payload.table_block_dev_mapping_cloned_instance\",\n          \"Type\": \"String\"\n        }\n      ]\n    },\n    {\n      \"name\": \"replaceRootEbsVolumes\",\n      \"action\": \"aws:executeScript\",\n      \"maxAttempts\": 3,\n      \"description\": \"Replaces the EBS volumes of the Target (Xen based) EC2 instance with the cloned EC2 instance. Also prints the block device mappings tables for both the instances before EBS volume's replacement\",\n      \"isCritical\": true,\n      \"onFailure\": \"step:onFailureRollbackRootVolumeReplacement\",\n      \"nextStep\": \"EndOfReplaceRootEBSVolumeBranch\",\n      \"inputs\": {\n        \"Runtime\": \"python3.8\",\n        \"Handler\": \"replaceRootVolumes.replaceRootVolumes_handler\",\n        \"InputPayload\": {\n          \"clonedInstance\": \"{{getClonedInstanceId.ClonedInstanceId}}\",\n          \"targetInstance\": \"{{TargetInstanceId}}\",\n          \"rootDevMappingTargetInstance\": \"{{getBlockDeviceMappings.root_device_mapping_target_instance}}\",\n          \"rootDevMappingClonedInstance\": \"{{getBlockDeviceMappings.root_device_mapping_cloned_instance}}\"\n        },\n        \"Attachment\": \"attachment.zip\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"Disclaimer\",\n          \"Selector\": \"$.Payload.Disclaimer\",\n          \"Type\": \"String\"\n        }\n      ]\n    },\n    {\n      \"name\": \"EndOfReplaceRootEBSVolumeBranch\",\n      \"action\": \"aws:sleep\",\n      \"description\": \"End of Replace Root EBS Volume branch\",\n      \"onFailure\": \"Continue\",\n      \"nextStep\": \"checkENAAttributeForTargetInstance\",\n      \"isCritical\": false,\n      \"inputs\": {\n        \"Duration\": \"PT5S\"\n      }\n    },\n    {\n      \"name\": \"checkENAAttributeForTargetInstance\",\n      \"action\": \"aws:branch\",\n      \"description\": \"Checks if the Enhanced Networking Adapter (ENA) attribute is enabled on the target EC2 instance\",\n      \"isCritical\": true,\n      \"onFailure\": \"step:onFailureRollbackRootVolumeReplacement\",\n      \"inputs\": {\n        \"Choices\": [\n          {\n            \"NextStep\": \"setNitroInstanceTypeForTargetInstance\",\n            \"Variable\": \"{{getTargetInstanceProperties.ENAAttrib}}\",\n            \"BooleanEquals\": true\n          }\n        ],\n        \"Default\": \"enableENAAttributeForTargetInstance\"\n      }\n    },\n    {\n      \"name\": \"enableENAAttributeForTargetInstance\",\n      \"action\": \"aws:executeAwsApi\",\n      \"description\": \"Enables the Enhanced Networking Adapter (ENA) attribute for the target EC2 instance, if not enabled already\",\n      \"nextStep\": \"setNitroInstanceTypeForTargetInstance\",\n      \"onFailure\": \"step:onFailureRollbackRootVolumeReplacement\",\n      \"maxAttempts\": 3,\n      \"inputs\": {\n        \"Service\": \"ec2\",\n        \"Api\": \"ModifyInstanceAttribute\",\n        \"InstanceId\": \"{{TargetInstanceId}}\",\n        \"EnaSupport\": {\n          \"Value\": true\n        }\n      }\n    },\n    {\n      \"name\": \"setNitroInstanceTypeForTargetInstance\",\n      \"action\": \"aws:executeAwsApi\",\n      \"description\": \"Sets the provided Target EC2 instance type for the target EC2 instance\",\n      \"onFailure\": \"step:OnFailureRevertOriginalInstanceType\",\n      \"isCritical\": \"true\",\n      \"nextStep\": \"replicateRootVolumeTags\",\n      \"maxAttempts\": 3,\n      \"inputs\": {\n        \"Service\": \"ec2\",\n        \"Api\": \"ModifyInstanceAttribute\",\n        \"InstanceId\": \"{{TargetInstanceId}}\",\n        \"InstanceType\": {\n          \"Value\": \"{{NitroInstanceType}}\"\n        }\n      }\n    },\n    {\n      \"name\": \"replicateRootVolumeTags\",\n      \"action\": \"aws:executeScript\",\n      \"description\": \"Replicates the tags on the root EBS volume from the target EC2 instance\",\n      \"isCritical\": true,\n      \"nextStep\": \"startTargetInstance\",\n      \"onFailure\": \"step:onFailureStopTargetEC2Instance\",\n      \"inputs\": {\n        \"Runtime\": \"python3.8\",\n        \"Handler\": \"replicateRootVolumeTags.replicateRootVolumeTags_handler\",\n        \"InputPayload\": {\n          \"rootDevMappingTargetInstance\": \"{{getBlockDeviceMappings.root_device_mapping_target_instance}}\",\n          \"rootDevMappingClonedInstance\": \"{{getBlockDeviceMappings.root_device_mapping_cloned_instance}}\"\n        },\n        \"Attachment\": \"attachment.zip\"\n      }\n    },\n    {\n      \"name\": \"startTargetInstance\",\n      \"action\": \"aws:changeInstanceState\",\n      \"description\": \"Starts target EC2 instance after changing instance type to Nitro\",\n      \"maxAttempts\": 3,\n      \"timeoutSeconds\": 300,\n      \"onFailure\": \"step:onFailureStopTargetEC2Instance\",\n      \"nextStep\": \"terminateClonedEC2Instance\",\n      \"inputs\": {\n        \"InstanceIds\": [\n          \"{{TargetInstanceId}}\"\n        ],\n        \"CheckStateOnly\": false,\n        \"DesiredState\": \"running\"\n      }\n    },\n    {\n      \"name\": \"onFailureStopTargetEC2Instance\",\n      \"action\": \"aws:changeInstanceState\",\n      \"description\": \"Stops target EC2 instance if it fails to start on Nitro platform\",\n      \"maxAttempts\": 3,\n      \"timeoutSeconds\": 300,\n      \"onFailure\": \"step:onFailureForceStopTargetEC2Instance\",\n      \"inputs\": {\n        \"InstanceIds\": [\n          \"{{TargetInstanceId}}\"\n        ],\n        \"CheckStateOnly\": false,\n        \"DesiredState\": \"stopped\"\n      },\n      \"nextStep\": \"OnFailureRevertOriginalInstanceType\"\n    },\n    {\n      \"name\": \"onFailureForceStopTargetEC2Instance\",\n      \"action\": \"aws:changeInstanceState\",\n      \"description\": \"Stops target EC2 instance if it fails to start on Nitro platform, only if the step 'onFailureStopTargetEC2Instance' fails\",\n      \"maxAttempts\": 3,\n      \"timeoutSeconds\": 300,\n      \"onFailure\": \"Abort\",\n      \"inputs\": {\n        \"InstanceIds\": [\n          \"{{TargetInstanceId}}\"\n        ],\n        \"CheckStateOnly\": false,\n        \"DesiredState\": \"stopped\",\n        \"Force\": true\n      },\n      \"nextStep\": \"OnFailureRevertOriginalInstanceType\"\n    },\n    {\n      \"name\": \"OnFailureRevertOriginalInstanceType\",\n      \"action\": \"aws:executeAwsApi\",\n      \"description\": \"Reverts the target EC2 instance to the original instance type, if the target instance fails to start on Nitro platform\",\n      \"onFailure\": \"Abort\",\n      \"isCritical\": \"true\",\n      \"nextStep\": \"onFailureRollbackRootVolumeReplacement\",\n      \"maxAttempts\": 3,\n      \"inputs\": {\n        \"Service\": \"ec2\",\n        \"Api\": \"ModifyInstanceAttribute\",\n        \"InstanceId\": \"{{TargetInstanceId}}\",\n        \"InstanceType\": {\n          \"Value\": \"{{getTargetInstanceProperties.InstanceType}}\"\n        }\n      }\n    },\n    {\n      \"name\": \"onFailureRollbackRootVolumeReplacement\",\n      \"action\": \"aws:executeScript\",\n      \"description\": \"Reverts all the changes made by the 'replaceRootEbsVolumes' step, in case of any failure\",\n      \"isCritical\": true,\n      \"onFailure\": \"Abort\",\n      \"nextStep\": \"onFailureApprovalToStartTargetInstance\",\n      \"inputs\": {\n        \"Runtime\": \"python3.8\",\n        \"Handler\": \"ebsRollback.ebsrollback_handler\",\n        \"InputPayload\": {\n          \"clonedInstance\": \"{{getClonedInstanceId.ClonedInstanceId}}\",\n          \"targetInstance\": \"{{TargetInstanceId}}\",\n          \"rootDevMappingTargetInstance\": \"{{getBlockDeviceMappings.root_device_mapping_target_instance}}\",\n          \"rootDevMappingClonedInstance\": \"{{getBlockDeviceMappings.root_device_mapping_cloned_instance}}\"\n        },\n        \"Attachment\": \"attachment.zip\"\n      }\n    },\n    {\n      \"name\": \"onFailureApprovalToStartTargetInstance\",\n      \"action\": \"aws:approve\",\n      \"description\": \"If automation fails, waits for designated principal's approval to start the target EC2 instance\",\n      \"timeoutSeconds\": 3600,\n      \"onFailure\": \"Abort\",\n      \"nextStep\": \"onFailureStartTargetInstance\",\n      \"inputs\": {\n        \"NotificationArn\": \"{{SNSTopicArn}}\",\n        \"Message\": \"Automation failed while migrating the target instance to the Nitro platform. Provide approval to start the target EC2 instance. In case of 'Reject/Deny', the Automation will stop with Failed status. This step will automatically timeout after 3600s if no action is taken.\",\n        \"MinRequiredApprovals\": \"{{MinimumRequiredApprovals}}\",\n        \"Approvers\": [\n          \"{{ApproverIAM}}\"\n        ]\n      }\n    },\n    {\n      \"name\": \"onFailureStartTargetInstance\",\n      \"action\": \"aws:changeInstanceState\",\n      \"description\": \"If automation fails, starts the target EC2 instance\",\n      \"maxAttempts\": 1,\n      \"timeoutSeconds\": 900,\n      \"isCritical\": true,\n      \"onFailure\": \"Abort\",\n      \"isEnd\": true,\n      \"inputs\": {\n        \"InstanceIds\": [\n          \"{{TargetInstanceId}}\"\n        ],\n        \"CheckStateOnly\": false,\n        \"DesiredState\": \"running\"\n      }\n    },\n    {\n      \"name\": \"terminateClonedEC2Instance\",\n      \"action\": \"aws:changeInstanceState\",\n      \"description\": \"Terminates the cloned EC2 instance after replacing root EBS volume\",\n      \"maxAttempts\": 3,\n      \"timeoutSeconds\": 300,\n      \"isEnd\": true,\n      \"inputs\": {\n        \"InstanceIds\": [\n          \"{{getClonedInstanceId.ClonedInstanceId}}\"\n        ],\n        \"CheckStateOnly\": false,\n        \"DesiredState\": \"stopped\"\n      }\n    }\n  ],\n  \"outputs\": [\n    \"replaceRootEbsVolumes.Disclaimer\",\n    \"getClonedInstanceId.ClonedInstanceId\",\n    \"getBlockDeviceMappings.table_block_dev_mapping_cloned_instance\",\n    \"getBlockDeviceMappings.table_block_dev_mapping_target_instance\"\n  ],\n  \"files\": {\n    \"attachment.zip\": {\n      \"checksums\": {\n        \"sha256\": \"2ab9059fcd2dc82467e939243f1a85c5266c76a2fe285376f4a7e273d035021b\"\n      }\n    }\n  }\n}",
  "CreatedDate": "2023-06-15T10:52:40.892Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Automation"
  },
  "DocumentVersion": "12",
  "Name": "AWSSupport-MigrateXenToNitroLinux",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "8e16c8f2-46f3-4479-b8dc-393dfa5f944f",
    "Metadata": {},
    "ChecksumAlgorithm": 0,
    "ChecksumValidationStatus": 0
  },
  "ContentLength": 42182,
  "HttpStatusCode": 200,
  "LoggedAt": "2023-06-25T07:12:24.5148361+00:00"
}
