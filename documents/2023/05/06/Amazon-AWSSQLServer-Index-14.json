{
  "AttachmentsContent": [],
  "Content": "{\n  \"description\" : \"#### Performs SQL Server index maintenance operations on a specified database.\\n---\\n#### Prerequisites for using this document:\\n* Instance(s) must be running SQL Server.\\n* An AWS Secrets Manager database credential must be configured with the following two fields: **username** and **password**. For instructions, see [AWS Secrets Manager](https://docs.aws.amazon.com/secretsmanager/latest/userguide/auth-and-access.html).\\n* On Windows, the **username** and **password** must be the domain account and password used to authenticate SQL Server. The domain user must be a local administrator\\n* On Linux, the **username** and **password** must be the SQL Server login  name and password.\\nThe **username** must own the database or must be assigned, at minimum, the following database role: **sysadmin**. \\n* Instances may need to be granted additional permissions and roles that allow access to AWS Secrets Manager credentials and Amazon S3. For more information, see the [documentation](http://docs.aws.amazon.com/launchwizard/latest/userguide/launch-wizard-sql-provided-runbooks.html).\\n---\\nThis document uses fragmentation defaults of less than 5% for low, 5% to 30% for medium, and greater than 30% for high.\\n\\n*Note: This document installs and uses third-party software from [https://ola.hallengren.com](https://ola.hallengren.com), which is provided under the following license: [https://ola.hallengren.com/license.html](https://ola.hallengren.com/license.html)*.\",\n  \"schemaVersion\" : \"0.3\",\n  \"assumeRole\" : \"{{ AutomationAssumeRole }}\",\n  \"parameters\" : {\n    \"AutomationAssumeRole\" : {\n      \"type\" : \"String\",\n      \"description\" : \"(Optional) The ARN of the role that allows Automation to perform the actions on your behalf.\",\n      \"default\" : \"\",\n      \"allowedPattern\" : \"^arn:aws(-cn|-us-gov)?:iam::\\\\d{12}:role\\\\/[\\\\w+=,.@_\\\\/-]+|^$\"\n    },\n    \"Database\" : {\n      \"type\" : \"String\",\n      \"allowedPattern\" : \"^[a-zA-Z_][\\\\w@$#_]{0,127}$\",\n      \"description\" : \"Database on which to perform index maintenance operations\"\n    },\n    \"InstanceId\" : {\n      \"type\" : \"StringList\",\n      \"description\" : \"Target SQL Server instance on which to perform the backup operation\",\n      \"allowedPattern\" : \"(^i-(\\\\w{8}|\\\\w{17})$)|(^op-\\\\w{17}$)\"\n    },\n    \"LowFragmentIndexAction\" : {\n      \"type\" : \"String\",\n      \"default\" : \"Do nothing\",\n      \"allowedValues\" : [ \"Do nothing\", \"Build index online\", \"Build index offline\", \"Reorganize index\", \"Build index online, with offline fallback\", \"Build index online, with reorganize fallback\", \"Reorganize index, with online fallback, then offline fallback\" ],\n      \"description\" : \"Action to be taken on indexes with low fragmentation\"\n    },\n    \"MediumFragmentIndexAction\" : {\n      \"type\" : \"String\",\n      \"default\" : \"Reorganize index, with online fallback, then offline fallback\",\n      \"allowedValues\" : [ \"Do nothing\", \"Build index online\", \"Build index offline\", \"Reorganize index\", \"Build index online, with offline fallback\", \"Build index online, with reorganize fallback\", \"Reorganize index, with online fallback, then offline fallback\" ],\n      \"description\" : \"Action to be taken on indexes with medium fragmentation\"\n    },\n    \"HighFragmentIndexAction\" : {\n      \"type\" : \"String\",\n      \"default\" : \"Build index online, with offline fallback\",\n      \"allowedValues\" : [ \"Do nothing\", \"Build index online\", \"Build index offline\", \"Reorganize index\", \"Build index online, with offline fallback\", \"Build index online, with reorganize fallback\", \"Reorganize index, with online fallback, then offline fallback\" ],\n      \"description\" : \"Action to be taken on indexes with high fragmentation\"\n    },\n    \"UseTempDbForReindexing\" : {\n      \"type\" : \"String\",\n      \"default\" : \"No\",\n      \"allowedValues\" : [ \"Yes\", \"No\" ],\n      \"description\" : \"Specifies whether to use a temporary database for re-indexing\"\n    },\n    \"SecretsMangerCredential\" : {\n      \"type\" : \"String\",\n      \"allowedPattern\" : \"^[\\\\/_+=\\\\.@\\\\-a-zA-Z0-9]{1,512}$\",\n      \"description\" : \"AWS Secrets Manager credentials for SQL Server\"\n    },\n    \"ThirdPartySoftwareConsent\" : {\n      \"type\" : \"String\",\n      \"allowedValues\" : [ \"Yes\" ],\n      \"description\" : \"Consent to the use the third-party software mentioned in the description\"\n    },\n    \"IncludeMSShippedObjects\" : {\n      \"type\" : \"String\",\n      \"default\" : \"No\",\n      \"allowedValues\" : [ \"Yes\", \"No\" ],\n      \"description\" : \"Specifies whether to perform index maintenance on Microsoft shipped components\"\n    },\n    \"MaxDOP\" : {\n      \"type\" : \"String\",\n      \"default\" : \"0\",\n      \"description\" : \"Controls CPU utilization. Specifying 0 designates CPU utilization based on workload, and specifying a value greater than 0 designates the number of CPUs to use\",\n      \"allowedValues\" : [ \"0\", \"1\", \"2\", \"4\", \"8\", \"16\", \"32\", \"64\" ]\n    },\n    \"ReindexTableList\" : {\n      \"type\" : \"String\",\n      \"allowedPattern\" : \"^([^&,\\\\*\\\\s]+){1,127}$|^([^&,\\\\*\\\\s]+){1,127},([^&,\\\\*\\\\s]+){1,127}$|^([^&,\\\\*\\\\s]+){1,127},([^&,\\\\*\\\\s]+){1,127},([^&,\\\\*\\\\s]+){1,127}$|^$\",\n      \"description\" : \"A comma-delimited list that specifies the tables to re-index. There is a maximum limit of three tables. If no tables are specified, the default is to re-index all tables in the database).\",\n      \"default\" : \"\"\n    }\n  },\n  \"mainSteps\" : [ {\n    \"name\" : \"GetInstanceOSInfo\",\n    \"action\" : \"aws:executeAwsApi\",\n    \"inputs\" : {\n      \"Service\" : \"ssm\",\n      \"Api\" : \"DescribeInstanceInformation\",\n      \"Filters\" : [ {\n        \"Key\" : \"InstanceIds\",\n        \"Values\" : [ \"{{ InstanceId }}\" ]\n      } ]\n    },\n    \"outputs\" : [ {\n      \"Name\" : \"platform\",\n      \"Selector\" : \"$.InstanceInformationList[0].PlatformType\",\n      \"Type\" : \"String\"\n    } ]\n  }, {\n    \"name\" : \"BranchOnWindowsOrLinux\",\n    \"action\" : \"aws:branch\",\n    \"inputs\" : {\n      \"Choices\" : [ {\n        \"NextStep\" : \"ExecuteReindexing\",\n        \"Variable\" : \"{{GetInstanceOSInfo.platform}}\",\n        \"StringEquals\" : \"Windows\"\n      }, {\n        \"NextStep\" : \"InstallPowerShellOnLinux\",\n        \"Variable\" : \"{{GetInstanceOSInfo.platform}}\",\n        \"StringEquals\" : \"Linux\"\n      } ]\n    }\n  }, {\n    \"name\" : \"InstallPowerShellOnLinux\",\n    \"action\" : \"aws:runCommand\",\n    \"inputs\" : {\n      \"DocumentName\" : \"AWS-RunShellScript\",\n      \"InstanceIds\" : \"{{ InstanceId }}\",\n      \"Parameters\" : {\n        \"commands\" : \"if [ \\\"$(which pwsh > /dev/null 2>&1; echo $?)\\\" -ne \\\"0\\\" ]\\nthen\\n   sudo apt-get install -y powershell\\nfi\"\n      }\n    }\n  }, {\n    \"name\" : \"ExecuteReindexing\",\n    \"action\" : \"aws:runCommand\",\n    \"inputs\" : {\n      \"DocumentName\" : \"AWS-RunPowerShellScript\",\n      \"InstanceIds\" : \"{{ InstanceId }}\",\n      \"Parameters\" : {\n        \"commands\" : [ \"function VerifySignature { param( [Parameter(Mandatory=$true)] $FilePath, [Parameter(Mandatory=$true)] $SignatureFilePath ) $code = \\\" using System; using System.IO; using System.Security.Cryptography; namespace Crypto { public class CryptoHelper { public static bool VerifySignature(string FilePath, string SignatureFilePath) { try { var modulus = Convert.FromBase64String(\\\"\\\"68hw9z3PIC7u5VkEoWeOI+f63hf3+FTDidjgEYkbsGVJ/8Yip0tIyk7rw84AEA9mlZ8c9k5U0dZo18fLGYhRkfgytLVwaXXU8083DwTGj5n8TvTrKss8ugschfGQJIanyWR7eRFLxuYZS5fo2lxur8K+6rc7yDgM+zQTzoOz2GDcTMm3MY3aST9/SShmJLoc6yoekXifyCebSFt8PZ0lmARFiHupepDrZlqXKY/490MlEiZz2fh7RjOORTDZo85Ai/prxxRuHnXrlIBDCbWfCqPCphJD9IMYcbFUxMfL1M7WXCheAtPpzJjMpdLQ+QIzOY1gdvTxx9ml4BtcdXyyE1BE0gFmR8QHBzJIE6KWE7OSEQpPnqwJ+zkA79Mr9/Ud4gdKeI2rGWN7quspSn7nCXcfbG+j9Rc0JMpKgaVLhfXxC0/xWS6JO4HCgrfh5rXWjAN+HVeHDI2iuPOALrHSUPK9hFudqDWSCEhBO3WcVTeg7dzU2M8rx92ypfbThEhczwXQ3yXGbojUzEPv8M24tOsjDZtPlyErE9xwtVY4UBUuJPsjbxLYx/Bq8Fg79liIVITRDH+UQFGws3YZe8EqSOpyk8hY6rOXXXU0uVLpjMny1tmxngdFRaTnQtNUoqV4NBT1wTTSNKEx/O04fEfU7Jha6oaeZ1NaL4F4wApmAh0=\\\"\\\"); var exponent = Convert.FromBase64String(\\\"\\\"AQAB\\\"\\\"); var rsa = RSA.Create(new RSAParameters {Exponent = exponent, Modulus = modulus}); using (var stream = File.OpenRead(FilePath)) { var signatureBytes = File.ReadAllBytes(SignatureFilePath); var bytesToVerify = SHA256.Create().ComputeHash(stream); return rsa.VerifyData(bytesToVerify, signatureBytes, HashAlgorithmName.SHA256, RSASignaturePadding.Pkcs1); } } catch (Exception e) { Console.WriteLine(e.ToString()); return false; } } } } \\\"; Add-Type -TypeDefinition $code -Language CSharp -ErrorAction Stop; return [Crypto.CryptoHelper]::VerifySignature($FilePath, $SignatureFilePath); }\\nfunction ExecuteScript { param( [Parameter(Mandatory=$true)] $ScriptFileName, [Parameter(Mandatory=$true)] $ScriptExpression )\\n$ExitCode = 1; $Result = \\\"\\\"; $TempFolder = Join-Path -Path ([System.IO.Path]::GetTempPath()) -ChildPath ([System.Guid]::NewGuid()); $null = New-Item -ItemType Directory -Path $TempFolder -ErrorAction Stop; try { $MaintenanceZip = \\\"aws-maintenance.zip\\\"; $MaintenanceZipSig = \\\"aws-maintenance.zip.sig\\\"; $Prefix = \\\"45985c0a-2152-4931-b859-74b2b5f26cb1\\\"; $Stage  = \\\"prod\\\"; $Region = \\\"{{global:REGION}}\\\"; $S3Domain = \\\"s3.amazonaws.com\\\"; if ($Region.Contains(\\\"gov\\\")) { $S3Domain = \\\"s3-$Region.amazonaws.com\\\"; } $URI=\\\"https://launchwizardscript-$Stage-$Region.$S3Domain/$Prefix/Maintenance/\\\"; $ZipFile = Join-Path -Path $TempFolder -ChildPath $MaintenanceZip; $ZipFileSig = Join-Path -Path $TempFolder -ChildPath $MaintenanceZipSig; $ScriptPath = Join-Path -Path $TempFolder -ChildPath \\\"Maintenance\\\"; $ScriptPath = Join-Path -Path $ScriptPath -ChildPath $ScriptFileName; $ProgressPreference = \\\"SilentlyContinue\\\"; $global:ProgressPreference = \\\"SilentlyContinue\\\"; $null = Invoke-WebRequest -Uri ($URI+$MaintenanceZip) -OutFile $ZipFile -ErrorAction Stop; $null = Invoke-WebRequest -Uri ($URI+$MaintenanceZipSig) -OutFile $ZipFileSig -ErrorAction Stop; if ((VerifySignature $ZipFile $ZipFileSig) -ne $true) { throw \\\"Signature validation failed\\\" }; $null = Expand-Archive -Path $ZipFile -DestinationPath $TempFolder -ErrorAction Stop; $ScriptBlock = [scriptblock]::Create(\\\". $ScriptPath; $ScriptExpression\\\"); $Result = Invoke-Command -ScriptBlock $ScriptBlock -ErrorAction Stop; } catch { Write-Output $_.Exception; } finally { $Null = Remove-Item $TempFolder -Recurse -Force -ErrorAction SilentlyContinue; if (($null -eq $Result) -or ($Result.GetType().FullName -eq \\\"System.String\\\")) { Write-Output \\\"Unknown execution failure $Result\\\"; exit(1) } else { $Len = $Result.Length-1; $ExitCode = $Result[$Len]; $Len2 = $Len-1; Write-Output $Result[0..$Len2]; exit($ExitCode) } } } try { Set-StrictMode -Version latest; $Map = @{\\\"Do nothing\\\" = \\\"DoNothing\\\"; \\\"Build index online\\\" = \\\"BuildOnline\\\"; \\\"Rebuild index offline\\\" = \\\"RebuildOffline\\\"; \\\"Reorganize index\\\" = \\\"Reorganize\\\"; \\\"Build index online, with offline fallback\\\" = \\\"BuildOnlineThenRebuildOffline\\\"; \\\"Build index online, with reorganize fallback\\\" = \\\"BuildOnlineThenReorganize\\\"; \\\"Reorganize index, with online fallback, then offline fallback\\\"=\\\"ReorganizeThenBuildOnlineThenRebuildOffline\\\"}; $Low=$Map[\\\"{{LowFragmentIndexAction}}\\\"]; $Medium=$Map[\\\"{{MediumFragmentIndexAction}}\\\"]; $High=$Map[\\\"{{HighFragmentIndexAction}}\\\"]; $ReindexType=\\\"ReindexAllTables\\\"; $ReindexTableExpression=\\\"\\\";\\nif (\\\"{{ReindexTableList}}\\\" -ne \\\"\\\") { $ReindexTableExpression = \\\"-ReindexTableList {{ReindexTableList}}\\\"; $ReindexType=\\\"ReindexSpecificTables\\\" };\\n$ScriptExpression = \\\"ReindexDatabase -Databases {{Database}} -SecretsManagerId {{SecretsMangerCredential}} \\\" + \\\"-ReindexOptions LowFragmentIndexAction=$Low,MediumFragmentIndexAction=$Medium,\\\" + \\\"HighFragmentIndexAction=$High,UseTempDbForReindexing={{UseTempDbForReindexing}},\\\" + \\\"IncludeMSShippedObjects={{IncludeMSShippedObjects}},MaxDOP={{MaxDOP}},ReindexType=$ReindexType \\\" + \\\"$ReindexTableExpression\\\"; ExecuteScript -ScriptFileName \\\"aws-sqlreindexing.ps1\\\" -ScriptExpression $ScriptExpression } catch { Write-Output $_.Exception; exit(1) }\" ],\n        \"executionTimeout\" : \"172800\"\n      }\n    },\n    \"timeoutSeconds\" : 172800\n  } ]\n}",
  "CreatedDate": "2023-03-16T01:02:41.624Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Automation"
  },
  "DocumentVersion": "14",
  "Name": "AWSSQLServer-Index",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "b1422bfb-ad81-4cca-b84b-712a9ba00720",
    "Metadata": {},
    "ChecksumAlgorithm": 0,
    "ChecksumValidationStatus": 0
  },
  "ContentLength": 12966,
  "HttpStatusCode": 200,
  "LoggedAt": "2023-05-06T07:12:31.4384102+00:00"
}
