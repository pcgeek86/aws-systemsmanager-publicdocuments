{
  "AttachmentsContent": [],
  "Content": "{\n  \"outputs\" : [ \"createImage.ImageId\" ],\n  \"schemaVersion\" : \"0.3\",\n  \"description\" : \"Install seller packages on an AMI. This is a public document used by AWSMP Image Building Service. Do not alter the contents, modify permissions or delete this document.\",\n  \"assumeRole\" : \"{{ ssmAutomationRoleArn }}\",\n  \"parameters\" : {\n    \"subnetId\" : {\n      \"default\" : \"subnet-a39a38da\",\n      \"description\" : \"Subnet Id to use\",\n      \"type\" : \"String\"\n    },\n    \"installTimeoutInSeconds\" : {\n      \"default\" : \"3600\",\n      \"description\" : \"Timeout in seconds for installation to time out\",\n      \"type\" : \"String\"\n    },\n    \"sourceImageId\" : {\n      \"description\" : \"AMI to patch\",\n      \"type\" : \"String\"\n    },\n    \"userData\" : {\n      \"description\" : \"Base64 encoded user data\",\n      \"type\" : \"String\"\n    },\n    \"instanceType\" : {\n      \"description\" : \"Instance type to use\",\n      \"type\" : \"String\"\n    },\n    \"packageUrls\" : {\n      \"description\" : \"package URLs, separated by |\",\n      \"type\" : \"String\"\n    },\n    \"installScript\" : {\n      \"description\" : \"Install script\",\n      \"type\" : \"StringList\"\n    },\n    \"launchBlockDeviceMappings\" : {\n      \"description\" : \"Block Device Mappings when launching EC2\",\n      \"type\" : \"MapList\"\n    },\n    \"outputS3KeyPrefix\" : {\n      \"description\" : \"Key prefix for storing the logs\",\n      \"type\" : \"String\"\n    },\n    \"ssmAutomationRoleArn\" : {\n      \"default\" : \"arn:aws:iam::342722375477:role/SSMAutomationRole\",\n      \"description\" : \"SSM Automation role ARN to use\",\n      \"type\" : \"String\"\n    },\n    \"securityGroupId\" : {\n      \"default\" : [ \"sg-259c755b\" ],\n      \"description\" : \"Security group Id to use\",\n      \"type\" : \"StringList\"\n    },\n    \"marketplaceInstanceTagValue\" : {\n      \"description\" : \"Build ID generated by image building service\",\n      \"type\" : \"String\"\n    },\n    \"installCommand\" : {\n      \"description\" : \"install command\",\n      \"type\" : \"String\"\n    },\n    \"outputS3BucketName\" : {\n      \"description\" : \"Name of S3 bucket to store install command output\",\n      \"type\" : \"String\"\n    },\n    \"targetImageName\" : {\n      \"description\" : \"Name of new AMI\",\n      \"type\" : \"String\"\n    },\n    \"targetImageDescription\" : {\n      \"default\" : \"\",\n      \"description\" : \"Description of new AMI\",\n      \"type\" : \"String\"\n    },\n    \"fileNames\" : {\n      \"description\" : \"file names, separated by |\",\n      \"type\" : \"String\"\n    },\n    \"marketplaceInstanceTagKey\" : {\n      \"description\" : \"Marketplace tag attached to instances launched from image building service\",\n      \"type\" : \"String\"\n    },\n    \"ssmInstanceProfileName\" : {\n      \"default\" : \"SSMInstanceProfile\",\n      \"description\" : \"Instance profile to use\",\n      \"type\" : \"String\"\n    }\n  },\n  \"mainSteps\" : [ {\n    \"maxAttempts\" : 3,\n    \"inputs\" : {\n      \"IamInstanceProfileName\" : \"{{ ssmInstanceProfileName }}\",\n      \"MaxInstanceCount\" : 1,\n      \"TagSpecifications\" : [ {\n        \"ResourceType\" : \"instance\",\n        \"Tags\" : [ {\n          \"Value\" : \"{{ marketplaceInstanceTagValue }}\",\n          \"Key\" : \"{{ marketplaceInstanceTagKey }}\"\n        } ]\n      } ],\n      \"UserData\" : \"{{ userData }}\",\n      \"BlockDeviceMappings\" : \"{{ launchBlockDeviceMappings }}\",\n      \"ImageId\" : \"{{ sourceImageId }}\",\n      \"SubnetId\" : \"{{ subnetId }}\",\n      \"InstanceType\" : \"{{ instanceType }}\",\n      \"SecurityGroupIds\" : \"{{ securityGroupId }}\",\n      \"MinInstanceCount\" : 1\n    },\n    \"name\" : \"launchInstance\",\n    \"action\" : \"aws:runInstances\",\n    \"onFailure\" : \"Abort\",\n    \"timeoutSeconds\" : 1200\n  }, {\n    \"maxAttempts\" : 3,\n    \"inputs\" : {\n      \"OutputS3KeyPrefix\" : \"{{ outputS3KeyPrefix }}\",\n      \"Parameters\" : {\n        \"executionTimeout\" : \"{{ installTimeoutInSeconds }}\",\n        \"commands\" : \"{{ installScript }}\"\n      },\n      \"InstanceIds\" : [ \"{{ launchInstance.InstanceIds }}\" ],\n      \"OutputS3BucketName\" : \"{{ outputS3BucketName }}\",\n      \"DocumentName\" : \"AWS-RunShellScript\"\n    },\n    \"name\" : \"installPackages\",\n    \"action\" : \"aws:runCommand\",\n    \"onFailure\" : \"Abort\",\n    \"timeoutSeconds\" : 9000\n  }, {\n    \"maxAttempts\" : 3,\n    \"inputs\" : {\n      \"OutputS3KeyPrefix\" : \"{{ outputS3KeyPrefix }}\",\n      \"Parameters\" : {\n        \"commands\" : [ \"CLOUD_DIR=\\\"/var/lib/cloud\\\"; if test -d \\\"$CLOUD_DIR\\\"; then DATA_DIR=\\\"$CLOUD_DIR/data\\\"; SCRIPTS_DIR=\\\"$CLOUD_DIR/scripts\\\"; HANDLERS_DIR=\\\"$CLOUD_DIR/handlers\\\"; INSTANCES_DIR=\\\"$CLOUD_DIR/instances\\\"; INSTANCE_LINK=\\\"$CLOUD_DIR/instance\\\"; SEM_DIR=\\\"$CLOUD_DIR/sem\\\"; rm -rf \\\"$DATA_DIR\\\" \\\"$SCRIPTS_DIR\\\" \\\"$HANDLERS_DIR\\\" \\\"$INSTANCES_DIR\\\" \\\"$SEM_DIR\\\" \\\"$INSTANCE_LINK\\\"; else echo \\\"Directory $CLOUD_DIR not found\\\"; fi\", \"echo \\\"removing all keys generated by cloud-init\\\";  find /etc /root /home -type f -name 'authorized_keys' -print0 | xargs -0 rm -f\" ]\n      },\n      \"InstanceIds\" : [ \"{{ launchInstance.InstanceIds }}\" ],\n      \"OutputS3BucketName\" : \"{{ outputS3BucketName }}\",\n      \"DocumentName\" : \"AWS-RunShellScript\"\n    },\n    \"name\" : \"resetCloudInit\",\n    \"action\" : \"aws:runCommand\",\n    \"onFailure\" : \"Abort\",\n    \"timeoutSeconds\" : 600\n  }, {\n    \"maxAttempts\" : 3,\n    \"inputs\" : {\n      \"DesiredState\" : \"stopped\",\n      \"InstanceIds\" : [ \"{{ launchInstance.InstanceIds }}\" ]\n    },\n    \"name\" : \"stopInstance\",\n    \"action\" : \"aws:changeInstanceState\",\n    \"onFailure\" : \"Continue\"\n  }, {\n    \"maxAttempts\" : 3,\n    \"inputs\" : {\n      \"ImageName\" : \"{{ targetImageName }}\",\n      \"InstanceId\" : \"{{ launchInstance.InstanceIds }}\",\n      \"ImageDescription\" : \"{{ targetImageDescription }}\"\n    },\n    \"name\" : \"createImage\",\n    \"action\" : \"aws:createImage\",\n    \"onFailure\" : \"Continue\",\n    \"timeoutSeconds\" : 3600\n  }, {\n    \"maxAttempts\" : 3,\n    \"inputs\" : {\n      \"DesiredState\" : \"terminated\",\n      \"InstanceIds\" : [ \"{{ launchInstance.InstanceIds }}\" ]\n    },\n    \"name\" : \"terminateInstance\",\n    \"action\" : \"aws:changeInstanceState\",\n    \"onFailure\" : \"Abort\"\n  } ]\n}",
  "CreatedDate": "2022-02-10T22:19:34.884Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Automation"
  },
  "DocumentVersion": "1",
  "Name": "arn:aws:ssm:us-west-2:342722375477:document/AWSMarketplaceImageBuild-LinuxPackageInstallerV1",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "5c26e568-b8df-4c00-8535-2006a92126aa",
    "Metadata": {},
    "ChecksumAlgorithm": 0,
    "ChecksumValidationStatus": 0
  },
  "ContentLength": 6874,
  "HttpStatusCode": 200,
  "LoggedAt": "2022-05-28T07:13:55.8837064+00:00"
}
