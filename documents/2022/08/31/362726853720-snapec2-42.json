{
  "AttachmentsContent": [],
  "Content": "{\n  \"schemaVersion\": \"0.3\",\n  \"assumeRole\": \"{{ AutomationAssumeRole }}\",\n  \"description\": \"Take Snapshots of EC2 instances based on Tag/Value.\",\n  \"parameters\": {\n      \"AutomationAssumeRole\": {\n          \"default\": \"\",\n          \"description\": \"(Optional) The ARN role that allows Automation to execute this runbook.\",\n          \"type\": \"String\"\n      },\n      \"awsRegion\": {\n      \"description\": \"(Optional) AWS Region of the instance.\",\n      \"type\": \"String\",\n      \"default\": \"us-west-2\"\n      },\n      \"stage\": {\n        \"description\": \"(Required) Stage of target lambda function.\",\n        \"type\": \"String\"\n      },\n      \"tagKey\": {\n          \"description\": \"(Required) tag Key of EC2 instance.\",\n          \"type\": \"String\",\n          \"default\": \"snapshot\"\n      },\n      \"tagValue\": {\n          \"description\": \"(Required) tag Value of EC2 instance.\",\n          \"type\": \"String\",\n          \"default\": \"true\"\n      }\n  },\n  \"mainSteps\": [\n    {\n      \"name\": \"Get_Tagged_Instanceids\",\n      \"action\": \"aws:invokeLambdaFunction\",\n      \"onFailure\": \"Abort\",\n      \"maxAttempts\": 3,\n      \"inputs\": {\n        \"FunctionName\": \"arn:aws:lambda:us-west-2:{{ global:ACCOUNT_ID }}:function:get-instance-ids-{{ stage }}-get_instance_ids\",\n        \"Payload\": \"{ \\\"tag_key\\\": \\\"{{ tagKey }}\\\", \\\"tag_value\\\": \\\"{{ tagValue }}\\\" }\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"instance_ids\",\n          \"Selector\": \"$.instance_ids\",\n          \"Type\": \"String\"\n        }\n        ],\n        \"nextStep\": \"Get_Tagged_Instanceids_List\"\n    },\n    {\n      \"name\": \"Get_Tagged_Instanceids_List\",\n      \"action\": \"aws:executeAwsApi\",\n      \"timeoutSeconds\": 300,\n      \"onFailure\": \"Abort\",\n      \"maxAttempts\": 1,\n      \"inputs\": {\n        \"Service\": \"ec2\",\n        \"Api\": \"DescribeInstances\",\n        \"Filters\": [\n          {\n            \"Name\": \"tag:{{ tagKey }}\", \n            \"Values\": [\n              \"{{ tagValue }}\"\n              ]\n          }\n        ]\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"instance_ids\",\n          \"Selector\": \"$.Reservations..Instances..InstanceId\",\n          \"Type\": \"StringList\"\n        }\n      ],\n      \"nextStep\": \"Stop_Ec2_Instances\"\n    },\n    {\n      \"name\": \"Stop_Ec2_Instances\",\n      \"action\": \"aws:invokeLambdaFunction\",\n      \"onFailure\": \"Abort\",\n      \"maxAttempts\": 3,\n      \"inputs\": {\n        \"FunctionName\": \"arn:aws:lambda:us-west-2:{{ global:ACCOUNT_ID }}:function:stop-ec2-{{ stage }}-stop_ec2\",\n        \"Payload\": \"{ \\\"instance_ids\\\": {{ Get_Tagged_Instanceids.instance_ids }} }\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"instance_ids\",\n          \"Selector\": \"$.instance_ids\",\n          \"Type\": \"String\"\n        },\n        {\n          \"Name\": \"instance_state\",\n          \"Selector\": \"$.instance_state\",\n          \"Type\": \"String\"\n        }\n        ],\n        \"nextStep\": \"Trigger_AMI_Creation\"\n    },\n    {\n      \"name\":\"Trigger_AMI_Creation\",\n      \"action\":\"aws:invokeLambdaFunction\",\n      \"isCritical\": true,\n      \"onFailure\": \"Abort\",\n      \"maxAttempts\": 1,\n      \"inputs\": {\n        \"FunctionName\": \"arn:aws:lambda:us-west-2:{{ global:ACCOUNT_ID }}:function:ssm-dynamodb-putitem-{{ stage }}-lambda_handler\",\n        \"Payload\": \"{\\\"snippet\\\": \\\"create-ec2-ami\\\", \\\"snippet-arn\\\": \\\"arn:aws:lambda:us-west-2:{{ global:ACCOUNT_ID }}:function:create-ec2-ami-{{ stage }}-create_ec2_ami\\\", \\\"input\\\": { \\\"instance_ids\\\": {{ Get_Tagged_Instanceids.instance_ids }} }, \\\"target\\\": {\\\"instance_id\\\": \\\"\\\"}}\"\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"request_id\",\n          \"Selector\": \"$.request_id\",\n          \"Type\": \"String\"\n        }\n        ],\n        \"nextStep\": \"Wait_60_secs\"\n    },\n    {\n      \"name\": \"Wait_60_secs\",\n      \"action\": \"aws:sleep\",\n      \"inputs\": {\n        \"Duration\": \"PT60S\"\n      },\n      \"nextStep\": \"Get_AMI_Ids\"\n    },\n    {\n      \"name\": \"Get_AMI_Ids\",\n      \"action\": \"aws:executeAwsApi\",\n      \"timeoutSeconds\": 300,\n      \"onFailure\": \"Abort\",\n      \"maxAttempts\": 1,\n      \"inputs\": {\n        \"Service\": \"ec2\",\n        \"Api\": \"DescribeImages\",\n        \"Filters\": [\n          {\n            \"Name\": \"tag:request_id\", \n            \"Values\": [\n              \"{{ Trigger_AMI_Creation.request_id }}\"\n              ]\n          }\n          ]\n      },\n      \"outputs\": [\n        {\n          \"Name\": \"image_ids\",\n          \"Selector\": \"$.Images..ImageId\",\n          \"Type\": \"StringList\"\n        }\n        ],\n        \"nextStep\": \"Check_AMI_Status\"\n    },\n    {\n      \"name\": \"Check_AMI_Status\",\n      \"action\": \"aws:waitForAwsResourceProperty\",\n      \"timeoutSeconds\": 3000,\n      \"onFailure\": \"Abort\",\n      \"maxAttempts\": 1,\n      \"inputs\": {\n        \"Service\": \"ec2\",\n        \"Api\": \"DescribeImages\",\n        \"ImageIds\": \"{{ Get_AMI_Ids.image_ids }}\",\n        \"PropertySelector\": \"$.Images..State\",\n        \"DesiredValues\":[\n          \"available\"\n          ]\n      },\n      \"nextStep\": \"Start_Ec2\"\n    },\n    {\n      \"name\": \"Start_Ec2\",\n      \"action\": \"aws:executeAwsApi\",\n      \"timeoutSeconds\": 300,\n      \"onFailure\": \"Abort\",\n      \"maxAttempts\": 1,\n      \"inputs\": {\n        \"Service\": \"ec2\",\n        \"Api\": \"StartInstances\",\n        \"InstanceIds\": \"{{ Get_Tagged_Instanceids_List.instance_ids }}\"\n      },\n      \"nextStep\": \"Check_EC2_Status\"\n    },\n    {\n      \"name\": \"Check_EC2_Status\",\n      \"action\": \"aws:waitForAwsResourceProperty\",\n      \"timeoutSeconds\": 300,\n      \"onFailure\": \"Abort\",\n      \"maxAttempts\": 1,\n      \"inputs\": {\n        \"Service\": \"ec2\",\n        \"Api\": \"DescribeInstances\",\n        \"Filters\": [\n          {\n            \"Name\": \"tag:{{ tagKey }}\", \n            \"Values\": [\n              \"{{ tagValue }}\"\n              ]\n          }\n        ],\n        \"PropertySelector\": \"$.Reservations..Instances..State.Name\",\n        \"DesiredValues\":[\n          \"running\"\n          ]\n      }\n    }\n  ]\n}",
  "CreatedDate": "2019-10-07T09:36:05.406Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Automation"
  },
  "DocumentVersion": "42",
  "Name": "arn:aws:ssm:us-west-2:362726853720:document/snapec2",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "a37780bd-9076-4457-8495-323073f61679",
    "Metadata": {},
    "ChecksumAlgorithm": 0,
    "ChecksumValidationStatus": 0
  },
  "ContentLength": 6777,
  "HttpStatusCode": 200,
  "LoggedAt": "2022-08-31T07:35:35.751488+00:00"
}
