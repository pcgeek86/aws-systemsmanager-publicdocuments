{
  "AttachmentsContent": [],
  "Content": "{\n  \"schemaVersion\": \"2.2\",\n  \"description\": \"install/uninstall Sophos-central antivirus\",\n  \"parameters\": {\n    \"action\": {\n      \"description\": \"(Required) Specify the action.\",\n      \"type\": \"String\",\n      \"allowedValues\": [\"Install\", \"Uninstall\"]\n    },\n    \"installerURL\": {\n      \"description\": \"(Required for install) installer download link\",\n      \"type\": \"String\",\n      \"default\": \"\"\n    },\n    \"powershellModuleURL\": {\n      \"description\": \"(Required for Windows platform) RaxServer powershell module url\",\n      \"type\": \"String\",\n      \"default\": \"\"\n    },\n    \"GetSophosDeviceIdSSMDocument\": {\n      \"description\": \"(Required for install) of SSM document ARN\",\n      \"type\": \"String\",\n      \"default\": \"arn:aws:ssm:us-west-2:248147738891:document/Rackspace-SophosDeviceId\"\n    },\n    \"workingDirectory\": {\n      \"type\": \"String\",\n      \"default\": \"\",\n      \"description\": \"(Optional) The path where the content will be downloaded and executed from on your instance.\",\n      \"maxChars\": 4096\n    },\n    \"executionTimeout\": {\n      \"description\": \"(Optional) Time in seconds for a command to complete before it is considered to have failed.\",\n      \"type\": \"String\",\n      \"default\": \"3600\",\n      \"allowedPattern\": \"([1-9][0-9]{0,3})|(1[0-9]{1,4})|(2[0-7][0-9]{1,3})|(28[0-7][0-9]{1,2})|(28800)\"\n    }\n  },\n  \"mainSteps\": [\n    {\n      \"precondition\": {\n        \"StringEquals\": [\"platformType\", \"Windows\"]\n      },\n      \"action\": \"aws:runPowerShellScript\",\n      \"name\": \"InstallUninstallSophosCentralWindows\",\n      \"inputs\": {\n        \"runCommand\":[\"$raxServerModuleUrl = '{{powershellModuleURL}}'\",\"$dir = Join-Path $env:TEMP 'sophos-central'\",\"$ZipFile = Join-Path $dir 'RaxServer.16.4.0.zip'\",\"$raxServerModuleDir = Join-Path $dir 'RaxServer.16.4.0'\",\"$raxServerModule = Join-Path $raxServerModuleDir 'RaxServer.psd1'\",\"\",\"if (!(Test-Path $dir)) {\",\"    New-Item -ItemType directory -Path $dir -Force | Out-Null\",\"}\",\"\",\"Remove-Item $raxServerModuleDir -Force -Recurse -ErrorAction SilentlyContinue | Out-Null\",\"Remove-Item $ZipFile -Force -ErrorAction SilentlyContinue | Out-Null\",\"\",\"try {\",\"    Write-Output \\\"Downloading RaxServer module from $raxServerModuleUrl\\\"\",\"    Invoke-WebRequest -Uri $raxServerModuleUrl -OutFile $ZipFile -ErrorAction Stop\",\"\",\"    if (!(Test-Path -Path $ZipFile -PathType Leaf)) {\",\"        Write-Error \\\"Failed to download RaxServer module\\\"\",\"        exit 1\",\"    }\",\"\",\"    Write-Output \\\"Extracting RaxServer module to $raxServerModuleDir\\\"\",\"    Expand-Archive -Path $ZipFile -DestinationPath $raxServerModuleDir -Force -ErrorAction Stop\",\"\",\"    if (!(Test-Path -Path $raxServerModule -PathType Leaf)) {\",\"        Write-Error \\\"Failed to extract RaxServer module\\\"\",\"        exit 1\",\"    }\",\"\",\"    Write-Output \\\"Importing RaxServer module\\\"\",\"    Import-Module $raxServerModule -ErrorAction Stop\",\"\",\"    $Config = Get-SophosCentralConfiguration -ErrorAction Stop\",\"    if ('{{action}}' -eq 'Install' -and -not $Config.IsInstalled) {\",\"        $installerUri = '{{installerURL}}'\",\"        Write-Output \\\"Installing Sophos Central from $installerUri\\\"\",\"        Install-SophosCentral -InstallerUri $installerUri -ErrorAction Stop\",\"    } elseif ('{{action}}' -eq 'Uninstall' -and $Config.IsInstalled) {\",\"        Write-Output \\\"Uninstalling Sophos Central\\\"\",\"        Uninstall-SophosCentral -ErrorAction Stop\",\"    } else {\",\"        Write-Output \\\"Skipping Sophos Central installation\\\"\",\"    }\",\"\",\"} catch {\",\"    Write-Error \\\"Error: $_\\\"\",\"    exit 1\",\"} finally {\",\"    Remove-Item $raxServerModuleDir -Force -Recurse -ErrorAction SilentlyContinue | Out-Null\",\"    Remove-Item $ZipFile -Force -ErrorAction SilentlyContinue | Out-Null\",\"}\"],\n        \"onFailure\": \"exit\",\n        \"workingDirectory\": \"{{ workingDirectory }}\",\n        \"timeoutSeconds\": \"{{ executionTimeout }}\"\n      }\n    },\n    {\n      \"precondition\": {\n        \"StringEquals\": [\"platformType\", \"Linux\"]\n      },\n      \"action\": \"aws:runShellScript\",\n      \"name\": \"InstallUninstallSophosCentralLinux\",\n      \"inputs\": {\n        \"runCommand\":[\"#!/usr/bin/env bash\",\"\",\"SOPHOS_INSTALL_DIR=\\\"/opt/sophos-spl\\\"\",\"\",\"function is_sspl_installed()\",\"{\",\"    systemctl is-enabled sophos-spl.service \\u0026\\u003e /dev/null\",\"}\",\"\",\"function sophos_precheck()\",\"{\",\"    if is_sspl_installed \\u0026\\u0026 [ -d \\\"$SOPHOS_INSTALL_DIR\\\" ]; then\",\"        return 0\",\"    fi\",\"    return 1\",\"}\",\"\",\"if [[ \\\"{{action}}\\\" == \\\"Install\\\" ]]; then\",\"    SOPHOS_INSTALLER_URL=\\\"{{installerURL}}\\\"\",\"    INSTALLER_FILE_NAME=${SOPHOS_INSTALLER_URL##*/}\",\"\",\"    if command -v curl \\u0026\\u003e /dev/null; then\",\"        download_cmd=\\\"curl -sSO\\\"\",\"    elif command -v wget \\u0026\\u003e /dev/null; then\",\"        download_cmd=\\\"wget -q\\\"\",\"    else\",\"        echo \\\"Error: neither curl nor wget is installed.\\\"\",\"        exit 1\",\"    fi\",\"\",\"    if sophos_precheck; then\",\"        echo \\\"Sophos Linux Protection is already installed, aborting install.\\\"\",\"        exit 0\",\"    fi\",\"\",\"    $download_cmd \\\"$SOPHOS_INSTALLER_URL\\\"\",\"    if [ ! -f \\\"$INSTALLER_FILE_NAME\\\" ]; then\",\"        echo \\\"Error: failed to download installer file from $SOPHOS_INSTALLER_URL\\\"\",\"        exit 1\",\"    fi\",\"\",\"    chmod +x \\\"$INSTALLER_FILE_NAME\\\"\",\"    sudo ./\\\"$INSTALLER_FILE_NAME\\\"\",\"elif [[ \\\"{{action}}\\\" == \\\"Uninstall\\\" ]]; then\",\"    if sophos_precheck; then\",\"        echo \\\"Found Sophos Linux Protection, uninstalling....\\\"\",\"        echo y | sudo \\\"$SOPHOS_INSTALL_DIR/bin/uninstall.sh\\\"\",\"    else\",\"        echo \\\"Sophos Linux protection is not installed, aborting uninstall.\\\"\",\"    fi\",\"else\",\"    echo \\\"Error: invalid action '{{action}}'\\\"\",\"    exit 1\",\"fi\",\"\",\"exit $?\",\"\"],\n        \"onFailure\": \"exit\",\n        \"workingDirectory\": \"{{ workingDirectory }}\",\n        \"timeoutSeconds\": \"{{ executionTimeout }}\"\n      }\n    },\n    {\n      \"precondition\": {\n        \"StringEquals\": [\"{{ action }}\", \"Install\"]\n      },\n      \"action\": \"aws:runDocument\",\n      \"name\": \"GetSophosDeviceId\",\n      \"inputs\": {\n        \"documentType\": \"SSMDocument\",\n        \"documentPath\": \"{{ GetSophosDeviceIdSSMDocument }}\"\n      }\n    }\n  ]\n}",
  "CreatedDate": "2023-05-05T17:55:53.615Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Command"
  },
  "DocumentVersion": "1",
  "Name": "arn:aws:ssm:us-west-2:248147738891:document/Rackspace-ManageSophosCentral",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "66ec983b-f3f9-47dc-8b09-ace35b005dcc",
    "Metadata": {},
    "ChecksumAlgorithm": 0,
    "ChecksumValidationStatus": 0
  },
  "ContentLength": 6967,
  "HttpStatusCode": 200,
  "LoggedAt": "2023-05-08T07:13:32.4460448+00:00"
}
