{
  "AttachmentsContent": [],
  "Content": "{\n  \"description\" : \"### Document name - AWSConfigRemediation-DetachAndDeleteVirtualPrivateGateway\\n\\n## What does this document do?\\nThis runbook detaches and deletes a given Amazon Elastic Compute Cloud (Amazon EC2) virtual private gateway attached to an Amazon Virtual Private Cloud (Amazon VPC) using the [DeleteVpnGateway](https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DeleteVpnGateway.html) API.\\n\\n## Input Parameters\\n* AutomationAssumeRole: (Required) The Amazon Resource Name (ARN) of the AWS Identity and Access Management (IAM) role that allows Systems Manager Automation to perform the actions on your behalf.\\n* VpnGatewayId: (Required) The ID of the virtual private gateway to be deleted.\\n\\n## Output Parameters\\n* DeleteVPNGateway.Output: The standard HTTP response of the DeleteVpnGateway API call.\\n\",\n  \"schemaVersion\" : \"0.3\",\n  \"assumeRole\" : \"{{ AutomationAssumeRole }}\",\n  \"outputs\" : [ \"DeleteVPNGateway.Output\" ],\n  \"parameters\" : {\n    \"AutomationAssumeRole\" : {\n      \"type\" : \"String\",\n      \"description\" : \"(Required) The Amazon Resource Name (ARN) of the AWS Identity and Access Management (IAM) role that allows Systems Manager Automation to perform the actions on your behalf.\",\n      \"allowedPattern\" : \"^arn:(aws[a-zA-Z-]*)?:iam::\\\\d{12}:role/[\\\\w+=,.@-]+\"\n    },\n    \"VpnGatewayId\" : {\n      \"type\" : \"String\",\n      \"description\" : \"(Required) The ID of the virtual private gateway to be deleted.\",\n      \"allowedPattern\" : \"^vgw-[a-z0-9]+$\"\n    }\n  },\n  \"mainSteps\" : [ {\n    \"name\" : \"WaitUntilVPNGatewayIsAvailable\",\n    \"description\" : \"## WaitUntilVPNGatewayIsAvailable\\nAccepts the ID of the virtual private gateway and waits until the virtual private gateway's state property changes to `available` or times out.\\n\",\n    \"action\" : \"aws:waitForAwsResourceProperty\",\n    \"timeoutSeconds\" : 600,\n    \"isEnd\" : false,\n    \"isCritical\" : true,\n    \"inputs\" : {\n      \"Service\" : \"ec2\",\n      \"Api\" : \"DescribeVpnGateways\",\n      \"VpnGatewayIds\" : [ \"{{ VpnGatewayId }}\" ],\n      \"PropertySelector\" : \"$.VpnGateways[0].State\",\n      \"DesiredValues\" : [ \"available\" ]\n    }\n  }, {\n    \"name\" : \"GetVPNGatewayDetails\",\n    \"description\" : \"## GetVPNGatewayDetails\\nRetrieves a specified virtual private gateway configuration.\\n\",\n    \"action\" : \"aws:executeAwsApi\",\n    \"inputs\" : {\n      \"Service\" : \"ec2\",\n      \"Api\" : \"DescribeVpnGateways\",\n      \"VpnGatewayIds\" : [ \"{{ VpnGatewayId }}\" ]\n    },\n    \"outputs\" : [ {\n      \"Name\" : \"VgwState\",\n      \"Selector\" : \"$.VpnGateways[0].State\",\n      \"Type\" : \"String\"\n    }, {\n      \"Name\" : \"VgwVpcAttachState\",\n      \"Selector\" : \"$.VpnGateways[0].VpcAttachments[0].State\",\n      \"Type\" : \"String\"\n    }, {\n      \"Name\" : \"VgwVpcId\",\n      \"Selector\" : \"$.VpnGateways[0].VpcAttachments[0].VpcId\",\n      \"Type\" : \"String\"\n    } ]\n  }, {\n    \"name\" : \"BranchOnVpcAttachmentStatus\",\n    \"description\" : \"## BranchOnVpcAttachmentStatus\\nBranches based on the VpcAttachments.state parameter value.\\n\",\n    \"action\" : \"aws:branch\",\n    \"onFailure\" : \"Abort\",\n    \"isCritical\" : true,\n    \"maxAttempts\" : 2,\n    \"isEnd\" : true,\n    \"timeoutSeconds\" : 60,\n    \"inputs\" : {\n      \"Choices\" : [ {\n        \"Variable\" : \"{{ GetVPNGatewayDetails.VgwVpcAttachState }}\",\n        \"StringEquals\" : \"attaching\",\n        \"NextStep\" : \"WaitUntilAttachedState\"\n      }, {\n        \"Variable\" : \"{{ GetVPNGatewayDetails.VgwVpcAttachState }}\",\n        \"StringEquals\" : \"detaching\",\n        \"NextStep\" : \"WaitUntilDetachedState\"\n      }, {\n        \"Variable\" : \"{{ GetVPNGatewayDetails.VgwVpcAttachState }}\",\n        \"StringEquals\" : \"attached\",\n        \"NextStep\" : \"DetachVPNGateway\"\n      }, {\n        \"Variable\" : \"{{ GetVPNGatewayDetails.VgwVpcAttachState }}\",\n        \"StringEquals\" : \"detached\",\n        \"NextStep\" : \"DeleteVPNGateway\"\n      } ],\n      \"Default\" : \"DeleteVPNGateway\"\n    }\n  }, {\n    \"name\" : \"WaitUntilAttachedState\",\n    \"description\" : \"## WaitUntilAttachedState\\nAccepts the ID of the virtual private gateway and waits until the virtual private gateway's VpcAttachments.state's property changes to `attached` or times out.\\n\",\n    \"action\" : \"aws:waitForAwsResourceProperty\",\n    \"timeoutSeconds\" : 600,\n    \"isEnd\" : false,\n    \"nextStep\" : \"DetachVPNGateway\",\n    \"isCritical\" : true,\n    \"inputs\" : {\n      \"Service\" : \"ec2\",\n      \"Api\" : \"DescribeVpnGateways\",\n      \"VpnGatewayIds\" : [ \"{{ VpnGatewayId }}\" ],\n      \"PropertySelector\" : \"$.VpnGateways[0].VpcAttachments[0].State\",\n      \"DesiredValues\" : [ \"attached\" ]\n    }\n  }, {\n    \"name\" : \"DetachVPNGateway\",\n    \"description\" : \"## DetachVPNGateway\\nAccepts the ID of the virtual private gateway and the ID of the Amazon VPC as input, and detaches the virtual private gateway from the Amazon VPC.\\n\",\n    \"action\" : \"aws:executeAwsApi\",\n    \"inputs\" : {\n      \"Service\" : \"ec2\",\n      \"Api\" : \"DetachVpnGateway\",\n      \"VpcId\" : \"{{ GetVPNGatewayDetails.VgwVpcId }}\",\n      \"VpnGatewayId\" : \"{{ VpnGatewayId }}\"\n    },\n    \"outputs\" : [ {\n      \"Name\" : \"Output\",\n      \"Selector\" : \"$\",\n      \"Type\" : \"StringMap\"\n    } ]\n  }, {\n    \"name\" : \"WaitUntilDetachedState\",\n    \"description\" : \"## WaitUntilDetachedState\\nAccepts the ID of the virtual private gateway and waits until the virtual private gateway's VpcAttachments.state's property changes to `detached` or times out.\\n\",\n    \"action\" : \"aws:waitForAwsResourceProperty\",\n    \"timeoutSeconds\" : 600,\n    \"isEnd\" : false,\n    \"nextStep\" : \"DeleteVPNGateway\",\n    \"isCritical\" : true,\n    \"inputs\" : {\n      \"Service\" : \"ec2\",\n      \"Api\" : \"DescribeVpnGateways\",\n      \"VpnGatewayIds\" : [ \"{{ VpnGatewayId }}\" ],\n      \"PropertySelector\" : \"$.VpnGateways[0].VpcAttachments[0].State\",\n      \"DesiredValues\" : [ \"detached\" ]\n    }\n  }, {\n    \"name\" : \"DeleteVPNGateway\",\n    \"description\" : \"## DeleteVPNGateway\\nAccepts the ID of the virtual private gateway as input and deletes it.\\n\",\n    \"action\" : \"aws:executeAwsApi\",\n    \"isEnd\" : false,\n    \"inputs\" : {\n      \"Service\" : \"ec2\",\n      \"Api\" : \"DeleteVpnGateway\",\n      \"VpnGatewayId\" : \"{{ VpnGatewayId }}\"\n    },\n    \"outputs\" : [ {\n      \"Name\" : \"Output\",\n      \"Selector\" : \"$\",\n      \"Type\" : \"StringMap\"\n    } ]\n  }, {\n    \"name\" : \"VerifyVPNGatewayDeletion\",\n    \"description\" : \"## VerifyVPNGatewayDeletion\\nAccepts the ID of the virtual private gateway as input and verifies its deletion.\\n\",\n    \"action\" : \"aws:waitForAwsResourceProperty\",\n    \"isEnd\" : true,\n    \"inputs\" : {\n      \"Service\" : \"ec2\",\n      \"Api\" : \"DescribeVpnGateways\",\n      \"VpnGatewayIds\" : [ \"{{ VpnGatewayId }}\" ],\n      \"PropertySelector\" : \"$.VpnGateways[0].State\",\n      \"DesiredValues\" : [ \"deleted\" ]\n    }\n  } ]\n}",
  "CreatedDate": "2021-03-10T16:12:39.3Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Automation"
  },
  "DocumentVersion": "1",
  "Name": "AWSConfigRemediation-DetachAndDeleteVirtualPrivateGateway",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "65f24f3c-5b17-423c-b028-a38b3a733720",
    "Metadata": {}
  },
  "ContentLength": 7516,
  "HttpStatusCode": 200,
  "LoggedAt": "2022-01-16T07:11:49.9069236+00:00"
}
