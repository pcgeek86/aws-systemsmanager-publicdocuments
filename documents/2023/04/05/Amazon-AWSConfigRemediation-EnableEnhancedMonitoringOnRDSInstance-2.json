{
  "AttachmentsContent": [],
  "Content": "{\n  \"schemaVersion\" : \"0.3\",\n  \"description\" : \"### Document Name - AWSConfigRemediation-EnableEnhancedMonitoringOnRDSInstance\\n\\n## What does this document do?\\nThis document is used to enable enhanced monitoring on an RDS Instance using the input parameter DB Instance resourceId.\\n\\n## Input Parameters\\n* ResourceId: (Required) Resource ID of the RDS DB Instance.\\n* MonitoringInterval: (Optional)\\n   * The interval, in seconds, between points when Enhanced Monitoring metrics are collected for the DB instance.\\n   * If MonitoringRoleArn is specified, then you must also set MonitoringInterval to a value other than 0.\\n   * Valid Values: 1, 5, 10, 15, 30, 60\\n   * Default: 60\\n* MonitoringRoleArn: (Required) The ARN for the IAM role that permits RDS to send enhanced monitoring metrics to Amazon CloudWatch Logs.\\n* AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.\\n\\n## Output Parameters\\n* EnableEnhancedMonitoring.DbInstance - The standard HTTP response from the ModifyDBInstance API.\\n\",\n  \"assumeRole\" : \"{{ AutomationAssumeRole }}\",\n  \"parameters\" : {\n    \"AutomationAssumeRole\" : {\n      \"type\" : \"String\",\n      \"description\" : \"(Required) The ARN of the role that allows Automation to perform the actions on your behalf.\",\n      \"allowedPattern\" : \"^arn:(aws[a-zA-Z-]*)?:iam::\\\\d{12}:role/[a-zA-Z0-9+=,.@_/-]+$\"\n    },\n    \"ResourceId\" : {\n      \"type\" : \"String\",\n      \"description\" : \"(Required) Resource ID of the Amazon RDS instance for which Enhanced Monitoring needs to be enabled.\",\n      \"allowedPattern\" : \"db-[A-Z0-9]{26}\"\n    },\n    \"MonitoringInterval\" : {\n      \"type\" : \"Integer\",\n      \"description\" : \"(Optional) The interval, in seconds, between points when Enhanced Monitoring metrics are collected for the DB instance.\",\n      \"default\" : 60,\n      \"allowedValues\" : [ 1, 5, 10, 15, 30, 60 ]\n    },\n    \"MonitoringRoleArn\" : {\n      \"type\" : \"String\",\n      \"description\" : \"(Required) The ARN for the IAM role that permits RDS to send enhanced monitoring metrics to Amazon CloudWatch Logs.\",\n      \"allowedPattern\" : \"^arn:(aws[a-zA-Z-]*)?:iam::\\\\d{12}:role/[a-zA-Z0-9+=,.@_/-]+$\"\n    }\n  },\n  \"outputs\" : [ \"EnableEnhancedMonitoring.DbInstance\" ],\n  \"mainSteps\" : [ {\n    \"name\" : \"DescribeDBInstances\",\n    \"action\" : \"aws:executeAwsApi\",\n    \"description\" : \"## DescribeDBInstances\\n  Makes describeDBInstances API call using RDS Instance DbiResourceId to get DBInstanceId.\\n## Outputs\\n* DbInstanceIdentifier: DBInstance Identifier of the RDS Instance.\\n\",\n    \"timeoutSeconds\" : 600,\n    \"isEnd\" : false,\n    \"inputs\" : {\n      \"Service\" : \"rds\",\n      \"Api\" : \"DescribeDBInstances\",\n      \"Filters\" : [ {\n        \"Name\" : \"dbi-resource-id\",\n        \"Values\" : [ \"{{ ResourceId }}\" ]\n      } ]\n    },\n    \"outputs\" : [ {\n      \"Name\" : \"DbInstanceIdentifier\",\n      \"Selector\" : \"$.DBInstances[0].DBInstanceIdentifier\",\n      \"Type\" : \"String\"\n    } ]\n  }, {\n    \"name\" : \"VerifyDBInstanceStatus\",\n    \"action\" : \"aws:assertAwsResourceProperty\",\n    \"timeoutSeconds\" : 600,\n    \"isEnd\" : false,\n    \"description\" : \"## VerifyDBInstanceStatus\\nVerifies if DB Instance status is available before enabling enhanced monitoring.\\n\",\n    \"inputs\" : {\n      \"Service\" : \"rds\",\n      \"Api\" : \"DescribeDBInstances\",\n      \"DBInstanceIdentifier\" : \"{{ DescribeDBInstances.DbInstanceIdentifier }}\",\n      \"PropertySelector\" : \"$.DBInstances[0].DBInstanceStatus\",\n      \"DesiredValues\" : [ \"available\" ]\n    }\n  }, {\n    \"name\" : \"EnableEnhancedMonitoring\",\n    \"action\" : \"aws:executeAwsApi\",\n    \"description\" : \"## EnableEnhancedMonitoring\\n  Makes ModifyDBInstance API call to enable Enhanced Monitoring on the RDS Instance\\n  using the DBInstanceId from the previous action.\\n## Outputs\\n  * DbInstance: The standard HTTP response from the ModifyDBInstance API.\\n\",\n    \"timeoutSeconds\" : 600,\n    \"isEnd\" : false,\n    \"inputs\" : {\n      \"Service\" : \"rds\",\n      \"Api\" : \"ModifyDBInstance\",\n      \"ApplyImmediately\" : false,\n      \"DBInstanceIdentifier\" : \"{{ DescribeDBInstances.DbInstanceIdentifier }}\",\n      \"MonitoringInterval\" : \"{{ MonitoringInterval }}\",\n      \"MonitoringRoleArn\" : \"{{ MonitoringRoleArn }}\"\n    },\n    \"outputs\" : [ {\n      \"Name\" : \"DbInstance\",\n      \"Selector\" : \"$\",\n      \"Type\" : \"StringMap\"\n    } ]\n  }, {\n    \"name\" : \"VerifyEnhancedMonitoringEnabled\",\n    \"action\" : \"aws:executeScript\",\n    \"description\" : \"## VerifyEnhancedMonitoringEnabled\\nChecks that the enhanced monitoring is enabled on RDS Instance in the previous step exists.\\n## Outputs\\n* Output: The standard HTTP response from the ModifyDBInstance API.\\n\",\n    \"isEnd\" : true,\n    \"timeoutSeconds\" : 600,\n    \"inputs\" : {\n      \"Runtime\" : \"python3.6\",\n      \"Handler\" : \"handler\",\n      \"InputPayload\" : {\n        \"MonitoringInterval\" : \"{{ MonitoringInterval }}\",\n        \"DBIdentifier\" : \"{{ DescribeDBInstances.DbInstanceIdentifier }}\"\n      },\n      \"Script\" : \"import boto3\\nimport time\\n\\ndef handler(event, context):\\n    rds_client = boto3.client(\\\"rds\\\")\\n    db_instance_id = event[\\\"DBIdentifier\\\"]\\n    monitoring_interval = event[\\\"MonitoringInterval\\\"]\\n\\n    try:\\n        rds_waiter = rds_client.get_waiter(\\\"db_instance_available\\\")\\n        rds_waiter.wait(DBInstanceIdentifier=db_instance_id)\\n\\n        db_instances = rds_client.describe_db_instances(\\n            DBInstanceIdentifier=db_instance_id)\\n\\n        for db_instance in db_instances.get(\\\"DBInstances\\\", [{}]):\\n            db_monitoring_interval = db_instance.get(\\\"MonitoringInterval\\\")\\n\\n        if db_monitoring_interval == monitoring_interval:\\n            return {\\n                      \\\"output\\\": db_instances[\\\"ResponseMetadata\\\"]\\n                    }\\n        else:\\n            info = \\\"VERIFICATION FAILED. RDS INSTANCE MONITORING INTERVAL {} IS NOT ENABLED WITH THE REQUIRED VALUE {}\\\".format(\\n                    db_monitoring_interval, monitoring_interval)\\n            raise Exception(info)\\n    except Exception as e:\\n        raise e\"\n    },\n    \"outputs\" : [ {\n      \"Name\" : \"Output\",\n      \"Selector\" : \"$.Payload.output\",\n      \"Type\" : \"StringMap\"\n    } ]\n  } ]\n}",
  "CreatedDate": "2020-09-08T17:27:52.22Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Automation"
  },
  "DocumentVersion": "2",
  "Name": "AWSConfigRemediation-EnableEnhancedMonitoringOnRDSInstance",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "8c117c84-8029-4b63-addb-cbfd20716102",
    "Metadata": {},
    "ChecksumAlgorithm": 0,
    "ChecksumValidationStatus": 0
  },
  "ContentLength": 6852,
  "HttpStatusCode": 200,
  "LoggedAt": "2023-04-05T07:11:16.9345825+00:00"
}
