{
  "AttachmentsContent": [],
  "Content": "{\n  \"description\" : \"Disable SSH and RDP ports opened to IP address specified, or to all addresses if no address is specified. Similar to the [RevokeSecurityGroupIngress](https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_RevokeSecurityGroupIngress.html) API, the security group must have existing rules specifically on the SSH and RDP ports in order for ingress to be disabled.\",\n  \"schemaVersion\" : \"0.3\",\n  \"assumeRole\" : \"{{ AutomationAssumeRole }}\",\n  \"parameters\" : {\n    \"GroupId\" : {\n      \"type\" : \"String\",\n      \"description\" : \"(Required) Security Group ID\",\n      \"allowedPattern\" : \"^([s][g]\\\\-)([0-9a-f]){1,}$\"\n    },\n    \"IpAddressToBlock\" : {\n      \"type\" : \"String\",\n      \"description\" : \"(Optional) Additional Ipv4 or Ipv6 address to block access from (ex:1.2.3.4/32)\",\n      \"allowedPattern\" : \"(^$)|^((25[0-5]|(2[0-4]\\\\d|[0-1]?\\\\d?\\\\d)(\\\\.(25[0-5]|2[0-4]\\\\d|[0-1]?\\\\d?\\\\d)){3})|(^((?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)?)::((?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)?))|(^(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}))\\\\/(25[0-5]|2[0-4]\\\\d|[0-1]?\\\\d?\\\\d)$\",\n      \"default\" : \"\"\n    },\n    \"AutomationAssumeRole\" : {\n      \"type\" : \"String\",\n      \"description\" : \"(Optional) The ARN of the role that allows Automation to perform the actions on your behalf.\",\n      \"default\" : \"\"\n    }\n  },\n  \"mainSteps\" : [ {\n    \"name\" : \"CustomIpCheck\",\n    \"action\" : \"aws:branch\",\n    \"inputs\" : {\n      \"Choices\" : [ {\n        \"NextStep\" : \"DisableSSHFromCustomIpV6\",\n        \"And\" : [ {\n          \"Not\" : {\n            \"Variable\" : \"{{IpAddressToBlock}}\",\n            \"StringEquals\" : \"\"\n          }\n        }, {\n          \"Variable\" : \"{{ IpAddressToBlock }}\",\n          \"Contains\" : \":\"\n        } ]\n      }, {\n        \"NextStep\" : \"DisableSSHFromCustomIpV4\",\n        \"And\" : [ {\n          \"Not\" : {\n            \"Variable\" : \"{{IpAddressToBlock}}\",\n            \"StringEquals\" : \"\"\n          }\n        }, {\n          \"Not\" : {\n            \"Variable\" : \"{{ IpAddressToBlock }}\",\n            \"Contains\" : \":\"\n          }\n        } ]\n      } ],\n      \"Default\" : \"DisableSSHFromIpV4\"\n    }\n  }, {\n    \"name\" : \"DisableSSHFromIpV4\",\n    \"action\" : \"aws:executeAwsApi\",\n    \"inputs\" : {\n      \"Service\" : \"ec2\",\n      \"Api\" : \"RevokeSecurityGroupIngress\",\n      \"GroupId\" : \"{{GroupId}}\",\n      \"IpPermissions\" : [ {\n        \"IpProtocol\" : \"tcp\",\n        \"FromPort\" : 22,\n        \"ToPort\" : 22,\n        \"IpRanges\" : [ {\n          \"CidrIp\" : \"0.0.0.0/0\"\n        } ]\n      } ]\n    },\n    \"onFailure\" : \"Continue\"\n  }, {\n    \"name\" : \"DisableSSHFromIpV6\",\n    \"action\" : \"aws:executeAwsApi\",\n    \"inputs\" : {\n      \"Service\" : \"ec2\",\n      \"Api\" : \"RevokeSecurityGroupIngress\",\n      \"GroupId\" : \"{{GroupId}}\",\n      \"IpPermissions\" : [ {\n        \"IpProtocol\" : \"tcp\",\n        \"FromPort\" : 22,\n        \"ToPort\" : 22,\n        \"Ipv6Ranges\" : [ {\n          \"CidrIpv6\" : \"::/0\"\n        } ]\n      } ]\n    },\n    \"onFailure\" : \"Continue\"\n  }, {\n    \"name\" : \"DisableRDPFromIpV4\",\n    \"action\" : \"aws:executeAwsApi\",\n    \"inputs\" : {\n      \"Service\" : \"ec2\",\n      \"Api\" : \"RevokeSecurityGroupIngress\",\n      \"GroupId\" : \"{{GroupId}}\",\n      \"IpPermissions\" : [ {\n        \"IpProtocol\" : \"tcp\",\n        \"FromPort\" : 3389,\n        \"ToPort\" : 3389,\n        \"IpRanges\" : [ {\n          \"CidrIp\" : \"0.0.0.0/0\"\n        } ]\n      } ]\n    },\n    \"onFailure\" : \"Continue\"\n  }, {\n    \"name\" : \"DisableRDPFromIpV6\",\n    \"action\" : \"aws:executeAwsApi\",\n    \"inputs\" : {\n      \"Service\" : \"ec2\",\n      \"Api\" : \"RevokeSecurityGroupIngress\",\n      \"GroupId\" : \"{{GroupId}}\",\n      \"IpPermissions\" : [ {\n        \"IpProtocol\" : \"tcp\",\n        \"FromPort\" : 3389,\n        \"ToPort\" : 3389,\n        \"Ipv6Ranges\" : [ {\n          \"CidrIpv6\" : \"::/0\"\n        } ]\n      } ]\n    },\n    \"isEnd\" : true,\n    \"onFailure\" : \"Continue\"\n  }, {\n    \"name\" : \"DisableSSHFromCustomIpV4\",\n    \"action\" : \"aws:executeAwsApi\",\n    \"inputs\" : {\n      \"Service\" : \"ec2\",\n      \"Api\" : \"RevokeSecurityGroupIngress\",\n      \"GroupId\" : \"{{GroupId}}\",\n      \"IpPermissions\" : [ {\n        \"IpProtocol\" : \"tcp\",\n        \"FromPort\" : 22,\n        \"ToPort\" : 22,\n        \"IpRanges\" : [ {\n          \"CidrIp\" : \"{{ IpAddressToBlock }}\"\n        } ]\n      } ]\n    },\n    \"onFailure\" : \"Continue\"\n  }, {\n    \"name\" : \"DisableRDPFromCustomIpV4\",\n    \"action\" : \"aws:executeAwsApi\",\n    \"inputs\" : {\n      \"Service\" : \"ec2\",\n      \"Api\" : \"RevokeSecurityGroupIngress\",\n      \"GroupId\" : \"{{GroupId}}\",\n      \"IpPermissions\" : [ {\n        \"IpProtocol\" : \"tcp\",\n        \"FromPort\" : 3389,\n        \"ToPort\" : 3389,\n        \"IpRanges\" : [ {\n          \"CidrIp\" : \"{{ IpAddressToBlock }}\"\n        } ]\n      } ]\n    },\n    \"isEnd\" : true,\n    \"onFailure\" : \"Continue\"\n  }, {\n    \"name\" : \"DisableSSHFromCustomIpV6\",\n    \"action\" : \"aws:executeAwsApi\",\n    \"inputs\" : {\n      \"Service\" : \"ec2\",\n      \"Api\" : \"RevokeSecurityGroupIngress\",\n      \"GroupId\" : \"{{GroupId}}\",\n      \"IpPermissions\" : [ {\n        \"IpProtocol\" : \"tcp\",\n        \"FromPort\" : 22,\n        \"ToPort\" : 22,\n        \"Ipv6Ranges\" : [ {\n          \"CidrIpv6\" : \"{{ IpAddressToBlock }}\"\n        } ]\n      } ]\n    },\n    \"onFailure\" : \"Continue\"\n  }, {\n    \"name\" : \"DisableRDPFromCustomIpV6\",\n    \"action\" : \"aws:executeAwsApi\",\n    \"inputs\" : {\n      \"Service\" : \"ec2\",\n      \"Api\" : \"RevokeSecurityGroupIngress\",\n      \"GroupId\" : \"{{GroupId}}\",\n      \"IpPermissions\" : [ {\n        \"IpProtocol\" : \"tcp\",\n        \"FromPort\" : 3389,\n        \"ToPort\" : 3389,\n        \"Ipv6Ranges\" : [ {\n          \"CidrIpv6\" : \"{{ IpAddressToBlock }}\"\n        } ]\n      } ]\n    },\n    \"isEnd\" : true,\n    \"onFailure\" : \"Continue\"\n  } ]\n}",
  "CreatedDate": "2021-02-23T18:35:12.1Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Automation"
  },
  "DocumentVersion": "1",
  "Name": "AWS-DisablePublicAccessForSecurityGroup",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "c00a2ec0-02bc-4ebf-a9ac-055f102190e1",
    "Metadata": {},
    "ChecksumAlgorithm": 0,
    "ChecksumValidationStatus": 0
  },
  "ContentLength": 6497,
  "HttpStatusCode": 200,
  "LoggedAt": "2022-07-12T07:12:02.0387391+00:00"
}
