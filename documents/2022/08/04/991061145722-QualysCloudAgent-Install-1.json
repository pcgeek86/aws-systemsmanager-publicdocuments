{
  "AttachmentsContent": [],
  "Content": "{\n  \"schemaVersion\": \"2.2\",\n  \"description\": \"Manage Qualys Cloud Agent on EC2 instances\",\n  \"parameters\": {\n    \"ActivationID\": {\n      \"type\": \"String\",\n      \"description\": \"(Required) Enter ActivationID obtained from Qualys CP \"\n    },\n    \"CustomerID\": {\n      \"type\": \"String\",\n      \"description\": \"(Required) Enter CustomerID as displayed in your account\"\n    },\n    \"AgentLocationWindows\": {\n      \"type\": \"String\",\n      \"default\": \"\",\n      \"description\": \"(Optional) Enter FQDN or full path of Windows Qualys Cloud Agent Installer's location\"\n    },\n    \"AgentLocationDebian\": {\n      \"type\": \"String\",\n      \"default\": \"\",\n      \"description\": \"(Optional) Enter FQDN or full path of Debian Qualys Cloud Agent Installer's location\"\n    },\n    \"AgentLocationRPM\": {\n      \"type\": \"String\",\n      \"default\": \"\",\n      \"description\": \"(Optional) Enter FQDN or full path of RPM Qualys Cloud Agent Installer's location\"\n    },\n    \"LogLevel\": {\n      \"type\": \"String\",\n      \"default\": \"0\",\n      \"description\": \"(Optional)  A higher value corresponds to more verbosity. Default is to report only errors (0) \",\n      \"allowedValues\": [\n        \"0\",\n        \"1\",\n        \"2\",\n        \"3\",\n        \"4\",\n        \"5\"\n      ]\n    }\n  },\n  \"mainSteps\": [\n    {\n      \"precondition\": {\n        \"StringEquals\": [\n          \"platformType\",\n          \"Linux\"\n        ]\n      },\n      \"action\": \"aws:runShellScript\",\n      \"name\": \"InstallQualysCloudAgentOnLinux\",\n      \"inputs\": {\n        \"id\": \"0.aws:runShellScript\",\n        \"timeoutSeconds\": 600,\n        \"runCommand\": [\n          \"#!/bin/bash\",\n          \"#set -eux\",\n          \"#Check Whether the Qualys Cloud Agent is already installed\",\n          \"status=$( sudo service qualys-cloud-agent status | grep Active )\",\n          \"if [[ -z \\\"$status\\\" ]];\",\n          \"then\",\n          \"     # Check whether curl or wget is present in the system\",\n          \"     if hash curl 2>/dev/null\",\n          \"     then\",\n          \"         DOWNLOAD_CMD=\\\"curl -s --fail --retry 5 --max-time 30\\\"\",\n          \"         CONSOLE_ARG=\\\"\\\"\",\n          \"         TO_FILE_ARG=\\\" -o \\\"\",\n          \"         HEADER_ARG=\\\" --head \\\"\",\n          \"     else\",\n          \"         DOWNLOAD_CMD=\\\"wget --quiet --tries=5 --timeout=30 \\\"\",\n          \"         CONSOLE_ARG=\\\" -qO- \\\"\",\n          \"         TO_FILE_ARG=\\\" -O \\\"\",\n          \"         HEADER_ARG=\\\" -S --spider \\\"\",\n          \"     fi\",\n          \"     # Check whether the OS is Debian or RPM based Linux and set the download location\",\n          \"     os=$( grep -Ei 'debian|buntu|mint' /etc/*release )\",\n          \"     if [[ -n \\\"$os\\\" || -f \\\"/etc/debian_version\\\" ]];\",\n          \"     then\",\n          \"         INSTALLER_FILE_URL={{ AgentLocationDebian }}\",\n          \"         opersys=\\\"DEB\\\"\",\n          \"     else\",\n          \"         INSTALLER_FILE_URL={{ AgentLocationRPM }}\",\n          \"         opersys=\\\"RPM\\\"\",\n          \"     fi\",\n          \"     Downloadfile()\",\n          \"     {\",\n          \"         ${DOWNLOAD_CMD} ${TO_FILE_ARG} qualys-cloud-agent.x86_64 ${INSTALLER_FILE_URL}\",\n          \"         if [[ $? != 0 ]];\",\n          \"         then\",\n          \"             echo \\\"Failed to download installer from ${INSTALLER_FILE_URL}\\\"\",\n          \"             exit 3\",\n          \"         fi\",\n          \"     }\",\n          \"     # Checks whether agent location is a FQDN or full path and invoke download or copy function \",\n          \"     if [[ -n \\\"$INSTALLER_FILE_URL\\\" ]]; \",\n          \"     then\",\n          \"         if [[ \\\"${INSTALLER_FILE_URL:0:4}\\\" == 'http' ]] ; \",\n          \"         then\",\n          \"                 Downloadfile\",\n          \"         else\",\n          \"             cp $INSTALLER_FILE_URL qualys-cloud-agent.x86_64 \",\n          \"         fi\",\n          \"     else\",\n          \"         echo \\\"No installation path specified for Qualys Cloud Agent\\\"\",\n          \"             exit 4\",\n          \"     fi\",\n          \"     if [ \\\"$opersys\\\" = \\\"RPM\\\" ];\",\n          \"     then\",\n          \"                 sleep 5\",\n          \"                 sudo rpm -ivh qualys-cloud-agent.x86_64\",\n          \"                 sleep 5\",\n          \"                 sudo /usr/local/qualys/cloud-agent/bin/qualys-cloud-agent.sh LogLevel={{ LogLevel }} ActivationId={{ ActivationID }} CustomerId={{ CustomerID }}\",\n          \"     else\",\n          \"         sudo dpkg --install qualys-cloud-agent.x86_64\",\n          \"         sleep 5\",\n          \"         sudo /usr/local/qualys/cloud-agent/bin/qualys-cloud-agent.sh LogLevel={{ LogLevel }} ActivationId={{ ActivationID }} CustomerId={{ CustomerID }}\",\n          \"     fi\",\n          \"else\",\n          \"echo \\\"QualysCloudAgent is already installed on this and running\\\"\",\n          \"fi\"\n        ]\n      }\n    },\n    {\n      \"precondition\": {\n        \"StringEquals\": [\n          \"platformType\",\n          \"Windows\"\n        ]\n      },\n      \"action\": \"aws:runPowerShellScript\",\n      \"name\": \"InstallQualysCloudAgentOnWindows\",\n      \"inputs\": {\n        \"id\": \"0.aws:runPowerShellScript\",\n        \"timeoutSeconds\": 600,\n        \"runCommand\": [\n          \"function New-TemporaryDirectory {\",\n          \"  $parent = [System.IO.Path]::GetTempPath()\",\n          \"  [string] $name = [System.Guid]::NewGuid()\",\n          \"  New-Item -ItemType Directory -Path (Join-Path $parent $name)\",\n          \"}\",\n          \"$tempdir = New-TemporaryDirectory\",\n          \"Set-Location -Path $tempdir\",\n          \"$agentInstaller=\\\"QualysCloudAgent.exe\\\"\",\n          \"$agentInstallerlog=Join-Path $tempdir $agentInstaller\",\n          \"if (Get-Service \\\"QualysAgent\\\" -ErrorAction SilentlyContinue)\",\n          \"{\",\n          \"  Write-Host \\\"Qualys Cloud Agent is already installed, Exiting\\\"\",\n          \"  exit 0\",\n          \"}\",\n          \"#Download the Qualys Cloud agent\",\n          \"Function Download_file\",\n          \"{\",\n          \"     Try\",\n          \"     {\",\n          \"         Invoke-WebRequest $installerUrl -OutFile $agentInstallerlog\",\n          \"     }\",\n          \"     Catch\",\n          \"     {\",\n          \"         Write-Host \\\"Error while downloading installer\\\"\",\n          \"         Write-Host $_.Exception|format-list -force\",\n          \"         exit 3\",\n          \"     }\",\n          \"}\",\n          \"#Check whether agent location is a FQDN or full path and invoke download or copy function\",\n          \"if ('{{ AgentLocationWindows }}' -ne '')\",\n          \"{\",\n          \"     $installerUrl = '{{ AgentLocationWindows }}'\",\n          \"     if ( $installerUrl.Substring(0,4) -eq 'http')\",\n          \"     {\",\n          \"         Download_file\",\n          \"     }\",\n          \"     Else\",\n          \"     {\",\n          \"         Copy-Item $agentInstallerlog \",\n          \"     }\",\n          \"}\",\n          \"Else \",\n          \"{\",\n          \"     Write-Host \\\"No installation path specified for Qualys Cloud Agent\\\"\",\n          \"     exit 5\",\n          \"}\",\n          \"# Install the Qualys Cloud Agent\",\n          \"Try\",\n          \"{\",\n          \"     & $agentInstallerlog CustomerId={{ CustomerID }} ActivationId={{ ActivationID }}\",\n          \"}\",\n          \"Catch\",\n          \"{\",\n          \"     Write-Host \\\"Installation failed, exception raised during installation\\\"\",\n          \"     Write-Host $_.Exception|format-list -force\",\n          \"     exit 6\",\n          \"}\"\n        ]\n      }\n    }\n  ]\n}",
  "CreatedDate": "2018-12-20T05:21:59.164Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Command"
  },
  "DocumentVersion": "1",
  "Name": "arn:aws:ssm:us-west-2:457721770691:document/QualysCloudAgent-Install",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "2f65b9ea-dd23-426b-8bc5-8f448330e988",
    "Metadata": {},
    "ChecksumAlgorithm": 0,
    "ChecksumValidationStatus": 0
  },
  "ContentLength": 8301,
  "HttpStatusCode": 200,
  "LoggedAt": "2022-08-04T07:13:08.9530426+00:00"
}
