{
  "AttachmentsContent": [],
  "Content": "{\n  \"schemaVersion\": \"2.2\",\n\"description\": \"Command for Experience studio \",\n  \"parameters\": {\n    \"JiraId\": {\n      \"type\": \"String\",\n      \"description\": \"Jira ID of the ticket\",\n      \"default\": \"\"\n    },\n    \"JiraUrl\": {\n      \"type\": \"String\",\n      \"description\": \"URL of Jira Server\",\n      \"default\": \"http://beetle.egain.com\"\n    },\n    \"TemplateUrl\": {\n      \"type\": \"String\",\n      \"description\": \"xstemplate.zip url attached on Jira ticket\",\n      \"default\": \"\"\n    },\n    \"RequestJsonUrl\": {\n      \"type\": \"String\",\n      \"description\": \"request.json url attached on Jira ticket\",\n      \"default\": \"\"\n    },\n    \"Proxy\": {\n      \"type\": \"String\",\n      \"description\": \"request.json url attached on Jira ticket\",\n      \"default\": \"aworinfraproxy.egain.cloud\"\n    },\n    \"RollBack\": {\n      \"type\": \"String\",\n      \"description\": \"Perform RollBack\",\n      \"default\": \"false\"\n    }\n  },\n  \"mainSteps\": [\n    {\n      \"action\": \"aws:runPowerShellScript\",\n      \"name\": \"example\",\n      \"inputs\": {\n        \"timeoutSeconds\": \"300\",\n        \"runCommand\": [\n          \"$jira_id = \\\"{{JiraId}}\\\"\",\n          \"$attach_url = \\\"{{JiraUrl}}/rest/api/2/issue/$jira_id/attachments\\\"\",\n          \"$xstemplate_url = \\\"{{TemplateUrl}}\\\"\",\n          \"$request_json_url = \\\"{{RequestJsonUrl}}\\\"\",\n          \"$proxy = \\\"{{Proxy}}\\\"\",\n          \"$roll_back = \\\"{{ RollBack }}\\\"\",\n          \"$port = 800\",\n          \"$user = 'cloudbot'\",\n          \"Import-Module AWSPowershell\",\n          \"Set-AWSProxy -HostName $proxy -Port $port\",\n          \"$pass = (Get-SSMParameterValue -Name $user -WithDecryption $True -region 'us-west-2').Parameters.Value\",\n          \"$pair = \\\"$($user):$($pass)\\\"\",\n          \"$encodedCreds = [System.Convert]::ToBase64String([System.Text.Encoding]::ASCII.GetBytes($pair))\",\n          \"$basicAuthValue = \\\"Basic $encodedCreds\\\"\",\n          \"$Headers = @{\",\n          \"\\\"Authorization\\\" = $basicAuthValue\",\n          \"\\\"X-Atlassian-Token\\\" = \\\"nocheck\\\"\",\n          \"}\",\n          \"$dir = 'C:\\\\SALogs\\\\exp_studio\\\\' + $jira_id\",\n          \"if(!(Test-Path -Path $dir)){\",\n          \"New-Item -ItemType directory -Path $dir\",\n          \"Write-Output \\\"Folder $dir created\\\"\",\n          \"}\",\n          \"Set-Location $dir\",\n          \"if ($roll_back -eq 'true'){\",\n          \"  Copy-Item -Path \\\\\\\\aworstznas01\\\\AutomationShare\\\\Scripts\\\\experience_studio\\\\\\\\rollback.bat -Destination $dir\\\\\\\\rollback.bat\",\n          \"}\",\n          \"else{\",\n          \"  if(!(Test-Path -Path $dir\\\\copy.bat)){\",\n          \"  Copy-Item -Path \\\\\\\\aworstznas01\\\\AutomationShare\\\\Scripts\\\\experience_studio\\\\\\\\copy.bat -Destination $dir\\\\\\\\copy.bat\",\n          \"  }\",\n          \"}\",\n          \"$wc = New-Object System.Net.WebClient\",\n          \"$wc.Headers.Add(\\\"Authorization\\\", $Headers.Authorization)\",\n          \"$wc.Headers.Add(\\\"X-Atlassian-Token\\\", \\\"nocheck\\\")\",\n          \"$sproxy = New-Object System.Net.WebProxy\",\n          \"$sproxy.Address = 'http://' + $proxy + \\\":\\\" + $port\",\n          \"$wc.Proxy = $sproxy\",\n          \"$template_zip_filename = \\\"$dir\\\\xstemplate.zip\\\"\",\n          \"$request_json_filename = \\\"$dir\\\\request.json\\\"\",\n          \"function remove-file {\",\n          \"param($fileName)\",\n          \"if (Test-Path $fileName){\",\n          \"  Remove-Item $fileName\",\n          \" }\",\n          \"}\",\n          \"remove-file($template_zip_filename)\",\n          \"remove-file($request_json_filename)\",\n          \"Write-Output 'Begin downloading templates files from jira'\",\n          \"$wc.DownloadFile($xstemplate_url, $template_zip_filename)\",\n          \"$wc.DownloadFile($request_json_url, $request_json_filename)\",\n          \"Write-Output 'Finished downloading templates files from jira'\",\n          \"$hostname = HostName\",\n          \"if ($roll_back -eq 'true'){\",\n          \"try{\",\n          \"$process_list = Get-WmiObject Win32_Process -filter {CommandLine LIKE '%copy.bat%' and  CommandLine LIKE '%JIRA_ID=%'}\",\n          \"Write-Output 'Rollback : checking and trying to kill any instance of copy.bat'\",\n          \"Foreach($process in $process_list)\",\n          \"{\",\n          \"Write-Output \\\"Trying to kill instance of copy.bat with process id $($process.ProcessId)\\\"\",\n          \" Stop-Process -Id $($process.ProcessId) -Force \",\n          \"}\",\n          \"} \",\n          \"Catch{ \",\n          \"Write-Output \\\"Error Occurred while trying to kill Copy.bat. Error message is  $_.Exception\\\" \",\n          \"    exit -1\",\n          \"}\",\n          \"Write-Output 'Trigerring the rollback process now'\",\n          \"  $rollback_process = Start-Process -FilePath cmd -Verb RunAs -ArgumentList '/C', \\\"rollback.bat \\\"\\\"EGAIN_HOME=D:\\\\eGain\\\"\\\" \\\"\\\"JIRA_ID=$jira_id\\\"\\\"\\\" -PassThru -Wait\",\n          \"  if ($rollback_process.ExitCode -ne 0){\",\n          \"    Write-Output \\\"Error: copy process exited with error code \\\", $rollback_process.ExitCode.ToString()\",\n          \"   }\",\n          \"  try{\",\n          \"Write-Output 'Rollback process finished. Will check and upload json file to jira now'\",\n          \"   $rollback_file = $dir + '\\\\' + $hostname + '_rollback_response.json'\",\n          \"     if (Test-Path $rollback_file){\",\n          \"     Write-Output '===File-Upload Start==='\",\n          \"     $wc.UploadFile(\\\"$attach_url\\\", \\\"$rollback_file\\\")\",\n          \"     Write-Output '===File-Upload End==='\",\n          \"     }\",\n          \"     else{\",\n          \"         Write-Output \\\"Rollback json file not found at $rollback_file\\\"\",\n          \"     }\",\n          \"   } catch {\",\n          \"     Write-Output 'Error occured while uploading rollback output'\",\n          \"     Write-Output $_\",\n          \"     exit $rollback_process.ExitCode\",\n          \"   }\",\n          \"    exit $rollback_process.ExitCode\",\n          \"}\",\n          \"else{\",\n          \"Write-Output 'Trigerring the copy process now'\",\n          \"  $copy_process = Start-Process -FilePath cmd -Verb RunAs -ArgumentList '/C', \\\"copy.bat \\\"\\\"EGAIN_HOME=D:\\\\eGain\\\"\\\" \\\"\\\"JIRA_ID=$jira_id\\\"\\\" \\\"\\\"ZIP_LOCATION=\\\\\\\\aworstznas01\\\\cloudshare\\\\tools\\\\7-zip\\\\7z.exe\\\"\\\"\\\" -PassThru -Wait\",\n          \"  if ($copy_process.ExitCode -ne 0){\",\n          \"    Write-Output \\\"Error: copy process exited with error code\\\", $copy_process.ExitCode.ToString()\",\n          \"   }\",\n          \"  try{\",\n          \"Write-Output 'Copy process finished. Will check and upload json file to jira now'\",\n          \"     $response_file = $dir + '\\\\' + $hostname + '_response.json'\",\n          \"     if (Test-Path $response_file){\",\n          \"     Write-Output '===File-Upload Start==='\",\n          \"     $wc.UploadFile(\\\"$attach_url\\\", \\\"$response_file\\\")\",\n          \"     Write-Output '===File-Upload End==='\",\n          \"     }\",\n          \"     else{\",\n          \"         Write-Output \\\"Response json file not found at $response_file \\\"\",\n          \"     }\",\n          \"    } catch {\",\n          \"       Write-Output 'Error occured while uploading response output'\",\n          \"       Write-Output $_\",\n          \"       exit $copy_process.ExitCode\",\n          \"     }\",\n          \"    exit $copy_process.ExitCode\",\n          \"}\",\n          \"exit $LASTEXITCODE\"\n        ]\n      }\n    }\n  ]\n}",
  "CreatedDate": "2021-03-09T18:33:46.831Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Command"
  },
  "DocumentVersion": "1",
  "Name": "arn:aws:ssm:us-west-2:958123553953:document/EG-ExperienceStudio",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "6d3caa72-1caf-4bb2-91ac-1b5f0ee47c6e",
    "Metadata": {},
    "ChecksumAlgorithm": 0,
    "ChecksumValidationStatus": 0
  },
  "ContentLength": 8088,
  "HttpStatusCode": 200,
  "LoggedAt": "2023-05-10T07:12:41.9304236+00:00"
}
