{
  "AttachmentsContent": [],
  "Content": "{\r\n  \"schemaVersion\": \"2.2\",\r\n  \"description\": \"Manage Qualys Cloud Agent on EC2 instances\",\r\n  \"parameters\": {\r\n    \"ActivationID\": {\r\n      \"type\": \"String\",\r\n      \"description\": \"(Required) Enter ActivationID obtained from Qualys CP (do not include {})\"\r\n    },\r\n    \"CustomerID\": {\r\n      \"type\": \"String\",\r\n      \"description\": \"(Required) Enter CustomerID as displayed in your account (do not include {})\"\r\n    },\r\n    \"WebServiceUri\": {\r\n      \"type\": \"String\",\r\n      \"description\": \"(Required for Windows Installation version v4.3 and later) Enter WebServiceUri in format of <platform_url>/CloudAgent/, platform URL can be found at https://www.qualys.com/platform-identification/\"\r\n    },\r\n    \"AgentLocationWindows\": {\r\n      \"type\": \"String\",\r\n      \"default\": \"\",\r\n      \"description\": \"(Optional) Enter FQDN or full path of Windows Qualys Cloud Agent Installer's location\"\r\n    },\r\n    \"AgentLocationDebian\": {\r\n      \"type\": \"String\",\r\n      \"default\": \"\",\r\n      \"description\": \"(Optional) Enter FQDN or full path of Debian Qualys Cloud Agent Installer's location\"\r\n    },\r\n    \"AgentLocationRPM\": {\r\n      \"type\": \"String\",\r\n      \"default\": \"\",\r\n      \"description\": \"(Optional) Enter FQDN or full path of RPM Qualys Cloud Agent Installer's location\"\r\n    },\r\n    \"LogLevel\": {\r\n      \"type\": \"String\",\r\n      \"default\": \"0\",\r\n      \"description\": \"(Optional)  A higher value corresponds to more verbosity. Default is to report only errors (0) \",\r\n      \"allowedValues\": [\r\n        \"0\",\r\n        \"1\",\r\n        \"2\",\r\n        \"3\",\r\n        \"4\",\r\n        \"5\"\r\n      ]\r\n    }\r\n  },\r\n  \"mainSteps\": [\r\n    {\r\n      \"precondition\": {\r\n        \"StringEquals\": [\r\n          \"platformType\",\r\n          \"Linux\"\r\n        ]\r\n      },\r\n      \"action\": \"aws:runShellScript\",\r\n      \"name\": \"InstallQualysCloudAgentOnLinux\",\r\n      \"inputs\": {\r\n        \"id\": \"0.aws:runShellScript\",\r\n        \"timeoutSeconds\": 600,\r\n        \"runCommand\": [\r\n          \"#!/bin/bash\",\r\n          \"#set -eux\",\r\n          \"#Check Whether the Qualys Cloud Agent is already installed\",\r\n          \"status=$( sudo service qualys-cloud-agent status | grep Active )\",\r\n          \"if [[ -z \\\"$status\\\" ]];\",\r\n          \"then\",\r\n          \"     # Check whether curl or wget is present in the system\",\r\n          \"     if hash curl 2>/dev/null\",\r\n          \"     then\",\r\n          \"         DOWNLOAD_CMD=\\\"curl -s --fail --retry 5 --max-time 30\\\"\",\r\n          \"         CONSOLE_ARG=\\\"\\\"\",\r\n          \"         TO_FILE_ARG=\\\" -o \\\"\",\r\n          \"         HEADER_ARG=\\\" --head \\\"\",\r\n          \"     else\",\r\n          \"         DOWNLOAD_CMD=\\\"wget --quiet --tries=5 --timeout=30 \\\"\",\r\n          \"         CONSOLE_ARG=\\\" -qO- \\\"\",\r\n          \"         TO_FILE_ARG=\\\" -O \\\"\",\r\n          \"         HEADER_ARG=\\\" -S --spider \\\"\",\r\n          \"     fi\",\r\n          \"     # Check whether the OS is Debian or RPM based Linux and set the download location\",\r\n          \"     os=$( grep -Ei 'debian|buntu|mint' /etc/*release )\",\r\n          \"     if [[ -n \\\"$os\\\" || -f \\\"/etc/debian_version\\\" ]];\",\r\n          \"     then\",\r\n          \"         INSTALLER_FILE_URL=\\\"{{ AgentLocationDebian }}\\\"\",\r\n          \"         opersys=\\\"DEB\\\"\",\r\n          \"     else\",\r\n          \"         INSTALLER_FILE_URL=\\\"{{ AgentLocationRPM }}\\\"\",\r\n          \"         opersys=\\\"RPM\\\"\",\r\n          \"     fi\",\r\n          \"     Downloadfile()\",\r\n          \"     {\",\r\n          \"         ${DOWNLOAD_CMD} ${TO_FILE_ARG} qualys-cloud-agent.x86_64 ${INSTALLER_FILE_URL}\",\r\n          \"         if [[ $? != 0 ]];\",\r\n          \"         then\",\r\n          \"             echo \\\"Failed to download installer from ${INSTALLER_FILE_URL}\\\"\",\r\n          \"             exit 3\",\r\n          \"         fi\",\r\n          \"     }\",\r\n          \"     # Checks whether agent location is a FQDN or full path and invoke download or copy function \",\r\n          \"     if [[ -n \\\"$INSTALLER_FILE_URL\\\" ]]; \",\r\n          \"     then\",\r\n          \"         if [[ \\\"${INSTALLER_FILE_URL:0:4}\\\" == 'http' ]] ; \",\r\n          \"         then\",\r\n          \"                 Downloadfile\",\r\n          \"         else\",\r\n          \"             cp $INSTALLER_FILE_URL qualys-cloud-agent.x86_64 \",\r\n          \"         fi\",\r\n          \"     else\",\r\n          \"         echo \\\"No installation path specified for Qualys Cloud Agent\\\"\",\r\n          \"             exit 4\",\r\n          \"     fi\",\r\n          \"     if [ \\\"$opersys\\\" = \\\"RPM\\\" ];\",\r\n          \"     then\",\r\n          \"                 sleep 5\",\r\n          \"                 sudo rpm -ivh qualys-cloud-agent.x86_64\",\r\n          \"                 sleep 5\",\r\n          \"                 sudo /usr/local/qualys/cloud-agent/bin/qualys-cloud-agent.sh LogLevel={{ LogLevel }} ActivationId={{ ActivationID }} CustomerId={{ CustomerID }} ServerUri={{ WebServiceUri }}\",\r\n          \"     else\",\r\n          \"         sudo dpkg --install qualys-cloud-agent.x86_64\",\r\n          \"         sleep 5\",\r\n          \"         sudo /usr/local/qualys/cloud-agent/bin/qualys-cloud-agent.sh LogLevel={{ LogLevel }} ActivationId={{ ActivationID }} CustomerId={{ CustomerID }} ServerUri={{ WebServiceUri }}\",\r\n          \"     fi\",\r\n          \"else\",\r\n          \"echo \\\"QualysCloudAgent is already installed on this and running\\\"\",\r\n          \"fi\"\r\n        ]\r\n      }\r\n    },\r\n    {\r\n      \"precondition\": {\r\n        \"StringEquals\": [\r\n          \"platformType\",\r\n          \"Windows\"\r\n        ]\r\n      },\r\n      \"action\": \"aws:runPowerShellScript\",\r\n      \"name\": \"InstallQualysCloudAgentOnWindows\",\r\n      \"inputs\": {\r\n        \"id\": \"0.aws:runPowerShellScript\",\r\n        \"timeoutSeconds\": 600,\r\n        \"runCommand\": [\r\n          \"function New-TemporaryDirectory {\",\r\n          \"  $parent = [System.IO.Path]::GetTempPath()\",\r\n          \"  [string] $name = [System.Guid]::NewGuid()\",\r\n          \"  New-Item -ItemType Directory -Path (Join-Path $parent $name)\",\r\n          \"}\",\r\n          \"$tempdir = New-TemporaryDirectory\",\r\n          \"Set-Location -Path $tempdir\",\r\n          \"$agentInstaller=\\\"QualysCloudAgent.exe\\\"\",\r\n          \"$agentInstallerlog=Join-Path $tempdir $agentInstaller\",\r\n          \"if (Get-Service \\\"QualysAgent\\\" -ErrorAction SilentlyContinue)\",\r\n          \"{\",\r\n          \"  Write-Host \\\"Qualys Cloud Agent is already installed, Exiting\\\"\",\r\n          \"  exit 0\",\r\n          \"}\",\r\n          \"#Download the Qualys Cloud agent\",\r\n          \"Function Download_file\",\r\n          \"{\",\r\n          \"     Try\",\r\n          \"     {\",\r\n          \"         Invoke-WebRequest $installerUrl -OutFile $agentInstallerlog\",\r\n          \"     }\",\r\n          \"     Catch\",\r\n          \"     {\",\r\n          \"         Write-Host \\\"Error while downloading installer\\\"\",\r\n          \"         Write-Host $_.Exception|format-list -force\",\r\n          \"         exit 3\",\r\n          \"     }\",\r\n          \"}\",\r\n          \"#Check whether agent location is a FQDN or full path and invoke download or copy function\",\r\n          \"if ('{{ AgentLocationWindows }}' -ne '')\",\r\n          \"{\",\r\n          \"     $installerUrl = '{{ AgentLocationWindows }}'\",\r\n          \"     if ( $installerUrl.Substring(0,4) -eq 'http')\",\r\n          \"     {\",\r\n          \"         Download_file\",\r\n          \"     }\",\r\n          \"     Else\",\r\n          \"     {\",\r\n          \"         Copy-Item $agentInstallerlog \",\r\n          \"     }\",\r\n          \"}\",\r\n          \"Else \",\r\n          \"{\",\r\n          \"     Write-Host \\\"No installation path specified for Qualys Cloud Agent\\\"\",\r\n          \"     exit 5\",\r\n          \"}\",\r\n          \"# Install the Qualys Cloud Agent\",\r\n          \"$customerID = -join('{', '{{ CustomerID }}', '}')\",\r\n          \"$activationID = -join('{', '{{ ActivationID }}', '}')\",\r\n          \"Try\",\r\n          \"{\",\r\n          \"     & $agentInstallerlog CustomerId=\\\"$customerID\\\" ActivationId=\\\"$activationID\\\" WebServiceUri={{ WebServiceUri }}\",\r\n          \"}\",\r\n          \"Catch\",\r\n          \"{\",\r\n          \"     Write-Host \\\"Installation failed, exception raised during installation\\\"\",\r\n          \"     Write-Host $_.Exception|format-list -force\",\r\n          \"     exit 6\",\r\n          \"}\"\r\n        ]\r\n      }\r\n    }\r\n  ]\r\n}",
  "CreatedDate": "2022-10-18T10:40:21.621Z",
  "DisplayName": null,
  "DocumentFormat": {
    "Value": "JSON"
  },
  "DocumentType": {
    "Value": "Command"
  },
  "DocumentVersion": "1",
  "Name": "arn:aws:ssm:us-west-2:806176696849:document/QualysCloudAgent",
  "Requires": [],
  "ReviewStatus": null,
  "Status": {
    "Value": "Active"
  },
  "StatusInformation": null,
  "VersionName": null,
  "ResponseMetadata": {
    "RequestId": "b7781fbd-ed3f-49a3-95f8-c3f08bc1bf01",
    "Metadata": {},
    "ChecksumAlgorithm": 0,
    "ChecksumValidationStatus": 0
  },
  "ContentLength": 9278,
  "HttpStatusCode": 200,
  "LoggedAt": "2023-05-20T07:12:06.0439909+00:00"
}
